<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/ 
 saved date: Mon Jul 17 2023 13:35:00 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 7: Garbage collection</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .c1{color:var(--palette-dim)}.highlight .nb{color:var(--palette-text)}.highlight .w{color:var(--palette-text)}</style>
<meta property=og:title content="How to Learn Nix, Part 7: Garbage collection">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>
<meta name=description content="I remember from using Nix long ago that when you “uninstall” a package, you don’t really “uninstall” it – you just remove the symlinks to it in your ~/.nix-profile/bin directory, so it no longer appears on your PATH.
Now I know that it doesn’t “remove symlinks” but rather “builds a new user environment and changes the ~/.nix-profile symlink to point to the new generation’s symlink to that user environment.” But you know, effectively the same thing. So there is a separate operation to actually delete those files, and remove the old generations.
Let’s find out more.">
<meta property=og:description content="I remember from using Nix long ago that when you “uninstall” a package, you don’t really “uninstall” it – you just remove the symlinks to it in your ~/.nix-profile/bin directory, so it no longer appears on your PATH.
Now I know that it doesn’t “remove symlinks” but rather “builds a new user environment and changes the ~/.nix-profile symlink to point to the new generation’s symlink to that user environment.” But you know, effectively the same thing. So there is a separate operation to actually delete those files, and remove the old generations.
Let’s find out more.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-03-06>March 6, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>How to Learn Nix, Part&nbsp;7:<br>Garbage collection</a></h1>
</div>
<div class=post-content><p>I remember from using Nix long ago that when you “uninstall” a package, you don’t really “uninstall” it – you just remove the symlinks to it in your <code>~/.nix-profile/bin</code> directory, so it no longer appears on your <code>PATH</code>.</p>
<p>Now I know that it doesn’t “remove symlinks” but rather “builds a new user environment and changes the <code>~/.nix-profile</code> symlink to point to the new generation’s symlink to that user environment.” But you know, effectively the same thing. So there is a separate operation to actually delete those files, and remove the old generations.</p>
<p>Let’s find out more.</p>
<h1 id=chapter-11-garbage-collectionhttpswebarchiveorgweb20210227145624httpsnixosorgmanualnixstablesec-garbage-collection><a href=https://web.archive.org/web/20210227145624/https://nixos.org/manual/nix/stable/#sec-garbage-collection>Chapter 11. Garbage Collection</a></h1>
<p>In the quick start guide I learned that I could use:</p>
<pre><code>$ nix-collect-garbage --delete-old
</code></pre>
<p>And now I know that <code>--delete-old</code> means “hey but before you collect garbage, also delete old generations of my profile.”</p>
<p>Now I’m learning that I can do the <code>--delete-old</code> step myself, if I want, by using <code>nix-env --delete-generations</code>, and I can trigger the garbage collection by using <code>nix-store --gc</code>. This is my first encounter with <code>nix-store</code>, but the separation makes some sense to me: <code>nix-env</code> deals with my environment – stuff in my <code>~/.nix-profile</code> – but the store is bigger than just that. It will eventually have things from <code>nix-shell</code> files, other users, or whatever.</p>
<p>So, alright. I suppose that <code>nix-collect-garbage</code> is its own command because it does both <em>environment things</em> and <em>store things</em> and it would be weird to have a single command that does both. Aside from, you know, <code>nix</code>.</p>
<p>Anyway. This has an example of an interesting command:</p>
<pre><code>$ nix-env --delete-generations 14d
</code></pre>
<p>To delete generations older than two weeks.</p>
<p>Apparently generations know how old they are? Which is strange: previously I was able to convince myself that these were just symlinks. I apparently forgot that when I ran <code>nix-env --list-generations</code>, it showed me a timestamp. Where is that timestamp stored? It’s not in the user-environment: if it were, I wouldn’t have seen the duplicated environments when I looked at my symlinks. This “Nix database” character is starting to look suspicious again.</p>
<p>Oh. Right. Duh.</p>
<p>It’s the creation date of the symlink, isn’t it?</p>
<p>Thanks, filesystems. Still no evidence of any database here.</p>
<p>See? Unedited stream of consciousness. No matter how dumb it makes me look.</p>
<p>Let’s move on from that. Quickly.</p>
<blockquote>
<p>The behaviour of the gargage collector [sic] is affected by the <code>keep-derivations</code> (default: true) and <code>keep-outputs</code> (default: false) options in the Nix configuration file.</p>
</blockquote>
<p>The Nix configuration file?? What’s that?</p>
<p>This is the first I’d heard of this. Where is this file? What <em>else</em> can I configure?</p>
<p>I investigate likely sources – it wouldn’t be in my home directory, since these decisions feel bigger than me. I try to see if it’s in <code>/nix</code>… which leads me only to <code>/nix/var/nix</code>. And here I see a folder called <code>db</code>!</p>
<p>Aha! The Nix database is real! What a rollercoaster this has been.</p>
<p>I go on a tangent. There is a file <code>/nix/var/nix/db/schema</code> – I open it excitedly. But it just turns out to be a version number. Boo. There is also a file called <code>big-lock</code>, which earns my wholehearted approval. That’s a good name.</p>
<p>My curiosity gets the better of me and I briefly forget about the Nix configuration file – I open up the Nix database.</p>
<p>And it’s just a bunch of <code>^@</code> signs! I can’t make sense of any of this. Yuk yuk yuk.</p>
<pre><code>$ sqlite3 /nix/var/nix/db/db.sqlite '.schema'
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>ValidPaths</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>id</span><span class=w>               </span><span class=nb>integer</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=n>autoincrement</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>path</span><span class=w>             </span><span class=nb>text</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>hash</span><span class=w>             </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>registrationTime</span><span class=w> </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>deriver</span><span class=w>          </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>narSize</span><span class=w>          </span><span class=nb>integer</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>ultimate</span><span class=w>         </span><span class=nb>integer</span><span class=p>,</span><span class=w> </span><span class=c1>-- null implies "false"
</span><span class=c1></span><span class=w>    </span><span class=n>sigs</span><span class=w>             </span><span class=nb>text</span><span class=p>,</span><span class=w> </span><span class=c1>-- space-separated
</span><span class=c1></span><span class=w>    </span><span class=n>ca</span><span class=w>               </span><span class=nb>text</span><span class=w> </span><span class=c1>-- if not null, an assertion that the path is content-addressed; see ValidPathInfo
</span><span class=c1></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sqlite_sequence</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=n>seq</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>Refs</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>referrer</span><span class=w>  </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>reference</span><span class=w> </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>reference</span><span class=p>),</span><span class=w>
</span><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>referrer</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>ValidPaths</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>cascade</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>reference</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>ValidPaths</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>restrict</span><span class=w>
</span><span class=w></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>IndexReferrer</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>Refs</span><span class=p>(</span><span class=n>referrer</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>IndexReference</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>Refs</span><span class=p>(</span><span class=n>reference</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TRIGGER</span><span class=w> </span><span class=n>DeleteSelfRefs</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>ValidPaths</span><span class=w>
</span><span class=w>  </span><span class=k>begin</span><span class=w>
</span><span class=w>    </span><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Refs</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>referrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>old</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>reference</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>old</span><span class=p>.</span><span class=n>id</span><span class=p>;</span><span class=w>
</span><span class=w>  </span><span class=k>end</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>DerivationOutputs</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>drv</span><span class=w>  </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>id</span><span class=w>   </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w> </span><span class=c1>-- symbolic output id, usually "out"
</span><span class=c1></span><span class=w>    </span><span class=n>path</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>drv</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>),</span><span class=w>
</span><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>drv</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>ValidPaths</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>cascade</span><span class=w>
</span><span class=w></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>IndexDerivationOutputs</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>DerivationOutputs</span><span class=p>(</span><span class=n>path</span><span class=p>);</span><span class=w>
</span></code></pre></div><p>No idea. Truly no idea. Definitely not ready for this. But it’s nice to see how small it is! And that there seems to be nothing user-specific – all store-wide things. So I didn’t learn… nothing, by doing that. But still: let’s abort; let’s get back on course.</p>
<p>I still haven’t found the configuration file. Maybe I have to create one? Maybe there is no configuration file by default.</p>
<p>I grep for likely strings in <code>man nix-env</code> – wouldn’t it be nice if there were just a <code>man nix</code>? That would tell me things like this? Anyway. I follow a pointer to <code>man 5 nix.conf</code>, which tells me it’s <code>sysconfdir/nix/nix.conf</code>. What’s <code>sysconfdir</code>? It offers an example – <code>/etc/nix/nix.conf</code> – but that’s not there. I google the term <code>sysconfdir</code> because I’ve never heard it before. That leads me to <code>/usr/local/etc</code>. But: no joy.</p>
<p>I feel like there should be a command to just print the path of the current configuration file, but no such command is listed in <code>man 5 nix.conf</code>.</p>
<p>The man page for <code>nix-env</code> tells me that I can use <code>NIX_CONF_DIR</code> to change the location, and that that defaults to <code>prefix/etc/nix</code>, contradicting what <code>man 5 nix.conf</code> said. <code>prefix</code> is not defined, but from reading the descriptions of the other environment variables I conclude that this means <code>/nix</code>.</p>
<p>And I have no <code>/nix/etc</code>, so I have now decided that I have no <code>nix.conf</code> file. I must just be using all defaults.</p>
<p><code>man 5 nix.conf</code> gives an example of a config file that I could use:</p>
<blockquote>
<pre><code>keep-outputs = true       # Nice for developers
keep-derivations = true   # Idem
</code></pre>
</blockquote>
<p>That comment is intriguing. I allow myself to be briefly amused by the idea of someone who is <em>not</em> a professional software developer using Nix, before returning to the manual:</p>
<blockquote>
<p>The defaults will ensure that all derivations that are build-time dependencies of garbage collector roots will be kept and that all output paths that are runtime dependencies will be kept as well. All other derivations or paths will be collected. (This is usually what you want, but while you are developing it may make sense to keep outputs to ensure that rebuild times are quick.)</p>
</blockquote>
<p>Okaaaay. I assume this is the “Nice for developers” comment above. But I don’t really understand what that means. Why does… keeping outputs mean that rebuild times will be quick? What are “outputs”?</p>
<p>I am also sort of surprised that it keeps build time dependencies around – I suspect this is useful mostly because so many packages share them? Or so that <code>--upgrade</code> is faster? If I got a package from a binary cache, do I still get the build-time dependencies?</p>
<p>This seems like a potential waste of space.</p>
<pre><code>$ du -hcd 0 /nix
du: /nix/.Spotlight-V100: Operation not permitted
du: /nix/.Trashes: Operation not permitted
du: /nix/.fseventsd: Permission denied
1.1G    /nix
</code></pre>
<p>And so far the only package I’ve installed is <code>hello</code>!</p>
<p>I mean, I assume most of that is whatever <code>nix-shell</code> installs, which I hope to learn more about. I expect if I collected garbage right now, that would go down considerably, but then I would be annoyed the next time I ran <code>nix-shell</code>.</p>
<p>The chapter closes with an example of <code>nix-collect-garbage -d</code>, which it defines as “a convenient little utility.” And it is!</p>
<p>At the end of this I should make a bestiary of all the <code>nix-*</code> commands. Clearly <code>nix-env</code> is the main powerhouse. <code>nix</code> so far has a search function and nothing else. <code>nix-store</code> sounds like a low-level plumbing command – but there are a bunch more, and I don’t know which are “little utilities” and which are fundamental commands that the others wrap. But! By the time I finish reading this manual, hopefully I will.</p>
<p>Anyway. Next we learn about garbage collector roots, and I am delighted to learn that the way you register new GC roots is by using <code>ln -s</code>. Yep! Make a symlink! You’re an adult! What, you thought there would be a <code>nix add-gc-root</code> command? Please. The manual gives a weird example of how to add a new root:</p>
<pre><code>$ ln -s /nix/store/d718ef...-foo /nix/var/nix/gcroots/bar
</code></pre>
<p>(It’s weird to me that the root is called <code>bar</code> but the store path is <code>foo</code>.)</p>
<p>So that’s… fine. That’s pretty much all there is in this section. There’s nothing about how to make the GC include the stuff that <code>nix-shell</code> needs. Or even… what those things are. Do not know. I still hope to find out, but I’m a little sad that I didn’t find out in this section.</p>
<hr>
<ul>
<li>Where is the Nix configuration file?</li>
<li>What are “outputs” (as in <code>keep-outputs</code>)?</li>
<li>What does <code>keep-derivations</code> do? I’m still not really clear on the term “derivations”.</li>
<li>When I get a binary cached package, do I still download and keep all the build-time dependencies?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Garbage%20collection%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Next up ➜ Channels</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
