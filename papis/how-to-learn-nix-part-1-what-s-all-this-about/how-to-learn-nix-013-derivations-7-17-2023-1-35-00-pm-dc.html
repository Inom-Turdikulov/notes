<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/derivations/ 
 saved date: Mon Jul 17 2023 13:35:00 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 13: Derivations</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight,main div.highlight+pre{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .c1{color:var(--palette-dim)}.highlight .kn{color:var(--palette-teal)}.highlight .kt{color:var(--palette-yellow)}.highlight .m{color:var(--palette-orange)}.highlight .s{color:var(--palette-green)}.highlight .nb{color:var(--palette-text)}.highlight .nf{color:var(--palette-blue)}.highlight .nv{color:var(--palette-red)}.highlight .ow{color:var(--palette-teal)}.highlight .s2{color:var(--palette-green)}.highlight .si{color:var(--palette-orange)}.highlight .sr{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 13: Derivations">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>
<meta name=description content="The section we’ve all been waiting for…">
<meta property=og:description content="The section we’ve all been waiting for…">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-03-11>March 11, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>How to Learn Nix, Part&nbsp;13:<br>Derivations</a></h1>
</div>
<div class=post-content><p>The section we’ve all been waiting for…</p>
<h1 id=154-derivationshttpswebarchiveorgweb20210227145624httpsnixosorgmanualnixstablessec-derivation><a href=https://web.archive.org/web/20210227145624/https://nixos.org/manual/nix/stable/#ssec-derivation>15.4. Derivations</a></h1>
<blockquote>
<p>The most important built-in function is <code>derivation</code>, which is used to describe a single derivation (a build action). It takes as input a set, the attributes of which specify the inputs of the build.</p>
</blockquote>
<p>Okaaaaaay. I have only seen <code>mkDerivation</code>, which I assume is a thin wrapper around <code>derivation</code> that fills in the <code>system</code> argument for me. We see the term “build action” again – I remember that from the glossary. Still don’t understand what that term means.</p>
<p>I wish that this section would just <em>show me a type signature</em> for <code>derivation</code>, but it doesn’t – instead it uses English prose to describe the arguments.</p>
<p>I try to piece it into something more familiar:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=nf>derivation</span> <span class=ow>::</span>
    <span class=p>{</span> <span class=n>system</span>   <span class=kt>:</span> <span class=kt>String</span>
    <span class=p>,</span> <span class=n>name</span>     <span class=kt>:</span> <span class=kt>String</span>
    <span class=p>,</span> <span class=n>builder</span>  <span class=kt>:</span> <span class=kt>Path</span> <span class=o>|</span> <span class=kt>Derivation</span>
    <span class=p>,</span> <span class=o>?</span><span class=n>args</span>    <span class=kt>:</span> <span class=p>[</span><span class=kt>String</span><span class=p>]</span>
    <span class=p>,</span> <span class=o>?</span><span class=n>outputs</span> <span class=kt>:</span> <span class=p>[</span><span class=kt>String</span><span class=p>]</span>
    <span class=p>}</span> <span class=ow>-&gt;</span> <span class=kt>Derivation</span>
</code></pre></div><p>Okay, maybe that’s not any more clear. Lotta strings. I’m using the <code>?</code> prefix to denote optional arguments, and <code>[String]</code> to mean “list of <code>String</code>s,” in case that wasn’t clear.</p>
<p>Note that I am using <code>-&gt;</code> in the “returns” sense and not the “implication” sense of the last post, although it’s fun to think about the equivalence between the two.</p>
<p>Anyway, the manual actually does a really good job describing all of these arguments, so I won’t bother repeating all that here.</p>
<p>Here’s what gave me pause:</p>
<p>The manual calls the <code>system</code> argument a “platform identifier,” and gives examples like <code>"i686-linux"</code> or <code>"x86_64-darwin"</code>. There is a footnote on this that says:</p>
<blockquote>
<p>To figure out your platform identifier, look at the line “Checking for the canonical Nix system name” in the output of Nix’s configure script.</p>
</blockquote>
<p>What? I have to <em>build Nix</em> to find out my platform identifier? That can’t be true.</p>
<blockquote>
<p>The build can only be performed on a machine and operating system matching the platform identifier. (Nix can automatically forward builds for other platforms by forwarding them to other machines; see Chapter 16, Remote Builds.)</p>
</blockquote>
<p>Okay. Very excited to learn about remote builds, as my laptop is, as previously stated, ancient. It would be nice to be able to use it as a thin client to some beefy machine set up in my haunted basement. Maybe throw in some Tailscale, take those builds <em>to go</em>, finally get a setup that can keep up with my metropolitan lifestyle. I am probably not actually going to do any of that, but it’s nice to know that I <em>could</em>.</p>
<p>Interesting that <code>builder</code> can be a derivation. I am into that.</p>
<blockquote>
<p>Every attribute is passed as an environment variable to the builder. Attribute values are translated to environment variables as follows:</p>
<ul>
<li>Strings and numbers are just passed verbatim.</li>
<li>A path (e.g., <code>../foo/sources.tar</code>) causes the referenced file to be copied to the store; its location in the store is put in the environment variable. The idea is that all sources should reside in the Nix store, since all inputs to a derivation should reside in the Nix store.</li>
<li>A <em>derivation</em> causes that derivation to be built prior to the present derivation; its default output path is put in the environment variable.</li>
<li>Lists of the previous types are also allowed. They are simply concatenated, separated by spaces.</li>
<li><code>true</code> is passed as the string <code>1</code>, <code>false</code> and <code>null</code> are passed as an empty string.</li>
</ul>
</blockquote>
<p>Okay! This is neat. We are finally learning something about derivations. To test my knowledge, I want to find the <code>builder.sh</code> file that I have referenced in a path back when I was building <code>my-hello</code>.</p>
<pre><code>$ ls /nix/store | grep builder.sh
4k7n61apbmyw8wxh0914nyixpig7cia7-builder.sh
720ikgx7yaapyb8hvi8lkicjqwzcx3xr-builder.sh
95sl3n27s7rnx6l2kdd5yr83kfrx6574-builder.sh
9krlzvny65gdc8s7kpb6lkx8cd02c25b-default-builder.sh
bzh096qsv3rrvflsx6jd8jh7yqmxnjck-builder.sh
c38g59q6rq924qbry9r4s1lrjxx57lrh-builder.sh
d50riha84mzs9kk64ppcvx0qjhv5v5s3-builder.sh
dsyj1sp3h8q2wwi8m6z548rvn3bmm3vc-builder.sh
hrdhq9yxx8ajjyqr83jri3x7kn5yk78c-builder.sh
l62skckvzzlv3nb7klhcqcrs7ni1pi1w-builder.sh
qf3mzpvsmkrw963xchbivcci06078n13-builder.sh
r5n0lagqhs6hbaqm0sizqq1hw07wp5y7-builder.sh
vh1cpdrgrbipscys6lzr0sfcamr0r2vk-builder.sh
x1l9ji3aynq3ckvsmr7gjq2r5x57ybqc-builder.sh
ygkmp0ydpmg01f7bhx95ck02kzx7sxij-builder.sh
</code></pre>
<p>Ah. Ha. Okay. Right.</p>
<pre><code>$ find /nix/store -maxdepth 1 -name '*builder.sh' -exec grep -q 'Hello, Nix' {} \; -print
/nix/store/r5n0lagqhs6hbaqm0sizqq1hw07wp5y7-builder.sh
/nix/store/ygkmp0ydpmg01f7bhx95ck02kzx7sxij-builder.sh
/nix/store/hrdhq9yxx8ajjyqr83jri3x7kn5yk78c-builder.sh
/nix/store/95sl3n27s7rnx6l2kdd5yr83kfrx6574-builder.sh
/nix/store/d50riha84mzs9kk64ppcvx0qjhv5v5s3-builder.sh
</code></pre>
<p>Okay! Those are all the different versions of the script I used as I was playing around with this the other day – before and after I used <code>$SHELL</code>; evidence of when I got my string escaping wrong and then lied about it… neat. Alright.</p>
<p>I said <code>args</code> was a list of strings up there when I was writing my type signature, but now that I think about it, it’s probably a list of things that <em>become</em> strings. The manual just says “It should be a list.” Wonderfully explicit. I bet if I used a path, that path would be copied to the store. Let’s find out:</p>
<pre><code>$ echo "Hello, Nix!" &gt; message.txt

$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span> <span class=p>}:</span>

<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>pname</span> <span class=o>=</span> <span class=s2>"my-hello"</span><span class=p>;</span>
  <span class=n>version</span> <span class=o>=</span> <span class=s2>"1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./builder.sh</span><span class=p>;</span>
  <span class=n>args</span> <span class=o>=</span> <span class=p>[</span> <span class=sr>./message.txt</span> <span class=p>];</span>
<span class=p>}</span>
</code></pre></div><pre><code>$ cat builder.sh
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=nb>source</span> <span class=nv>$stdenv</span>/setup

mkdir -p <span class=nv>$out</span>/bin

<span class=nv>messagefile</span><span class=o>=</span><span class=nv>$1</span>

cat &gt;<span class=nv>$out</span>/bin/hello <span class=s>&lt;&lt;EOF
</span><span class=s>#!$SHELL
</span><span class=s>cat $messagefile
</span><span class=s>EOF</span>

chmod +x <span class=nv>$out</span>/bin/hello
</code></pre></div><p>And the moment of truth:</p>
<pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv
building '/nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv'...
/nix/store/nmmdalhj24wsz2zi342ymavzqklywk97-message.txt: line 1: Hello,: command not found
builder for '/nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv' failed with exit code 127
error: build of '/nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv' failed
</code></pre><p>Huh. Why didn’t that work? Why did it try to <em>run</em> <code>message.txt</code>? I was right that it copied the file into the store:</p>
<pre><code>$ cat /nix/store/nmmdalhj24wsz2zi342ymavzqklywk97-message.txt
Hello, Nix!
</code></pre>
<p>But I have no idea why it treated it like a script, or what point of the process tried to run that. I re-read my <code>builder.sh</code>, and convince myself I didn’t just do something idiotic. I sure don’t <em>think</em> I did…</p>
<p>Hmm. Very weird.</p>
<p>I try <code>nix-build -A hello -v</code>, but it adds no information that is relevant. I’m not really sure how to debug this – I’m not sure where to look.</p>
<p>Let’s try to see if it fails before or after it starts running <code>builder.sh</code>, to try to figure out if it’s my fault:</p>
<pre tabindex=0><code>$ mv builder.sh backup

$ echo 'exit 1' &gt; builder.sh

$ nix-build -A hello
these derivations will be built:
  /nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv
building '/nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv'...
/nix/store/nmmdalhj24wsz2zi342ymavzqklywk97-message.txt: line 1: Hello,: command not found
builder for '/nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv' failed with exit code 127
error: build of '/nix/store/9jq2pcra3bnb80aqi18jvl9mlg2qk9rw-my-hello-1.0.drv' failed
</code></pre><p>Huh! So no. Not my doing. Something in Nix itself is causing it to try to execute this like a script. What the heck?</p>
<p>I realize that maybe this is a difference between the <code>derivation</code> function and the <code>mkDerivation</code> function, but that seems crazy to me and I dismiss the idea.</p>
<p>Is this something about using <code>args</code>, or is every file treated as executable? I try to just include it as an environment variable:</p>
<pre><code>$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span> <span class=p>}:</span>

<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>pname</span> <span class=o>=</span> <span class=s2>"my-hello"</span><span class=p>;</span>
  <span class=n>version</span> <span class=o>=</span> <span class=s2>"1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./builder.sh</span><span class=p>;</span>
  <span class=n>messagefile</span> <span class=o>=</span> <span class=sr>./message.txt</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/dl4lrbicrw7gqnymxg4lnp5gg7zs75cm-my-hello-1.0.drv
building '/nix/store/dl4lrbicrw7gqnymxg4lnp5gg7zs75cm-my-hello-1.0.drv'...
/nix/store/kjjs6wpb4b8rj8rbvw3zc82hyqzxzf4s-my-hello-1.0

$ cat result/bin/hello
#!/nix/store/5y6lcfjghk5kbv4782vi7w79vz60gsyn-bash-4.4-p23/bin/bash
cat /nix/store/nmmdalhj24wsz2zi342ymavzqklywk97-message.txt
</code></pre><p>(Not shown: I also updated <code>builder.sh</code> in the obvious way.)</p>
<p>So… okay. Weird. Something weird about <code>args</code>. Maybe it is a <code>mkDerivation</code> thing? I hope to find out soon.</p>
<p>The manual describes how I can have multiple outputs – neat. I assume that the “default” value of <code>outputs</code> is <code>["out"]</code> and I can override that – that is, if I specify something else, I will no longer get the <code>$out</code> environment variable. But it’s <em>possible</em> that will still exist, and point to what the manual calls the “default output path.”</p>
<p>To test this, I added <code>outputs = ["foo"];</code> to my <code>hello.nix</code>, and it failed with a super weird error:</p>
<pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/k5r28886afz00l485rsajmzprsp9273r-my-hello-1.0.drv
building '/nix/store/k5r28886afz00l485rsajmzprsp9273r-my-hello-1.0.drv'...
Error: _assignFirst found no valid variant!
builder for '/nix/store/k5r28886afz00l485rsajmzprsp9273r-my-hello-1.0.drv' failed with exit code 1
error: build of '/nix/store/k5r28886afz00l485rsajmzprsp9273r-my-hello-1.0.drv' failed
</code></pre><p>No idea what that means. Nix has variants? I don’t know if that’s an internal error from within the Nix binary or if it’s some Nix function in Nixpkgs failing. I’m guessing at this point that <code>mkDerivation</code> is much more than just a thin wrapper around <code>derivation</code>, and that trying to apply this section to my <code>hello.nix</code> is dumb.</p>
<p>So I try using <code>derivation</code> instead:</p>
<pre><code>$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=nb>derivation</span> <span class=p>{</span>
  <span class=n>system</span> <span class=o>=</span> <span class=s2>"x86_64-darwin"</span><span class=p>;</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-hello-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./builder.sh</span><span class=p>;</span>
  <span class=n>messagefile</span> <span class=o>=</span> <span class=sr>./message.txt</span><span class=p>;</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"foo"</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><pre><code>$ cat default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>hello</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>./hello.nix</span><span class=p>;</span> <span class=p>}</span>
</code></pre></div><p>Wow! Much simpler, because I don’t need <code>stdenv</code> anymore, which means <code>hello.nix</code> doesn’t even need to be a function. Definitely wish I had started here, and worked my way up to the conveniences that <code>mkDerivation</code> provides. Obviously I don’t actually want to hardcode my <code>system</code>, but it’s nice to start here, you know?</p>
<p>It doesn’t quite work, though:</p>
<pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/0rpwly8bj4fww51l25dw5a0g21f2p7b7-my-hello-1.0.drv
building '/nix/store/0rpwly8bj4fww51l25dw5a0g21f2p7b7-my-hello-1.0.drv'...
sandbox-exec: execvp() of '/nix/store/s9fsa5qqvxy0z6zaqchdq5scidpkb01r-builder.sh' failed: Permission denied
builder for '/nix/store/0rpwly8bj4fww51l25dw5a0g21f2p7b7-my-hello-1.0.drv' failed with exit code 71
</code></pre><p>Okay fine:</p>
<pre tabindex=0><code>$ chmod +x ./builder.sh

$ nix-build -A hello
these derivations will be built:
  /nix/store/1ypqmpdpv0pqpbv4xsq342w8cyk2gis6-my-hello-1.0.drv
building '/nix/store/1ypqmpdpv0pqpbv4xsq342w8cyk2gis6-my-hello-1.0.drv'...
/nix/store/wpqa59i0akzibpdcbpgz0xpgc68lmdmc-builder.sh: line 3: mkdir: command not found
/nix/store/wpqa59i0akzibpdcbpgz0xpgc68lmdmc-builder.sh: line 7: /nix/store/g2dwvn98qciaj087nf82xn99qidhv87m-my-hello-1.0-foo/bin/hello: No such file or directory
/nix/store/wpqa59i0akzibpdcbpgz0xpgc68lmdmc-builder.sh: line 12: chmod: command not found
builder for '/nix/store/1ypqmpdpv0pqpbv4xsq342w8cyk2gis6-my-hello-1.0.drv' failed with exit code 127
error: build of '/nix/store/1ypqmpdpv0pqpbv4xsq342w8cyk2gis6-my-hello-1.0.drv' failed
</code></pre><p>And, ah, right. Fair enough. I got rid of <code>source $stdenv/setup</code>, and as a result… I have no <code>PATH</code>. Fair enough! I put <code>stdenv</code> back:</p>
<pre><code>$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span> <span class=p>}:</span>

<span class=nb>derivation</span> <span class=p>{</span>
  <span class=k>inherit</span> <span class=n>stdenv</span><span class=p>;</span>
  <span class=n>system</span> <span class=o>=</span> <span class=s2>"x86_64-darwin"</span><span class=p>;</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-hello-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./builder.sh</span><span class=p>;</span>
  <span class=n>messagefile</span> <span class=o>=</span> <span class=sr>./message.txt</span><span class=p>;</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"foo"</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>And try again:</p>
<pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/zqxm1nw8rixr2wxrs0fisa55vkckrnds-my-hello-1.0.drv
building '/nix/store/zqxm1nw8rixr2wxrs0fisa55vkckrnds-my-hello-1.0.drv'...
/nix/store/kxw6q8v6isaqjm702d71n2421cxamq68-make-symlinks-relative.sh: line 27: syntax error near unexpected token `&lt;'
builder for '/nix/store/zqxm1nw8rixr2wxrs0fisa55vkckrnds-my-hello-1.0.drv' failed to produce output path '/nix/store/4bmh4ifmd4px1jj5bg9ic9dw3r1b2r0a-my-hello-1.0-foo'
</code></pre><p>Ummmm. Well that’s… pretty unexpected. Let’s take a looksee:</p>
<pre tabindex=0><code>$ sed -n '27p' /nix/store/kxw6q8v6isaqjm702d71n2421cxamq68-make-symlinks-relative.sh
    done &lt; &lt;(find $prefix -type l -print0)
</code></pre><p>Ah. Okay. I could see myself being very confused at this point, but I <em>happen to know</em> that subshell expansion does not exist in <code>sh</code>, although it is does exist in <code>bash</code> and <code>zsh</code> and every shell anyone would actually ever actually use. So I assume that by using <code>derivation</code> Nix is defaulting my shell to <code>sh</code> instead of <code>bash</code> – which I honestly think is totally reasonable. But it seems that this script is not “POSIX shell compliant,” which is something that I would never ask a script to be but that I understand some people get very upset about. This would seem fine to me in pretty much any case except this one: if Nix doesn’t work without <code>bash</code>, Nix shouldn’t default to using <code>sh</code>.</p>
<p>If that’s even what’s happening here.</p>
<p>If it is, I would consider this to be the first bug that I’ve found. It might seem sort of annoying and nit-picky to call this a bug, but it’s too late. The words are already out of my mouth.</p>
<p>I wonder how to change this, and glance at the manual – and fortunately <em>the very next thing</em> explains <em>both</em> of the problems I have:</p>
<blockquote>
<p>The function <code>mkDerivation</code> in the Nixpkgs standard environment is a wrapper around derivation that adds a default value for system and always uses Bash as the builder, to which the supplied builder is passed as a command-line argument.</p>
</blockquote>
<p>Ah. Okay. Nix, I am sorry I called it a bug. I feel bad and dumb. Obviously Nix is not doing anything with <code>sh</code>. It’s just invoking my executable, which has no shebang, so macOS is defaulting to using <code>sh</code>. I <code>chmod +x</code>’d without thinking. I briefly think about editing the historical record so that I come off looking a little smarter, but I take the noble road.</p>
<p>And I now realize that <code>make-symlinks-relative</code> is not something that Nix is calling out to in the process of building a derivation. It’s something that <em>my script</em> is calling, when I <code>source $stdenv/setup</code>. This wasn’t clear to me from the error message, but it became clear as soon as I read the above quoted paragraph. Nix isn’t written in shell. It doesn’t need to execute shell scripts in the course of doing a build. That’s on me.</p>
<p>It also explains why my <code>args</code> thing didn’t work when I used it with <code>mkDerivation</code>: my <code>message.txt</code> was being passed as an argument <em>to <code>bash</code></em>, so of course this happened. I think that that’s really <em>confusing</em> behavior: I would expect <code>mkDerivation</code> to do something to adjust <code>args</code> at the same time it’s adjusting <code>builder</code> so that it can be used the way I expected – but whatever. I get what’s going on now.</p>
<p>Well, I can adjust it myself, right?</p>
<pre><code>$ cat default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>rec</span> <span class=p>{</span>
  <span class=n>hello</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>./hello.nix</span> <span class=p>{</span> <span class=k>inherit</span> <span class=n>stdenv</span> <span class=n>bash</span><span class=p>;</span> <span class=p>};</span>
  <span class=n>stdenv</span> <span class=o>=</span> <span class=p>(</span><span class=kn>import</span> <span class=sr>/Users/ian/src/nixpkgs</span> <span class=p>{})</span><span class=o>.</span><span class=n>stdenv</span><span class=p>;</span>
  <span class=n>bash</span> <span class=o>=</span> <span class=p>(</span><span class=kn>import</span> <span class=sr>/Users/ian/src/nixpkgs</span> <span class=p>{})</span><span class=o>.</span><span class=n>bash</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><pre><code>$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span><span class=o>,</span> <span class=n>bash</span> <span class=p>}:</span>

<span class=nb>derivation</span> <span class=p>{</span>
  <span class=k>inherit</span> <span class=n>stdenv</span><span class=p>;</span>
  <span class=n>system</span> <span class=o>=</span> <span class=s2>"x86_64-darwin"</span><span class=p>;</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-hello-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=n>bash</span><span class=p>;</span>
  <span class=n>args</span> <span class=o>=</span> <span class=p>[</span> <span class=sr>./builder.sh</span> <span class=p>];</span>
  <span class=n>messagefile</span> <span class=o>=</span> <span class=sr>./message.txt</span><span class=p>;</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"foo"</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>But this doesn’t work, even though the documentation <em>explicitly said</em> the builder could be a derivation:</p>
<pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/2xan4hspswqjh5lq3bc12ibrls49pxvg-my-hello-1.0.drv
building '/nix/store/2xan4hspswqjh5lq3bc12ibrls49pxvg-my-hello-1.0.drv'...
sandbox-exec: execvp() of '/nix/store/5y6lcfjghk5kbv4782vi7w79vz60gsyn-bash-4.4-p23' failed: Permission denied
builder for '/nix/store/2xan4hspswqjh5lq3bc12ibrls49pxvg-my-hello-1.0.drv' failed with exit code 71
error: build of '/nix/store/2xan4hspswqjh5lq3bc12ibrls49pxvg-my-hello-1.0.drv' failed
</code></pre><p>Because apparently the <code>bash</code> derivation refers to the bash <em>directory</em>, and of course I can’t execute that. I’m not sure how to say that my builder is <code>bash/bin/bash</code>. Unless…</p>
<pre><code>$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span><span class=o>,</span> <span class=n>bash</span> <span class=p>}:</span>

<span class=nb>derivation</span> <span class=p>{</span>
  <span class=k>inherit</span> <span class=n>stdenv</span><span class=p>;</span>
  <span class=n>system</span> <span class=o>=</span> <span class=s2>"x86_64-darwin"</span><span class=p>;</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-hello-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=n>bash</span> <span class=o>+</span> <span class=s2>"/bin/bash"</span><span class=p>;</span>
  <span class=n>args</span> <span class=o>=</span> <span class=p>[</span> <span class=sr>./builder.sh</span> <span class=p>];</span>
  <span class=n>messagefile</span> <span class=o>=</span> <span class=sr>./message.txt</span><span class=p>;</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"foo"</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>Huh. There’s no way that that will work, right? Nix isn’t going to be able to coerce that derivation into a string – and <code>builder</code> is supposed to be a <em>path</em> anyway, not a string. But let’s try it, just in case.</p>
<pre tabindex=0><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/bcmb0jix0ml925bkxqfxp4nh2fp47g16-my-hello-1.0.drv
building '/nix/store/bcmb0jix0ml925bkxqfxp4nh2fp47g16-my-hello-1.0.drv'...
Error: _assignFirst found no valid variant!
builder for '/nix/store/bcmb0jix0ml925bkxqfxp4nh2fp47g16-my-hello-1.0.drv' failed with exit code 1
error: build of '/nix/store/bcmb0jix0ml925bkxqfxp4nh2fp47g16-my-hello-1.0.drv' failed
</code></pre><p>That actually almost makes it seem like it worked? Surprisingly? Maybe paths are not actually a separate <em>type</em> but just a different <em>syntax</em> for writing strings?</p>
<p>Or maybe it didn’t. I dunno. We’re back to the error I got the first time I tried to set <code>outputs</code>. Huh. Let’s look at <code>mkDerivation</code> and try to see how it does this.</p>
<p>Er… yeah. We can do that, right?</p>
<pre tabindex=0><code>$ find ~/src/nixpkgs -name 'mkDerivation.nix'
/Users/ian/src/nixpkgs/pkgs/development/libraries/qt-5/mkDerivation.nix
</code></pre><p>Um, no. I eventually find it at <code>~/src/nixpkgs/pkgs/stdenv/generic/make-derivation.nix</code>, though. Fair enough.</p>
<p><em>Wow</em> this file is 380 lines long. It’s like… it’s like a whole thing.</p>
<p>I see that it doesn’t actually use <code>bash</code>; it uses:</p>
<pre><code>builder = attrs.realBuilder or stdenv.shell;
args = attrs.args or ["-e" (attrs.builder or ./default-builder.sh)];
</code></pre>
<p>Aha. I learn that there is a <code>stdenv.shell</code>. And I learn that it always passes through <code>args</code> literally if it’s set, even if <code>realBuilder</code> is not specified. I think this is <em>super confusing</em>, but okay. At least I understand what went wrong.</p>
<p>I recreate the conditions of <code>mkDerivation</code> as well as I can:</p>
<pre><code>$ cat hello.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span> <span class=p>}:</span>

<span class=nb>derivation</span> <span class=p>{</span>
  <span class=k>inherit</span> <span class=n>stdenv</span><span class=p>;</span>
  <span class=n>system</span> <span class=o>=</span> <span class=s2>"x86_64-darwin"</span><span class=p>;</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-hello-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>shell</span><span class=p>;</span>
  <span class=n>args</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"-e"</span> <span class=sr>./builder.sh</span> <span class=p>];</span>
  <span class=n>messagefile</span> <span class=o>=</span> <span class=sr>./message.txt</span><span class=p>;</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"foo"</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>And, unsurprisingly, get the same <code>_assignFirst</code> error. <code>-v</code> tells me nothing and I have no idea how to like… make Nix show me a call stack (?). I think about googling it, but hold off. Instead I <code>rg</code> around the tree to see if it’s a helper, and I get a hit: <code>~/src/nixpkgs/pkgs/build-support/setup-hooks/multiple-outputs.sh</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># Assign the first string containing nonempty variable to the variable named $1</span>
_assignFirst<span class=o>()</span> <span class=o>{</span>
    <span class=nb>local</span> <span class=nv>varName</span><span class=o>=</span><span class=s2>"</span><span class=nv>$1</span><span class=s2>"</span>
    <span class=nb>local</span> <span class=nv>REMOVE</span><span class=o>=</span>REMOVE <span class=c1># slightly hacky - we allow REMOVE (i.e. not a variable name)</span>
    <span class=nb>shift</span>
    <span class=k>while</span> <span class=o>((</span> <span class=nv>$#</span> <span class=o>))</span><span class=p>;</span> <span class=k>do</span>
        <span class=k>if</span> <span class=o>[</span> -n <span class=s2>"</span><span class=si>${</span><span class=p>!1-</span><span class=si>}</span><span class=s2>"</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=nb>eval</span> <span class=s2>"</span><span class=si>${</span><span class=nv>varName</span><span class=si>}</span><span class=s2>"</span><span class=o>=</span><span class=s2>"</span><span class=nv>$1</span><span class=s2>"</span><span class=p>;</span> <span class=k>return</span><span class=p>;</span> <span class=k>fi</span>
        <span class=nb>shift</span>
    <span class=k>done</span>
    <span class=nb>echo</span> <span class=s2>"Error: _assignFirst found no valid variant!"</span>
    <span class=k>return</span> <span class=m>1</span> <span class=c1># none found</span>
<span class=o>}</span>
</code></pre></div><p>Nice! I assumed that was a Nix function. But it’s just a shell function. That means I know how to debug this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>args</span> <span class=err>=</span> <span class=p>[</span> <span class=s2>"-x"</span> <span class=s2>"-e"</span> <span class=sr>./builder.sh</span> <span class=p>];</span>
</code></pre></div><p>And after looking through stderr, I see:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>_assignFirst outputDev dev out
</code></pre></div><p>Aha. Okay. So <code>outputs</code> <em>did</em> cause Nix not to set <code>$out</code> – but <code>$stdenv/setup</code> needs <code>$out</code> to be set. So… that’s dumb.</p>
<p>Incidentally, I check in <code>man nix-build</code> and see that <code>-vvvv</code> would have given me debug info, if this had been a Nix function.</p>
<p>So okay. Should we… set <code>$out</code>? Add it to our list of <code>outputs</code>? Should we <em>not</em> use <code>$stdenv/setup</code>? Let’s see what other builders do.</p>
<p>Huh!</p>
<pre><code>$ rg 'outputs\s*=\s*\[' ~/src/nixpkgs | head
/Users/ian/src/nixpkgs/pkgs/servers/sql/postgresql/default.nix:    outputs = [ "out" "lib" "doc" "man" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/postgresql/ext/postgis.nix:  outputs = [ "out" "doc" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/cockroachdb/default.nix:  outputs = [ "out" "man" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mysql/5.7.x.nix:  outputs = [ "out" "static" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mariadb/default.nix:  outputs = [ "out" "man" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mariadb/default.nix:  outputs = [ "out" "man" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mariadb/connector-c/default.nix:  outputs = [ "out" "dev" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/virtuoso/6.x.nix:  outputs = [ "out" "dev" "doc" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mysql/8.0.x.nix:  outputs = [ "out" "static" ];
/Users/ian/src/nixpkgs/pkgs/servers/hitch/default.nix:  outputs = [ "out" "doc" "man" ];
/Users/ian/src/nixpkgs/nixos/tests/taskserver.nix:    outputs = [ "out" "cacert" "cert" "key" "crl" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/cockroachdb/default.nix:  outputs = [ "out" "man" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mysql/8.0.x.nix:  outputs = [ "out" "static" ];
/Users/ian/src/nixpkgs/pkgs/servers/sql/mariadb/default.nix:  outputs = [ "out" "man" ];
</code></pre>
<p>Okay. Investigation reveals that there is a <em>single package</em> that does not have an <code>out</code> as one of its <code>outputs</code>:</p>
<pre><code>$ grep outputs ~/src/nixpkgs/pkgs/tools/compression/zstd/default.nix
  outputs = [ "bin" "dev" ]
</code></pre>
<p>And it sets <code>dev</code>, so… yeah. I have no idea what <code>dev</code> should be or what <code>outputDev</code> is gonna be used for. But the example <em>in the manual</em> shows a package that has neither <code>dev</code> nor <code>out</code> – which is, apparently, incompatible with <code>$stdenv/setup</code>. Super cool.</p>
<p>So, okay. That’s something that I learned, that is not called out anywhere. I guess I’ll just add <code>out</code> and see what happens? I <em>assume</em> it will complain that I don’t write anything to <code>out</code>. Yep:</p>
<pre><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/6nz24fd7f00hq0yi2mjabgwzdfyvsj1l-my-hello-1.0.drv
building '/nix/store/6nz24fd7f00hq0yi2mjabgwzdfyvsj1l-my-hello-1.0.drv'...
builder for '/nix/store/6nz24fd7f00hq0yi2mjabgwzdfyvsj1l-my-hello-1.0.drv' failed to produce output path '/nix/store/x0yjnl7rbgzy3f64fnw8vdmighcjkp93-my-hello-1.0'
error: build of '/nix/store/6nz24fd7f00hq0yi2mjabgwzdfyvsj1l-my-hello-1.0.drv' failed
</code></pre>
<p>So, okay. I added <code>echo "whatever" &gt; $out</code> to my builder. And now it works!</p>
<pre><code>$ nix-build -A hello
these derivations will be built:
  /nix/store/kyhgjvkf73h8yf8xqzcds6sikbq6y95q-my-hello-1.0.drv
building '/nix/store/kyhgjvkf73h8yf8xqzcds6sikbq6y95q-my-hello-1.0.drv'...
/nix/store/b36nq1fqc7iw812pvgif9czsammi6pqv-my-hello-1.0-foo
</code></pre>
<p>It prints the “default output path,” the one with the <code>-foo</code> suffix, instead of the unsuffixed path. Which has a different hash:</p>
<pre><code>$ cat /nix/store/pd66andz12y4klq1cwcz7nw75n43q7w8-my-hello-1.0
whatever
</code></pre>
<p>It’s interesting to me that the hash is different – clearly it’s not a hash <em>of the inputs</em> but a hash of like… the inputs <em>and</em> the output name? Or the inputs modulo the output name? I will need to investigate further.</p>
<p>So this is all fine. I learned that <code>$out</code> does <em>not</em> always refer to the default output path, although it… seems like it should.</p>
<p>I continue through the manual. It describes exactly how Nix invokes <code>builder</code>, and what environment variables it provides. <code>NIX_BUILD_TOP</code> is the working directory for the build. All of <code>TMPDIR</code>, <code>TEMPDIR</code>, <code>TMP</code>, and <code>TEMP</code> are also set to that, to reduce the chances of polluting somewhere else. Isn’t Unix beautiful?</p>
<blockquote>
<p><code>PATH</code> is set to <code>/path-not-set</code> to prevent shells from initialising it to their built-in default value.</p>
</blockquote>
<p>I like this, but <code>/PATH-not-set</code> would be a lot more clear in error messages – there are lots of different paths, but only one <code>PATH</code>.</p>
<blockquote>
<p><code>HOME</code> is set to <code>/homeless-shelter</code> to prevent programs from using <code>/etc/passwd</code> or the like to find the user’s home directory, which could cause impurity. Usually, when <code>HOME</code> is set, it is used as the location of the home directory, even if it points to a non-existent path.</p>
</blockquote>
<p>I am not usually one to stifle whimsy but I think if I got an error containing the string <code>/homeless-shelter</code> it would take me a lot longer to figure out what was happening than if I got <code>/HOME-not-set</code>. But this is probably not something I will ever encounter in practice.</p>
<blockquote>
<p>For each output declared in <code>outputs</code>, the corresponding environment variable is set to point to the intended path in the Nix store for that output. Each output path is a concatenation of the cryptographic hash of all build inputs, the <code>name</code> attribute and the output name. (The output name is omitted if it’s <code>out</code>.)</p>
</blockquote>
<p>Got it, thank you. Although I wouldn’t be me if I didn’t say <em>something</em> about the lack of an Oxford comma.</p>
<blockquote>
<p>A log of the combined standard output and error is written to <code>/nix/var/log/nix</code>.</p>
</blockquote>
<p>I look in this directory and find a pretty weird structure.</p>
<pre tabindex=0><code>$ tree /nix/var/log/nix | head
/nix/var/log/nix
└── drvs
    ├── 03
    │&nbsp;&nbsp; └── abqbaf96ngihm2zlai0pvfnw8a6zx8-bootstrap-stage0-coreutils.drv.bz2
    ├── 0g
    │&nbsp;&nbsp; └── 79v3nbrz76m5x2dnwarpvd4xcj778c-bash44-019.drv.bz2
    ├── 0j
    │&nbsp;&nbsp; └── ld2igd44rgs1mdi59h34zbx6i04qrh-my-hello-1.0.drv.bz2
    ├── 0r
    │&nbsp;&nbsp; └── pwly8bj4fww51l25dw5a0g21f2p7b7-my-hello-1.0.drv.bz2
</code></pre><p>I assume this is like the thing <code>git</code> does in <code>.git/objects</code> so that you don’t have a single directory with millions of inodes.</p>
<p>I tree to look at the logs from the build I just did, but…</p>
<pre><code>$ find /nix/var/log/nix -name '*7iw812pvgif9czsamm*'
</code></pre>
<p>I cannot find them. I give up quickly, and move on.</p>
<blockquote>
<p>If the build was successful, Nix scans each output path for references to input paths by looking for the hash parts of the input paths. Since these are potential runtime dependencies, Nix registers them as dependencies of the output paths.</p>
</blockquote>
<p>Neat. I actually really like this? Like, you could try to “defeat” this if you wanted to, and write software that is deliberately incompatible with Nix. But I assume if you were packaging that package, Nix would give you some other way to explicitly register runtime dependencies? Gotta be.</p>
<blockquote>
<p>Note that possible <code>setuid</code> and <code>setgid</code> bits are cleared. Setuid and setgid programs are not currently supported by Nix. This is because the Nix archives used in deployment have no concept of ownership information, and because it makes the build result dependent on the user performing the build.</p>
</blockquote>
<p>My last job involved a fair amount of weird low-level userspace networking <em>stuff</em>, and we mostly used capabilities, but I’m pretty sure we had to distribute some helpers as <code>setuid</code> executables for reasons I can’t remember. It’s been a while. Anyway, the manual says nothing about capabilities or extended attributes in here.</p>
<h1 id=1541-advanced-attributeshttpswebarchiveorgweb20210227145624httpsnixosorgmanualnixstablesec-advanced-attributes><a href=https://web.archive.org/web/20210227145624/https://nixos.org/manual/nix/stable/#sec-advanced-attributes>15.4.1. Advanced Attributes</a></h1>
<p>In which I learn that my type signature at the beginning of this post was woefully incomplete.</p>
<p>There’s some neat stuff here. You can whitelist runtime dependencies with <code>allowedReferences</code> to prevent dependency creep. Love that. <code>allowedRequisites</code> for a whitelist on the entire dependency closure. <code>disallowedReferences</code> and <code>disallowedRequisites</code> – the thing you expect.</p>
<blockquote>
<p><code>exportReferencesGraph</code> is useful for builders that want to do something with the closure of a store path. Examples include the builders in NixOS that generate the initial ramdisk for booting Linux (a cpio archive containing the closure of the boot script) and the ISO-9660 image for the installation CD (which is populated with a Nix store containing the closure of a bootable NixOS configuration).</p>
</blockquote>
<p>I doubt I will ever need that, and don’t bother to play around with it. But it sounds neat.</p>
<p><code>impureEnvVars</code> is interesting – apparently <code>fetchurl</code> uses this to keep HTTP proxy stuff when you’re building. That’s nice.</p>
<blockquote>
<p>This attribute is only allowed in fixed-output derivations, where impurities such as these are okay since (the hash of) the output is known in advance. It is ignored for all other derivations.</p>
</blockquote>
<p>Very cool. How do I make my own “fixed-output derivation”?</p>
<p>Ah, it’s the very next thing listed: <code>outputHash</code>, <code>outputHashAlgo</code>, and <code>outputHashMode</code>.</p>
<blockquote>
<p>For fixed-output derivations, on the other hand, the name of the output path only depends on the <code>outputHash*</code> and <code>name</code> attributes, while all other attributes are ignored for the purpose of computing the output path. (The <code>name</code> attribute is included because it is part of the path.)</p>
</blockquote>
<p>So presumably a fixed-output derivation cannot specify multiple outputs. But that’s okay: I assume this is mostly useful for things like <code>fetchurl</code> that are not “actual” packages.</p>
<p><code>passAsFile</code> is interesting – in case an attribute value is particularly long, or contains special characters or something, you can receive it as a path instead of a literal value. What happens if I <code>passAsFile = [ "passAsFile" ]</code>? Nothing. That’s not weird. That is not a strange loop.</p>
<p><code>preferLocalBuild</code> is for “trivial builders where the cost of doing a download or remote build would exceed the cost of building locally”. It doesn’t seem to disable the binary cache, but something called “distributed building,” which I have not gotten to yet.</p>
<p>However I could use <code>allowSubstitutes</code> to disable the binary cache. “This is useful for very trivial derivations (such as <code>writeText</code> in Nixpkgs) that are cheaper to build than to substitute from a binary cache.”</p>
<p>Alright.</p>
<p>I <em>still don’t know what a derivation is</em>. I mean, I get it – I get how it works, what it does, how to make them. But I don’t know what it is in the Nix language: is it a separate type? Is it a “set” with some magic <code>__i_am_derivation</code> attribute? What <em>is</em> it?</p>
<p>I don’t know. Hopefully I will soon.</p>
<hr>
<ul>
<li>How do I find my platform identifier without building Nix from scratch?</li>
<li>If <code>builder</code> is a derivation that produces multiple files, what binary does it run?</li>
<li>Are paths actually a different type at runtime, or are they really strings?</li>
<li>Why does <code>mkDerivation</code> pass through <code>args</code> literally?</li>
<li>Why does <code>$stdenv/setup</code> require one of <code>$dev</code> or <code>$out</code> to exist?</li>
<li>How do I actually find the logs I want in <code>/nix/var/log/nix</code>?</li>
<li>How can I explicitly register a runtime dependency?</li>
<li>How do extended file system attributes work in Nix?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Derivations%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Next up ➜ Built-in Functions</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
