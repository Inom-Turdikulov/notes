<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/ 
 saved date: Mon Jul 17 2023 13:35:08 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 20: My first Nix bug</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}sup{font-size:75%}sup a::before{content:"["}sup a::after{content:"]"}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}.footnotes>ol{margin-top:1em}.footnotes li:not(.highlight){transition:background-color 1s}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}a.footnote-ref:visited,a.footnote-backref:visited,.notation-help-link-container a:visited{color:var(--link)}main *+p,main *+pre,main *+aside,main *+section,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr{margin-top:1em}main pre+div.highlight{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .cp{color:var(--palette-dim)}.highlight .c1{color:var(--palette-dim)}.highlight .gd{color:var(--palette-red)}.highlight .gi{color:var(--palette-green)}.highlight .gu{color:var(--palette-teal);font-weight:700}.highlight .kc{color:var(--palette-purple)}.highlight .kn{color:var(--palette-teal)}.highlight .m{color:var(--palette-orange)}.highlight .nb{color:var(--palette-text)}.highlight .nt{color:var(--palette-teal)}.highlight .mi{color:var(--palette-orange)}.highlight .sd{color:var(--palette-dim)}.highlight .s2{color:var(--palette-green)}.highlight .sr{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 20: My first Nix bug">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>
<meta name=description content="In my last post, I tried to install Mercurial, and it didn’t go well.
Solemn music plays over this black and white flashback:">
<meta property=og:description content="In my last post, I tried to install Mercurial, and it didn’t go well.
Solemn music plays over this black and white flashback:">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-03-18>March 18, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>How to Learn Nix, Part&nbsp;20:<br>My first Nix bug</a></h1>
</div>
<div class=post-content><p>In <a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>my last post</a>, I tried to install Mercurial, and it didn’t go well.</p>
<p>Solemn music plays over this black and white flashback:</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.mercurial
installing 'mercurial-5.6'
these paths will be fetched (3.45 MiB download, 14.95 MiB unpacked):
  /nix/store/7x5s4k57cw0a8nldypmm1y5f763k01kl-mercurial-5.6
copying path '/nix/store/7x5s4k57cw0a8nldypmm1y5f763k01kl-mercurial-5.6' from 'https://cache.nixos.org'...
Assertion failed: (size_ &lt; capacity_), function push_back, file src/libexpr/attr-set.hh, line 54.
[1]    1968 abort      nix-env -iA nixpkgs.mercurial
</code></pre><p>So what if I… fixed it? What better way to learn “how Nix works” than to actually dive into the implementation? I figure I’ve got to learn <em>something</em> by doing this, even I never get further than “how to read the definition of the <code>mercurial</code> derivation.”</p>
<p>First up: let’s see if it’s already fixed in the latest Nix <code>master</code>. To do that, I’ll need to figure out how to build Nix from source. Wouldn’t it be funny if I just couldn’t? Like if the Nix install instructions were just <code>configure; make; pray</code>?<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
<p>Let’s see. I already cloned <a href=https://github.com/NixOS/nix>the Nix repo</a> a few days ago. I fetch and fast-forward it.</p>
<p>It has a <code>README.md</code>, but it just links to the <a href=https://hydra.nixos.org/build/138351509/download/1/manual/contributing/hacking.html>Nix “hacking guide."</a> Sounds promising.</p>
<blockquote>
<p>To build Nix for the current operating system/architecture use</p>
<pre><code>$ nix-build
</code></pre>
<p>or if you have a flake-enabled nix:</p>
<pre><code>$ nix build
</code></pre>
</blockquote>
<p>I have no idea what a “flake-enabled nix” is, and it is not explained. I guess… let’s find out?</p>
<pre><code>$ nix build
[19.2 MiB DL]
</code></pre>
<p>It seems to be stuck downloading things? Or now it’s building? No idea. For a few seconds that little prompt was animating. Now it’s just stuck. Oh, there it goes:</p>
<pre tabindex=0><code>$ nix build
[0/24 built, 1/75/214 copied (128.9/1148.7 MiB), 40.9/205.2 MiB DL] fetching pcre-8.44 from https://cache.nixos.org
</code></pre><p>I wait a second. And then:</p>
<pre tabindex=0><code>$ nix build
builder for '/nix/store/fcl2xslcvp9vinc910zfvirjgmdbcffb-nix-2.4pre19700101_52b6e0f.drv' failed with exit code 77; last 10 log lines:
  configure flags: --prefix=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f --bindir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/bin --sbindir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/sbin --includedir=/nix/store/byflz5mq5iafhxw26ak98wghvycn5zr7-nix-2.4pre19700101_52b6e0f-dev/include --oldincludedir=/nix/store/byflz5mq5iafhxw26ak98wghvycn5zr7-nix-2.4pre19700101_52b6e0f-dev/include --mandir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/share/man --infodir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/share/info --docdir=/nix/store/kcd4rkg6y1fi9xrdfirpk1nxqk91gi69-nix-2.4pre19700101_52b6e0f-doc/share/doc/nix --libdir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/lib --libexecdir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/libexec --localedir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/share/locale --sysconfdir=/etc
  checking for a sed that does not truncate output... /nix/store/mcz107ij67iidr86mm74sh98q193y7mq-gnused-4.8/bin/sed
  checking build system type... x86_64-apple-darwin20.3.0
  checking host system type... x86_64-apple-darwin20.3.0
  checking for the canonical Nix system name... x86_64-darwin
  checking for gcc... clang
  checking whether the C compiler works... no
  configure: error: in `/private/tmp/nix-build-nix-2.4pre19700101_52b6e0f.drv-0/source':
  configure: error: C compiler cannot create executables
  See `config.log' for more details
[0 built (1 failed), 214 copied (1148.6 MiB), 224.5 MiB DL]
error: build of '/nix/store/fcl2xslcvp9vinc910zfvirjgmdbcffb-nix-2.4pre19700101_52b6e0f.drv' failed
</code></pre><p><em>Hmmmmm</em>. “C compiler cannot create executables.” That sounds… bad. Nix, didn’t you BYO C compiler? Why would you pick one that doesn’t work? The whole point of Nix is to make reproducible builds, isn’t it?</p>
<p>This is not a good start. This feels rather embarrassing for Nix.</p>
<p>It points me at <code>config.log</code>, but of course there is no such file. I suspect that it means <code>/private/tmp/nix-build-nix-2.4pre19700101_52b6e0f.drv-0/source/config.log</code>, but of course that whole directory has been deleted.</p>
<p>I sigh loudly.</p>
<pre tabindex=0><code>$ nix build --help
Usage: nix build &lt;FLAGS&gt;... &lt;INSTALLABLES&gt;...

Summary: build a derivation or fetch a store path.

Flags:
      --arg &lt;NAME&gt; &lt;EXPR&gt;       argument to be passed to Nix functions
      --argstr &lt;NAME&gt; &lt;STRING&gt;  string-valued argument to be passed to Nix functions
      --dry-run                 show what this command would do without doing it
  -f, --file &lt;FILE&gt;             evaluate FILE rather than the default
  -I, --include &lt;PATH&gt;          add a path to the list of locations used to look up &lt;...&gt; file names
      --no-link                 do not create a symlink to the build result
  -o, --out-link &lt;PATH&gt;         path of the symlink to the build result

Examples:

  To build and run GNU Hello from NixOS 17.03:
  $ nix build -f channel:nixos-17.03 hello; ./result/bin/hello

  To build the build.x86_64-linux attribute from release.nix:
  $ nix build -f release.nix build.x86_64-linux

Note: this program is EXPERIMENTAL and subject to change.
</code></pre><p>There’s nothing here about “keep the build directory around on failure please.”</p>
<p>So maybe I don’t have a “flake-enabled nix?” Maybe that’s why it failed? I would certainly expect a very different looking failure if that were the case. But sure. Let’s try <code>nix-build</code>, because at least it has a <code>--keep-failed</code>:</p>
<pre tabindex=0><code>$ nix-build --keep-failed
these derivations will be built:
  /nix/store/fcl2xslcvp9vinc910zfvirjgmdbcffb-nix-2.4pre19700101_52b6e0f.drv
building '/nix/store/fcl2xslcvp9vinc910zfvirjgmdbcffb-nix-2.4pre19700101_52b6e0f.drv'...
unpacking sources
unpacking source archive /nix/store/ifh6yng48bq3rd8hkib71gvv1prnd313-source
source root is source
patching sources
autoreconfPhase
autoreconf: Entering directory `.'
autoreconf: configure.ac: not using Gettext
autoreconf: running: aclocal --force
autoreconf: configure.ac: tracing
autoreconf: configure.ac: not using Libtool
autoreconf: running: /nix/store/x9zbnxr523rnhgrmwq1qsnx56sh9mmhj-autoconf-2.69/bin/autoconf --force
autoreconf: running: /nix/store/x9zbnxr523rnhgrmwq1qsnx56sh9mmhj-autoconf-2.69/bin/autoheader --force
autoreconf: configure.ac: not using Automake
autoreconf: Leaving directory `.'
configuring
configure flags: --prefix=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f --bindir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/bin --sbindir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/sbin --includedir=/nix/store/byflz5mq5iafhxw26ak98wghvycn5zr7-nix-2.4pre19700101_52b6e0f-dev/include --oldincludedir=/nix/store/byflz5mq5iafhxw26ak98wghvycn5zr7-nix-2.4pre19700101_52b6e0f-dev/include --mandir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/share/man --infodir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/share/info --docdir=/nix/store/kcd4rkg6y1fi9xrdfirpk1nxqk91gi69-nix-2.4pre19700101_52b6e0f-doc/share/doc/nix --libdir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/lib --libexecdir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/libexec --localedir=/nix/store/kkr83n49yici75b3h01aqmmr6wklph0d-nix-2.4pre19700101_52b6e0f/share/locale --sysconfdir=/etc
checking for a sed that does not truncate output... /nix/store/mcz107ij67iidr86mm74sh98q193y7mq-gnused-4.8/bin/sed
checking build system type... x86_64-apple-darwin20.3.0
checking host system type... x86_64-apple-darwin20.3.0
checking for the canonical Nix system name... x86_64-darwin
checking for gcc... clang
checking whether the C compiler works... no
configure: error: in `/private/tmp/nix-build-nix-2.4pre19700101_52b6e0f.drv-0/source':
configure: error: C compiler cannot create executables
See `config.log' for more details
note: keeping build directory '/private/tmp/nix-build-nix-2.4pre19700101_52b6e0f.drv-0'
builder for '/nix/store/fcl2xslcvp9vinc910zfvirjgmdbcffb-nix-2.4pre19700101_52b6e0f.drv' failed with exit code 77
error: build of '/nix/store/fcl2xslcvp9vinc910zfvirjgmdbcffb-nix-2.4pre19700101_52b6e0f.drv' failed
</code></pre><p>Alllright. Well, at least I have the <code>config.log</code> now. But there’s not a whole lot more information in it.</p>
<pre tabindex=0><code>configure:3066: checking whether the C compiler works
configure:3088: clang    conftest.c  &gt;&amp;5
ld: file not found: /usr/lib/system/libcache.dylib for architecture x86_64
clang-7: error: linker command failed with exit code 1 (use -v to see invocation)
configure:3092: $? = 1
configure:3130: result: no
configure: failed program was:
| /* confdefs.h */
| #define PACKAGE_NAME "nix"
| #define PACKAGE_TARNAME "nix"
| #define PACKAGE_VERSION "2.4pre19700101_52b6e0f"
| #define PACKAGE_STRING "nix 2.4pre19700101_52b6e0f"
| #define PACKAGE_BUGREPORT ""
| #define PACKAGE_URL ""
| #define SYSTEM "x86_64-darwin"
| /* end confdefs.h.  */
|
| int
| main ()
| {
|
|   ;
|   return 0;
| }
configure:3135: error: in `/private/tmp/nix-build-nix-2.4pre19700101_52b6e0f.drv-0/source':
configure:3137: error: C compiler cannot create executables
See `config.log' for more details
</code></pre><p>So it looks like it’s building a trivial little executable with <code>clang</code>, which fails with an error from <code>ld</code>.</p>
<p>Sigh. Let’s see what we can make of this.</p>
<pre tabindex=0><code>$ echo 'int main () { return 0; }' &gt;test.c

$ clang test.c

$ ./a.out

$ echo $?
0
</code></pre><p><em>Sure seems fine to me</em>.</p>
<p>But obviously that’s my system <code>clang</code> – not <code>clang-7</code> or whatever the Nix version of <code>clang</code> is. Let’s see if I can make that work:</p>
<pre tabindex=0><code>$ nix-shell -p clang
(downloading a million packages)

[nix-shell:~/scratch]$ clang test.c

[nix-shell:~/scratch]$ ./a.out

[nix-shell:~/scratch]$ echo $?
0
</code></pre><p>Hrmmmm. Ooooookay. So I have no idea what Nix is doing wrong here.</p>
<p>Let’s see: I remember that <code>nix-build</code> tries to build whatever the <code>default.nix</code> file is when you run it without arguments. Let’s see what that is?</p>
<pre><code>$ cat default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>(</span><span class=kn>import</span> <span class=p>(</span><span class=nb>fetchTarball</span> <span class=sd>https://github.com/edolstra/flake-compat/archive/master.tar.gz</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>src</span> <span class=o>=</span> <span class=sr>./.</span><span class=p>;</span>
<span class=p>})</span><span class=o>.</span><span class=n>defaultNix</span>
</code></pre></div><p>Hmmmmm. Very weird. We’re <em>downloading</em> something called <code>flake-compat</code> from GitHub?</p>
<p>I pull up that repo and see that it’s just a single file, <code>default.nix</code>:</p>
<pre><code>curl -s https://raw.githubusercontent.com/edolstra/flake-compat/master/default.nix | head
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=c1># Compatibility function to allow flakes to be used by</span>
<span class=c1># non-flake-enabled Nix versions. Given a source tree containing a</span>
<span class=c1># 'flake.nix' and 'flake.lock' file, it fetches the flake inputs and</span>
<span class=c1># calls the flake's 'outputs' function. It then returns an attrset</span>
<span class=c1># containing 'defaultNix' (to be used in 'default.nix'), 'shellNix'</span>
<span class=c1># (to be used in 'shell.nix').</span>

<span class=p>{</span> <span class=n>src</span><span class=o>,</span> <span class=n>system</span> <span class=o>?</span> <span class=nb>builtins</span><span class=o>.</span><span class=n>currentSystem</span> <span class=n>or</span> <span class=s2>"unknown-system"</span> <span class=p>}:</span>

<span class=k>let</span>
</code></pre></div><p>So maybe I need to know what “flakes” are. I cannot find any reference to them in the man pages. I ⌘F through the Nixpkgs manual to see if this is explained there and I just haven’t gotten to it yet. Nothin'.</p>
<p>I finally give in and google “nix flakes.”</p>
<p>The first result is the <a href=https://nixos.wiki/wiki/Flakes>NixOS wiki entry on flakes</a>. It’s very interesting.</p>
<blockquote>
<p>Nix Flakes are an upcoming feature of the Nix package manager.</p>
</blockquote>
<p>Okay. I have no idea when this was written, or if it is still upcoming, or how often the NixOS Wiki is updated.</p>
<blockquote>
<p>Flakes allow you to specify your code’s dependencies (e.g. remote Git repositories) in a declarative way, simply by listing them inside a flake.nix file:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>home-manager</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>"github:nix-community/home-manager"</span><span class=p>;</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>Each dependency gets then pinned, that is: its commit hash gets automatically stored into a file - named <code>flake.lock</code> - making it easy to, say, upgrade it:</p>
<pre><code>$ nix flake update --update-input home-manager
</code></pre>
<p><em>(if you’re familiar with modern packages managers like <code>cargo</code> or <code>npm</code>, then the overall mechanism shouldn’t surprise you - Nix works in a similar way, although without a centralized repository.)</em></p>
<p>Flakes replace the nix-channels command and things like ad-hoc invocations of <code>builtins.fetchgit</code> - no more worrying about keeping your channels in sync, no more worrying about forgetting about a dependency deep down in your tree: everything’s at hand right inside <code>flake.lock</code>.</p>
</blockquote>
<p>Neat! Okay. I think this answers the question I had about “how do I tell if I have a flake-enabled Nix:” I would presumably have a <code>nix flake</code> subcommand. And I do not. So.</p>
<p>I don’t understand how this replaces the “nix-channels command.” I assume that means the <code>nix-channel</code> executable? And I assume they only mean for some small use case? I don’t know. I don’t see how this would prevent me from needing to <code>nix-channel --update</code> to prime myself for those sweet, sweet upgrades. But I resolve not to worry about it for now.</p>
<p>Wouldn’t it be funny if you needed to use some a cutting edge Nix feature in order to build the latest Nix? I don’t think that’s what’s going on: the nature of the failure makes me think this has nothing to do with whether or not I have flakes.</p>
<p>I just wish I had some idea what it <em>does</em> have to do with.</p>
<p>Man, at the beginning of this I thought it would be really funny if I had trouble building Nix with Nix. And now… it seems less funny. It seems more tragic.</p>
<p>I had initially assumed that this was some sort of macOS codesigning or <a href=https://en.wikipedia.org/wiki/System_Integrity_Protection>SIP</a> nonsense thing. But the nature of the failure makes me think not.</p>
<p>Maybe I should read the rest of the “hacking guide,” and it will explain this.</p>
<p>On a whim I try:</p>
<pre><code>$ nix-build -A defaultPackage.x86_64-darwin
</code></pre>
<p>Just in case it’s inferring the wrong platform? Nope. Didn’t work. Same error. Kind of a shot in the dark anyway.</p>
<p>Well, the last thing the hacking guide offers is <code>nix-shell</code>. Let’s give it a shot.</p>
<pre tabindex=0><code>$ nix-shell
(installing things)

[nix-shell:~/src/nix]$ ./bootstrap.sh
autoreconf: Entering directory `.'
autoreconf: configure.ac: not using Gettext
autoreconf: running: aclocal --force
autoreconf: configure.ac: tracing
autoreconf: configure.ac: not using Libtool
autoreconf: running: /nix/store/x9zbnxr523rnhgrmwq1qsnx56sh9mmhj-autoconf-2.69/bin/autoconf --force
autoreconf: running: /nix/store/x9zbnxr523rnhgrmwq1qsnx56sh9mmhj-autoconf-2.69/bin/autoheader --force
autoreconf: configure.ac: not using Automake
autoreconf: Leaving directory `.'

[nix-shell:~/src/nix]$ ./configure $configureFlags --prefix=$(pwd)/outputs/out
checking for a sed that does not truncate output... /nix/store/mcz107ij67iidr86mm74sh98q193y7mq-gnused-4.8/bin/sed
checking build system type... x86_64-apple-darwin20.3.0
checking host system type... x86_64-apple-darwin20.3.0
checking for the canonical Nix system name... x86_64-darwin
checking for gcc... clang
checking whether the C compiler works... no
configure: error: in `/Users/ian/src/nix':
configure: error: C compiler cannot create executables
See `config.log' for more details
</code></pre><p>I mean, it would have been a lot more upsetting to me if that <em>had</em> worked. At least it’s consistent.</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ which clang
/nix/store/3mrwg8hplg82w3c4q2c2whkjq4wfly25-clang-wrapper-7.1.0/bin/clang
</code></pre><p>Alright. And just to make sure that it’s not the <code>configure</code> script…</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ clang ~/scratch/test.c
ld: file not found: /usr/lib/system/libcache.dylib for architecture x86_64
clang-7: error: linker command failed with exit code 1 (use -v to see invocation)
</code></pre><p>So whatever this <code>clang-wrapper</code> nonsense is… doesn’t actually work. We know <code>clang</code> works! So what is that package? And why is it looking in <code>/usr/lib/system</code>, instead of some path in <code>/nix/store</code>? Isn’t the whole point of Nix to fix this problem?</p>
<p>I am at this point rather frustrated, but simultaneously a little bemused. I’m trying to fix a bug in a tool that’s supposed to give me reproducible builds by isolating the build environment. And I can’t build the tool itself because its build environment is apparently not isolated. It’s funny, no?</p>
<p>It’s a little bit funny. And a little bit frustrating.</p>
<p>So let’s see if we can’t figure this out.</p>
<pre tabindex=0><code>$ nix-env -qa clang-wrapper --description
clang-wrapper-10.0.1  A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-11.0.1  A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-5.0.2   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-6.0.1   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-7.1.0   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-8.0.1   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
clang-wrapper-9.0.1   A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)
</code></pre><p>Come on.</p>
<p>Alright, well, things are not… good right now. I <em>really</em> didn’t expect that it would take me this long just to build Nix, and it is now very late. I will have to return to this tomorrow, and see if I can get it working then.</p>
<p>Tomorrow and tomorrow and tomorrow:</p>
<pre tabindex=0><code>$ nix-shell -p clang-wrapper
error: undefined variable 'clang-wrapper' at (string):1:94
(use '--show-trace' to show detailed location information)

$ nix-shell -p clang-wrapper-7.1.0
error: undefined variable 'clang-wrapper-7' at (string):1:94
(use '--show-trace' to show detailed location information)
</code></pre><p>Wha? Why doesn’t this package work with <code>nix-shell</code>?</p>
<pre tabindex=0><code>$ nix-env -qa clang-wrapper-7.1.0 --json
</code></pre><p>30 seconds later…</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"nixpkgs.cc"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"clang-wrapper"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"7.1.0"</span><span class=p>,</span>
    <span class=nt>"system"</span><span class=p>:</span> <span class=s2>"x86_64-darwin"</span><span class=p>,</span>
    <span class=nt>"meta"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"available"</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>"broken"</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=err>/*</span> <span class=err>ARE</span> <span class=err>YOU</span> <span class=err>SURE</span> <span class=err>*/</span>
      <span class=nt>"description"</span><span class=p>:</span> <span class=s2>"A c, c++, objective-c, and objective-c++ frontend for the llvm compiler (wrapper script)"</span><span class=p>,</span>
      <span class=nt>"homepage"</span><span class=p>:</span> <span class=s2>"https://llvm.org/"</span><span class=p>,</span>
      <span class=nt>"insecure"</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
      <span class=nt>"license"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"fullName"</span><span class=p>:</span> <span class=s2>"University of Illinois/NCSA Open Source License"</span><span class=p>,</span>
        <span class=nt>"shortName"</span><span class=p>:</span> <span class=s2>"ncsa"</span><span class=p>,</span>
        <span class=nt>"spdxId"</span><span class=p>:</span> <span class=s2>"NCSA"</span><span class=p>,</span>
        <span class=nt>"url"</span><span class=p>:</span> <span class=s2>"https://spdx.org/licenses/NCSA.html"</span>
      <span class=p>},</span>
      <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-7.1.0"</span><span class=p>,</span>
      <span class=nt>"outputsToInstall"</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>"out"</span>
      <span class=p>],</span>
      <span class=nt>"platforms"</span><span class=p>:</span> <span class=p>[</span> <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span> <span class=p>],</span>
      <span class=nt>"position"</span><span class=p>:</span> <span class=s2>"/nix/store/v43dzqk60bmd4rpksq5ix9gibcj18as9-nixpkgs-21.05pre273941.a2b0ea6865b/nixpkgs/pkgs/build-support/cc-wrapper/default.nix:497"</span><span class=p>,</span>
      <span class=nt>"priority"</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
      <span class=nt>"unfree"</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
      <span class=nt>"unsupported"</span><span class=p>:</span> <span class=kc>false</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>"nixpkgs.clang_7"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span>
    <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span>
  <span class=p>},</span>
  <span class=nt>"nixpkgs.llvmPackages.libstdcxxClang"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span>
    <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span>
  <span class=p>},</span>
  <span class=nt>"nixpkgs.llvmPackages.lldClang"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span>
    <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span>
    <span class=p>}</span>
  <span class=p>}</span><span class=err>,</span>
  <span class=s2>"nixpkgs.llvmPackages.lldClangNoCompilerRt"</span><span class=err>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span>
    <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span>
    <span class=p>}</span>
  <span class=err>},</span>
  <span class=s2>"nixpkgs.llvmPackages.lldClangNoLibc"</span><span class=err>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span>
    <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span>
  <span class=p>}</span><span class=err>,</span>
  <span class=s2>"nixpkgs.llvmPackages.lldClangNoLibcxx"</span><span class=err>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"clang-wrapper-7.1.0"</span><span class=p>,</span> 
    <span class=err>/*</span> <span class=err>...</span> <span class=err>*/</span>
    <span class=p>}</span>
  <span class=err>}</span>
<span class=err>}</span>
</code></pre></div><p>Okay. So I <em>suspect</em> from this that the Nix derivation function takes <code>nixpkgs.cc</code> as an input, not <code>clang</code>, and that’s why we’re getting this weird wrapper script. Let’s see:</p>
<pre tabindex=0><code>$ nix-shell -p cc

[nix-shell:~/src/nix]$ clang ~/scratch/test.c

[nix-shell:~/src/nix]$ echo $?
0
</code></pre><p>Nope! Wrong again. I wonder if <code>-p cc</code> does not mean the same thing as <code>nixpkgs.cc</code>.</p>
<p>I check the man page:</p>
<pre tabindex=0><code>--packages / -p packages...
   Set up an environment in which the specified packages are present. The command line arguments are interpreted as attribute names
   inside the Nix Packages collection. Thus, nix-shell -p libjpeg openjdk will start a shell in which the packages denoted by the
   attribute names libjpeg and openjdk are present.
</code></pre><p>Okay. It does. So: what is going on here? This doesn’t seem to be a fundamental problem with Nix’s <code>cc</code> itself. Hmmmm, but maybe…?</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ which clang
/nix/store/8i0yaj3r82kqcdbr453wzzijnszxg4gx-clang-wrapper-7.1.0/bin/clang
</code></pre><p>That’s <em>not</em> the same <code>clang-wrapper</code>. The hash is different. So either I picked the wrong <code>clang-wrapper</code> and it’s <em>not</em> coming from <code>cc</code>, or something else is thefoot.</p>
<p>I’m definitely not going to check every single <code>clang-wrapper-7.1.0</code>. And I suspect at this point that there is actually a problem with “Nix flakes.” Like it’s somehow pinning my <code>cc</code> to a broken version, or something?</p>
<p>Let’s see:</p>
<pre><code>cat flake.lock
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=s2>"nodes"</span><span class=p>:</span> <span class=p>{</span>
    <span class=s2>"nixpkgs"</span><span class=p>:</span> <span class=p>{</span>
      <span class=s2>"locked"</span><span class=p>:</span> <span class=p>{</span>
        <span class=s2>"lastModified"</span><span class=p>:</span> <span class=mi>1614309161</span><span class=o>,</span>
        <span class=s2>"narHash"</span><span class=p>:</span> <span class=s2>"sha256-93kRxDPyEW9QIpxU71kCaV1r+hgOgP6/aVgC7vvO8IU="</span><span class=o>,</span>
        <span class=s2>"owner"</span><span class=p>:</span> <span class=s2>"NixOS"</span><span class=o>,</span>
        <span class=s2>"repo"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=o>,</span>
        <span class=s2>"rev"</span><span class=p>:</span> <span class=s2>"0e499fde7af3c28d63e9b13636716b86c3162b93"</span><span class=o>,</span>
        <span class=s2>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>}</span><span class=o>,</span>
      <span class=s2>"original"</span><span class=p>:</span> <span class=p>{</span>
        <span class=s2>"id"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=o>,</span>
        <span class=s2>"ref"</span><span class=p>:</span> <span class=s2>"nixos-20.09-small"</span><span class=o>,</span>
        <span class=s2>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>}</span>
    <span class=p>}</span><span class=o>,</span>
    <span class=s2>"root"</span><span class=p>:</span> <span class=p>{</span>
      <span class=s2>"inputs"</span><span class=p>:</span> <span class=p>{</span>
        <span class=s2>"nixpkgs"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span><span class=o>,</span>
  <span class=s2>"root"</span><span class=p>:</span> <span class=s2>"root"</span><span class=o>,</span>
  <span class=s2>"version"</span><span class=p>:</span> <span class=mi>7</span>
<span class=p>}</span>
</code></pre></div><p>Alright. That gives me a rev, which I <em>think</em> is all I need to check this out.</p>
<pre tabindex=0><code>$ cd ~/src/nixpkgs

$ git worktree add ../old-nixpkgs 0e499fde7af3c28d63e9b13636716b86c3162b93
Preparing worktree (detached HEAD 0e499fde7af)
Updating files: 100% (22713/22713), done.
HEAD is now at 0e499fde7af Merge pull request #114354 from aanderse/fix/flightgear

$ nix-shell --file ~/src/old-nixpkgs -p cc
error: unrecognised flag '--file'
Try 'nix-shell --help' for more information.
</code></pre><p>Exasperated sigh. <code>nix-shell</code> is not in the random subset of commands that uses <code>~/.nix-defexpr</code> and has the <code>--file</code> flag. But <code>-p</code>, and I am quoting here, said it expects “attribute names inside the Nix Packages collection.” Well, what is the “Nix Packages collection,” then? I realize that I have no idea how <code>nix-shell -p</code> works.</p>
<p><code>man nix-shell</code> eventually explains:</p>
<blockquote>
<p>The <code>-p</code> flag looks up Nixpkgs in the Nix search path. You can override it by passing <code>-I</code> or setting <code>NIX_PATH</code>. For example, the following gives you a shell containing the Pan package from a specific revision of Nixpkgs:</p>
<pre tabindex=0><code>$ nix-shell -p pan -I nixpkgs=https://github.com/NixOS/nixpkgs-channels/archive/8a3eea054838b55aca962c3fbde9c83c102b8bf2.tar.gz

[nix-shell:~]$ pan --version
Pan 0.139
</code></pre></blockquote>
<p>Sigh okay that’s fancy but I kind of already have my own thing going on here with <code>git worktree</code>.</p>
<p>It’s very weird that the man page says it looks up “Nixpkgs.” Doesn’t it look up literally the string <code>"nixpkgs"</code>? I take great exception with capitalizing that there. Is it case-insensitive? That’s very confusing.</p>
<p>But okay:</p>
<pre tabindex=0><code>$ nix-shell -p cc -I nixpkgs=$HOME/src/old-nixpkgs
(downloading things, as always...)

[nix-shell:~/src/nix]$ which cc
/nix/store/3mrwg8hplg82w3c4q2c2whkjq4wfly25-clang-wrapper-7.1.0/bin/cc
</code></pre><p>OKAY. Moment of truth:</p>
<pre tabindex=0><code>[nix-shell:~/src/nixpkgs]$ cc ~/scratch/test.c
ld: file not found: /usr/lib/system/libcache.dylib for architecture x86_64
clang-7: error: linker command failed with exit code 1 (use -v to see invocation)
</code></pre><p><em>Alright</em>. Now we’re cooking.</p>
<p>Well, okay. So this is hilarious, right? The “flakes” feature exist to pin us to specific revisions of “channels” to ensure that we get a deterministic result independently of when users have last updated their Nixpkgs. And Nix uses this to pin itself to a <em>broken</em> C compiler.</p>
<p>So.</p>
<p>Cool.</p>
<p>Obviously I have many ways forward here. I know that there is a working <code>clang</code> on the latest Nixpkgs – or rather, on whatever the unstable Nixpkgs channel happened to be the last time I pulled. Which was probably a day or so ago.</p>
<p>But the right thing to do here is to report this as a bug. I expect that there are between zero and zero Nix maintainers who actually develop on macOS, and while this will probably be caught and fixed the next time they try to cut a release, that could be years from now.</p>
<p>But first: time has passed. I first encountered this bug on a Saturday night. It is now Monday night. It’s possible someone already fixed it. I should pull and see.</p>
<pre tabindex=0><code>$ git fetch
remote: Enumerating objects: 74, done.
remote: Counting objects: 100% (74/74), done.
remote: Compressing objects: 100% (26/26), done.
remote: Total 74 (delta 49), reused 59 (delta 45), pack-reused 0
Unpacking objects: 100% (74/74), done.
From github.com:NixOS/nix
   52b6e0f83..1c0e3e453  master             -&gt; origin/master
   3cdd46421..2a19287b8  2.3-maintenance    -&gt; origin/2.3-maintenance
 * [new branch]          ca/sign-drvoutputs -&gt; origin/ca/sign-drvoutputs

$ git ff
Updating 52b6e0f83..1c0e3e453
Fast-forward
 doc/manual/src/command-ref/opt-common.md | 9 ---------
 src/libcmd/command.hh                    | 2 ++
 src/libcmd/installables.cc               | 6 ++++++
 src/nix-build/nix-build.cc               | 1 +
 4 files changed, 9 insertions(+), 9 deletions(-)
</code></pre><p>Nope. No change to the <code>flake.lock</code>. Ugh. That means I have to <em>talk to actual people</em> and risk <em>looking dumb on The Internet</em>. Social anxiety sets in, and I feel a familiar doubt surface: what if <em>I’m</em> the problem here? What if it’s something weird about <em>my</em> computer? What if there’s already a report of this and I end up filing a duplicate that gets closed immediately? I search every term I can think of.</p>
<p>What if <em>Linux people</em> make fun of me for <em>using a Mac?</em></p>
<p>Good thing I’m so brave that none of these thoughts have <em>ever</em> prevented me from reporting a bug to an open source project before.</p>
<p>I bite the bullet:</p>
<p><a href=https://github.com/NixOS/nix/issues/4621>https://github.com/NixOS/nix/issues/4621</a></p>
<p>In the course of writing that report I learned that the <code>nix-shell</code> example in the man page:</p>
<pre><code>$ nix-shell -p pan -I nixpkgs=https://github.com/NixOS/nixpkgs-channels/archive/8a3eea054838b55aca962c3fbde9c83c102b8bf2.tar.gz
</code></pre>
<p>Doesn’t work for arbitrary revisions, only for particular blessed ones that have an <code>archive</code> entry. But GitHub seems to expose arbirary revisions through the API:</p>
<pre><code>$ nix-shell -p cc -I nixpkgs=https://api.github.com/repos/NixOS/nixpkgs/tarball/0e499fde7af3c28d63e9b13636716b86c3162b93
</code></pre>
<p>And that works great. Neat.</p>
<p><em>Anyway</em> we did the thing, sort of.</p>
<p>As you might have seen in the issue I filed, I also tried just updating the flake to a recent Nixpkgs and trying again, and at first that appeared to work – it certainly got through <code>configure</code>, and managed to compile everything – but it eventually failed during linking:</p>
<pre tabindex=0><code>  LD     /nix/store/2sdjhgn1aywr03sgdqw37h6g4lgsx3iz-nix-2.4pre19700101_dirty/lib/libnixmain.dylib
ld: file not found: /System/Library/Frameworks/Security.framework/Versions/A/Security for architecture x86_64
clang-7: error: linker command failed with exit code 1 (use -v to see invocation)
make: *** [mk/lib.mk:100: /nix/store/2sdjhgn1aywr03sgdqw37h6g4lgsx3iz-nix-2.4pre19700101_dirty/lib/libnixmain.dylib] Error 1
builder for '/nix/store/sn9lynk5yznkh7sxijgfi6gzvakhr0dn-nix-2.4pre19700101_dirty.drv' failed with exit code 2
error: build of '/nix/store/sn9lynk5yznkh7sxijgfi6gzvakhr0dn-nix-2.4pre19700101_dirty.drv' failed
</code></pre><p>That… hmm. I don’t know what that is or what that is about. Is that something weird with my computer? I don’t know. That feels… less like an obvious problem with Nix and more like a possible problem with my weird ancient computer.</p>
<p>I mean, yes, it is still the case that Nix is supposed to make builds work independent of my system state and save me from having to figure out how my system dylibs are supposed to whatever. But I am sympathetic that, you know, it’s macOS. It’s not exactly designed to run software that I didn’t pay money for.</p>
<p>I think I’ll have to wait for someone with more Nix knowledge to chime in on the issue before I can hope to fix this bug. Or rather… to check whether the bug has already been fixed on latest <code>master</code>.</p>
<p>Hmm.</p>
<p>Something occurs to me.</p>
<p>I had <em>assumed</em> that the mercurial derivation was only broken on macOS, because I am on macOS, and I expect macOS to be a second class citizen in the Nix ecosystem.</p>
<p>But… maybe it’s not? If this problem exists on Linux as well, then I could compile Nix on my remote NixOS box and try to fix the issue there. So… let’s check it?</p>
<pre tabindex=0><code>claudius $ nix-env -iA nixpkgs.mercurial
installing 'mercurial-5.6'
these paths will be fetched (15.30 MiB download, 79.47 MiB unpacked):
  /nix/store/1amg8fs88bj0ac06hbs1fbqf22c9rak5-readline-6.3p08
  /nix/store/cdz5vbnfp9vq84ir414cgnvzq63wp9m6-gdbm-1.19
  /nix/store/f7jzmxq9bpbxsg69cszx56mw14n115n5-bash-4.4-p23
  /nix/store/r8iamjpyzwy154g0dvr397gcls2crm3w-mercurial-5.6
  /nix/store/yl69v76azrz4daiqksrhb8nnmdiqdjg9-python3-3.8.8
copying path '/nix/store/f7jzmxq9bpbxsg69cszx56mw14n115n5-bash-4.4-p23' from 'https://cache.nixos.org'...
copying path '/nix/store/cdz5vbnfp9vq84ir414cgnvzq63wp9m6-gdbm-1.19' from 'https://cache.nixos.org'...
copying path '/nix/store/1amg8fs88bj0ac06hbs1fbqf22c9rak5-readline-6.3p08' from 'https://cache.nixos.org'...
copying path '/nix/store/yl69v76azrz4daiqksrhb8nnmdiqdjg9-python3-3.8.8' from 'https://cache.nixos.org'...
copying path '/nix/store/r8iamjpyzwy154g0dvr397gcls2crm3w-mercurial-5.6' from 'https://cache.nixos.org'...
nix-env: src/libexpr/attr-set.hh:54: void nix::Bindings::push_back(const nix::Attr&amp;): Assertion `size_ &lt; capacity_' failed.
[1]    19549 abort (core dumped)  nix-env -iA nixpkgs.mercurial
</code></pre><aside>
<p><code>claudius</code>, as previously mentioned, is my NixOS box. I name the VPSes I use for my personal website after emperors of Rome. I’m not sure why I chose that scheme; it was a very long time ago. It may have started with me naming a server <code>tiberius</code> just because that’s a great name, and then when <code>tiberius</code> died I retroactively decided on a line of succession. Not sure.</p>
<p>For some reason I decided to try <code>btrfs</code> on my previous server. I experienced the sort of catastrophic file system failure that you would expect and deserve from using an experimental file system. I mention this because I thought it was funny that <code>caligula</code> was done in as a result of its own perverse excess.</p>
<p>I hope <code>claudius</code> lasts, because I am really not looking forward to whatever <code>nero</code> is going to put me through.</p>
</aside>
<p>Okay! So <em>even <code>claudius</code></em> can’t install Mercurial. It’s not just a macOS issue! Excellent. That means we can debug it.</p>
<p>Assuming… well, you know. <em>Surely</em>. <em>Surely</em> we an compile Nix here, of all places. Right? <em>Right??</em></p>
<p>I am going to say this and desperately hope that it does not become an ironic epitaph to this blog series: this <em>has to work</em>. If we can’t build Nix on (latest stable!) NixOS, we may as well go home.</p>
<p>So let’s see.</p>
<pre tabindex=0><code>claudius $ nix-build
</code></pre><p>And it’s building it! So far so good.</p>
<p>The build has been running for about an hour now without failure; I’ll come back tomorrow to see if finishes.</p>
<p>Oh! There it goes. Okay. Build succeeded!</p>
<p>And let’s see if the bug still exists on <code>master</code>…</p>
<pre tabindex=0><code>claudius $ result/bin/nix-build -A nixpkgs.mercurial -o mercurial
error: attribute 'nixpkgs' in selection path 'nixpkgs.mercurial' not found
</code></pre><p>Er, right. <code>nix-build</code> works completely differently from <code>nix-env</code>. Of course.</p>
<pre tabindex=0><code>claudius $ result/bin/nix-build '&lt;nixpkgs&gt;' -A mercurial -o mercurial
/nix/store/r8iamjpyzwy154g0dvr397gcls2crm3w-mercurial-5.6
</code></pre><p>And it worked! That’s reassuring, at least.</p>
<pre tabindex=0><code>$ mercurial/bin/hg --version
Mercurial Distributed SCM (version 5.6)
(see https://mercurial-scm.org for more information)

Copyright (C) 2005-2020 Matt Mackall and others
This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</code></pre><p>Okay. Whatever this bug was, it has already been fixed in <code>master</code>. I do not need to dust off my C++ helmet after all.</p>
<p>Which I really did expect. It would be <em>super weird</em> if a package slipped into Nixpkgs that could not be built by hand of man nor beast. I assume the maintainer of the Mercurial package is just using some bleeding edge version of Nix, and thus didn’t notice this problem. I check the package meta and see that the <code>nixpkgs.mercurial</code> maintainer is <a href=https://github.com/edolstra>edolstra</a> – the inventor of Nix – so yeah their running a freshly honed and bloody Nix seems pretty likely.</p>
<p>This makes me wonder about the CI situation here! I would expect, you know, that Nix would test that derivations can be built with the latest stable Nix before merging changes into Nixpkgs. I guess that that’s not the case? Troubling.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p>
<p>Since the bug has since been fixed, I wonder if I can find the commit that does so and at least learn a little bit from all this.</p>
<p>On a whim I search the repo for <code>push_back</code> on the off-chance that someone included the exact assertion error in their commit message. I find this commit which references the same error message:</p>
<p><a href=https://github.com/NixOS/nix/commit/8dbd57a6a5fe497bde9e647a3249c1ce0ea121ab>https://github.com/NixOS/nix/commit/8dbd57a6a5fe497bde9e647a3249c1ce0ea121ab</a></p>
<p>But that doesn’t seem to have anything to do with this – just an error when passing arguments via the command line. It’s the same assertion, but it’s coming from what I imagine is pretty common code path: adding an attribute to a set.</p>
<p>Hmm. I search for <code>assertion</code> and find no likely culprits. I suspect this was fixed as part of a larger change and not a specific targeted patch for this one issue.</p>
<p>Well, I am very curious what the bug is now, even though it seems that I don’t have to fix it. If I can understand why the Mercurial derivation is broken, I could at least fix the derivation in Nixpkgs. Right?</p>
<p><code>git bisect</code> is my first thought here. It’s a great tool when you’re working with an unfamiliar codebase, and you don’t have any intuition for where a bug might hide or when it might have been introduced.</p>
<p>Rebuilding every revision is going to take a really long time, but that’s not <em>really</em> a problem: I just need to remember how to get an auto-bisect working right. I usually just bisect by hand and feel guilty about all the time I’m wasting at work, because my past experiences have taught me that auto-bisecting is always more frustrating than it’s worth – coming up with a single script that runs the test you want at any point in time is… often hard.</p>
<p>But let’s figure it out! This can be the thing we learn today.</p>
<p>Er, by “today” I mean “in this blog post that I have been writing for the past six days.”</p>
<p>I read the man page for <code>git-bisect</code> and learn that you can use custom terms instead of <code>bad</code> and <code>good</code>. Neat! Usually I am bisecting to find the commit that introduced a bug, but now I’m trying to find a commit that fixes a bug, and using <code>good</code>/<code>bad</code> to mean <code>buggy</code>/<code>fixed</code> would be very confusing to me. I am delighted to learn that I can use <code>git bisect terms</code> if I need a reminder of the terms I decided to use. Very cute.</p>
<p>I learn that I need to <code>exit 125</code> to skip a commit – which I’ll need to do if I encounter a commit that I cannot build. And I need to <code>exit 0</code> to indicate an “old” commit – aka to indicate that the assertion failure is there. And I need to exit nonzero to indicate a “new” commit, aka one where the assertion failure has been fixed.</p>
<p>So a little bit of weird inversion, but nothing crazy. Could just be <code>! result/bin/nix-build</code>, but I opt for something a little more explicit:</p>
<pre><code>claudius $ cat ~/scratch/nix-detective
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span>
<span class=nb>set</span> -euo pipefail

nix-build <span class=o>||</span> <span class=nb>exit</span> <span class=m>125</span>

<span class=k>if</span> result/bin/nix-build <span class=s1>'&lt;nixpkgs&gt;'</span> -A mercurial -o mercurial<span class=p>;</span> <span class=k>then</span>
  <span class=c1># the assertion failure has been fixed</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>else</span>
  <span class=c1># the assertion failure is still here</span>
  <span class=nb>exit</span> <span class=m>0</span>
<span class=k>fi</span>
</code></pre></div><p>Let’s see if this works? It seems like there is almost no chance that I got this right on my first try. Let’s look up the <code>git tag</code>… just <code>2.3.10</code>. Okay. Let’s go.</p>
<pre tabindex=0><code>claudius $ git bisect start --term-old assertion-failed --term-new mercurial-is-fine

claudius $ git bisect mercurial-is-fine

claudius $ git bisect assertion-failed 2.3.10
Bisecting: a merge base must be tested
[b774845af7a645b44bff69cf9f655c47fe4b9fb2] Set release date
</code></pre><p>What’s that? I don’t think I’ve ever seen that message before. I google it, and find <a href=https://stackoverflow.com/a/45111908/223274>this helpful StackOverflow answer</a>.</p>
<blockquote>
<p>This will happen if the given good and bad revision are not direct descendants of each other.</p>
</blockquote>
<p>Hmm. Is <code>master</code> not a descendant of <code>2.3.10</code>? That’s <em>kind of surprising</em>. But not really – I would expect this to happen if you cut a new stable release with some backported patches or something. Everything is fine. Let’s run the script.</p>
<p>I’m so nervous.</p>
<pre tabindex=0><code>claudius $ git bisect run ~/scratch/nix-detective
running /home/ian/scratch/nix-detective
error: getting status of '/home/ian/src/nix/default.nix': No such file or directory
warning: the merge base between 1c0e3e453d41b869e4ac7e25dc1c00c349a7c411 and [8803753666023882515404177b08f3f8bdad52a0] must be skipped.
So we cannot be sure the first mercurial-is-fine commit is between b774845af7a645b44bff69cf9f655c47fe4b9fb2 and 1c0e3e453d41b869e4ac7e25dc1c00c349a7c411.
We continue anyway.
Bisecting: 1611 revisions left to test after this (roughly 11 steps)
</code></pre><p>Huh. Weird. But true! Inspecting that commit shows there is no <code>default.nix</code>. I guess it’s so old that it… no; it’s only from September 2019. What year is it again? I have no idea.</p>
<p>Anyway, the script is running. I’ll come back in a few hours and see how it does. I briefly think about what my life was like before I started using <code>tmux</code> for everything all the time. Man. I should write a blog post about that.</p>
<p>I hope I don’t run out of disk space doing this. It sure seems like it’s downloading a lot of versions of different packages as it goes. I guess I’m going through a different <code>flake</code> rev every time I change commits. Should’ve had my script collect garbage in between runs.</p>
<p>Can I trigger a GC while this bisect is running? I think that it <em>should</em> work just fine. But I am nervous to do so. With only 4.4 jeebies left on my VPS, I’m not sure I’ll have much choice soon. Do you think Nix registers GC roots <em>before</em> it starts building a package? Probably, right? Let’s find out.</p>
<pre tabindex=0><code>claudius $ nix-collect-garbage -d
</code></pre><p>Well it didn’t fail <em>immediately</em>. And yeah, it seems like it’s carrying on just fine. Good! I expected that to be okay but, you know, I wasn’t totally sure. But it occurs to me now that on a multi-user system it would be completely insane if garbage collection could break builds for other users, so of course it sets up the GC roots ahead of time.</p>
<p>Sigh. I come back some six hours later to find:</p>
<pre tabindex=0><code>Bisecting: 497 revisions left to test after this (roughly 9 steps)
[5dafde28dbec379678da6d033cdc5c48856babf5] BinaryCacheStore: Add index-debug-info option
running /home/ian/scratch/nix-detective
error: getting status of '/home/ian/src/nix/default.nix': No such file or directory
There are only 'skip'ped commits left to test.
The first mercurial-is-fine commit could be any of:
497 INDIVIDUAL REVISIONS LISTED
We cannot bisect more!
bisect run cannot continue any more
</code></pre><p>Boo. I guess I should have paid more attention to that failure before.</p>
<p>And then… change the script to conditionally build… hrm. Hrm.</p>
<p>Startup idea: a single <code>./build</code> executable shell command in the root of every single repository so that you can write <code>bisect</code> scripts that work regardless of how often you change your build invocation. Yes, of course I know that that’s the least of my problems shut up. Maybe a high level wrapper around <code>bisect</code> that like… interactively learns different ways to build/test revisions <em>across history</em> that progressively “learns” how the invocations change over time. Sort of like… sort of like running a normal interactive bisect. Except that in the happy case you can just leave it sitting for a few hours. This is nothing.</p>
<p>Let’s see. There’s actually <a href=https://web.archive.org/web/20210227145624/https://nixos.org/manual/nix/stable/#chap-hacking>a section in the manual</a> that tells me how to build Nix. I assumed that this only applied to some ancient outdated version, since the Wiki taught me I could just run <code>nix-build</code> bare and that worked just fine. But it seems that this command applies in these old revisions that lack a <code>default.nix</code>:</p>
<blockquote>
<pre tabindex=0><code>$ nix-build release.nix -A build.x86_64-linux
</code></pre></blockquote>
<p>I test this and it <em>seems</em> okay, although I don’t wait to see if the build actually completes. It leaves me with this slightly more complicated script:</p>
<pre><code>cat ~/scratch/nix-detective
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span>
<span class=nb>set</span> -euo pipefail

<span class=k>if</span> <span class=o>[[</span> -e default.nix <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  nix-build <span class=o>||</span> <span class=nb>exit</span> <span class=m>125</span>
<span class=k>else</span>
  nix-build release.nix -A build.x86_64-linux <span class=o>||</span> <span class=nb>exit</span> <span class=m>125</span>
<span class=k>fi</span>

<span class=k>if</span> result/bin/nix-build <span class=s1>'&lt;nixpkgs&gt;'</span> -A mercurial -o mercurial<span class=p>;</span> <span class=k>then</span>
  <span class=c1># the assertion failure has been fixed</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>else</span>
  <span class=c1># the assertion failure is still here</span>
  <span class=nb>exit</span> <span class=m>0</span>
<span class=k>fi</span>
</code></pre></div><p>No, I’m not gonna scope <code>||</code> over that entire <code>if</code> block to reduce code duplication. Do you know how <code>||</code> works? It’s – look it up. If you can figure out how to google that. It’s <em>not</em> the way you want it to work. It like disables the effect of <code>set -e</code> on the left-hand side of its argument in a super weird confusing way I don’t know the semantics I just know I’ve been burned before.</p>
<p>Anyway, I start over:</p>
<pre tabindex=0><code>claudius $ git bisect reset
Previous HEAD position was b774845af Set release date
Switched to branch 'master'
Your branch is up to date with 'origin/master'.

claudius $ git bisect start --term-old assertion-failed --term-new mercurial-is-fine

claudius $ git bisect mercurial-is-fine

claudius $ git bisect assertion-failed 2.3.10
Bisecting: a merge base must be tested
[b774845af7a645b44bff69cf9f655c47fe4b9fb2] Set release date

claudius $ git bisect run ~/scratch/nix-detective
running /home/ian/scratch/nix-detective
</code></pre><p>And we shall return… in another six hours. Fortunately I remember to collect garbage before walking away from my computer to enjoy the last rays of sunshine on this beautiful spring day.</p>
<pre tabindex=0><code>The merge base b774845af7a645b44bff69cf9f655c47fe4b9fb2 is mercurial-is-fine.
This means the first 'assertion-failed' commit is between b774845af7a645b44bff69cf9f655c47fe4b9fb2 and [8803753666023882515404177b08f3f8bdad52a0].
bisect run failed:
'bisect_state mercurial-is-fine' exited with error code 3
</code></pre><p>Okay no; that one failed pretty fast. Seems that the problem does not occur in the “merge base,” so the bug is (according to my <code>bisect</code>) never actually present in the <code>master</code> branch. It was introduced at some point after the <code>2.3.10</code> tag diverged from <code>master</code>.</p>
<p>So… that’s good, right? I mean, that really narrows the search space. It also means that there <em>is</em> a bug that <em>has not</em> been fixed yet. So we <em>do</em> get to debug it. Nice!</p>
<p>So let’s try to bisect <em>that</em>. It shouldn’t be too hard, and we’re back into familiar “find a bug” bisect territory, so we can just use the normal “good” and “bad” terminology.</p>
<p>And what… what am I doing here? What is my life right now? What has this series become? I’m way too deep into this to bail right now, so I push those thoughts deep down inside of me and <em>get bisecting</em>. Did you notice the wordplay there? Did you see it? Do you appreciate the things I do to spice up this already <em>thrilling</em> account of me fumbling my way through basic <code>git</code> commands?</p>
<pre tabindex=0><code>$ git bisect reset start run good bad detective --help --where-is-the-forest --who-is-the-tree
</code></pre><p>Okay focus:</p>
<pre tabindex=0><code>claudius $ git bisect start

claudius $ git bisect bad 2.3.10

claudius $ git bisect good 2.3
Bisecting: 74 revisions left to test after this (roughly 6 steps)
[7afd8321edbf94d19caa76b668133ae3d0e58eb3] libstore/ssh: Improve error message on failing `execvp`

claudius $ git bisect run ~/scratch/nix-detective
running /home/ian/scratch/nix-detective
</code></pre><p>And that worked!</p>
<p>He wrote, optimistically, after about ten seconds of nothing happening. We’ll be back… <em>in another six hours</em>.</p>
<p>Wow, time really flies on the internet huh.</p>
<pre tabindex=0><code>1d5cb6ad4839a50a96c27c94f19adcb97b6391af is the first bad commit
...
bisect run success
</code></pre><p><em>Whoops</em>.</p>
<pre tabindex=0><code>$ git bisect log
git bisect start
# bad: [8803753666023882515404177b08f3f8bdad52a0] Merge pull request #4374 from NixOS/2.3-absolute-url-in-binary-caches
git bisect bad 8803753666023882515404177b08f3f8bdad52a0
# good: [22d4ea7a989d26b86fc27706dfea0abd2fb52c52] Tweak release notes
git bisect good 22d4ea7a989d26b86fc27706dfea0abd2fb52c52
# bad: [7afd8321edbf94d19caa76b668133ae3d0e58eb3] libstore/ssh: Improve error message on failing `execvp`
git bisect bad 7afd8321edbf94d19caa76b668133ae3d0e58eb3
# bad: [10bf5340ca35269153aca67ecd35f5419d0a08bc] Fix sandbox fallback settings
git bisect bad 10bf5340ca35269153aca67ecd35f5419d0a08bc
# bad: [65953789bcd73f098486b0a385b4e661c0ccda19] Remove world-writability from per-user directories
git bisect bad 65953789bcd73f098486b0a385b4e661c0ccda19
# bad: [f3ce4453a61fff960551322c1743f979f8c07e68] Don't catch exceptions by value
git bisect bad f3ce4453a61fff960551322c1743f979f8c07e68
# bad: [3c5788d09444b48c5ad82e8677d4ac5a58b94a3a] Fix typos in the Nix Manual.
git bisect bad 3c5788d09444b48c5ad82e8677d4ac5a58b94a3a
# bad: [1b78bbb4144c6ad4ef15f7a10fd9d479e06df5da] nix search: Don't quietly ignore errors
git bisect bad 1b78bbb4144c6ad4ef15f7a10fd9d479e06df5da
# bad: [1d5cb6ad4839a50a96c27c94f19adcb97b6391af] getSourceExpr(): Handle channels
git bisect bad 1d5cb6ad4839a50a96c27c94f19adcb97b6391af
# first bad commit: [1d5cb6ad4839a50a96c27c94f19adcb97b6391af] getSourceExpr(): Handle channels
</code></pre><p>I inverted what I was looking for… but I forgot to invert the script, so I got a nonsense answer: the very first commit made in the <code>2.3</code> branch, which appears to have nothing to do with anything. Man, that was really dumb.</p>
<p>Alright, well, pretend you didn’t see that. I’ll see you in another six hours!</p>
<p>Six hours later:</p>
<p>Oh I hate this so much. It finished, in the exact opposite way:</p>
<pre tabindex=0><code>claudius $ git bisect log
git bisect start
# bad: [8803753666023882515404177b08f3f8bdad52a0] Merge pull request #4374 from NixOS/2.3-absolute-url-in-binary-caches
git bisect bad 8803753666023882515404177b08f3f8bdad52a0
# good: [22d4ea7a989d26b86fc27706dfea0abd2fb52c52] Tweak release notes
git bisect good 22d4ea7a989d26b86fc27706dfea0abd2fb52c52
# good: [7afd8321edbf94d19caa76b668133ae3d0e58eb3] libstore/ssh: Improve error message on failing `execvp`
git bisect good 7afd8321edbf94d19caa76b668133ae3d0e58eb3
# good: [2fad345ae1b316b9f08c31565374bc22e2fd37ec] Bump version
git bisect good 2fad345ae1b316b9f08c31565374bc22e2fd37ec
# good: [f09b375837e8139b4b06efeb6517265370b128c4] Prevent a deadlock when user namespace setup fails
git bisect good f09b375837e8139b4b06efeb6517265370b128c4
# good: [c67264d218f6595e8fd3f59dcf76c20350198b90] Bump version
git bisect good c67264d218f6595e8fd3f59dcf76c20350198b90
# good: [62f01d7ed3d5e6fb0dc1ed05be45e4e793bbf839] Bump version
git bisect good 62f01d7ed3d5e6fb0dc1ed05be45e4e793bbf839
# good: [0f359049157337a91b524b07d1ef122f75404f7b] Add support for \u escape in fromJSON
git bisect good 0f359049157337a91b524b07d1ef122f75404f7b
# good: [6de15f722daa709ee0ea5a32cc6b9b203d8bac4c] Allow HTTP binary cache to request absolute uris
git bisect good 6de15f722daa709ee0ea5a32cc6b9b203d8bac4c
# first bad commit: [8803753666023882515404177b08f3f8bdad52a0] Merge pull request #4374 from NixOS/2.3-absolute-url-in-binary-caches
</code></pre><p>It never found a bad commit.</p>
<p>Which means one of two things: the test that I’m doing to build mercurial <em>isn’t working</em> – I suspect that it isn’t actually building mercurial, in the case that I already have mercurial in my store. I assumed there was a problem just like <em>evaluating</em> the derivation, based on the error message, but maybe not.</p>
<p>The second thing is much more terrifying: that this bug <em>doesn’t actually exist at <code>2.3.10</code></em>. And that’s – surely not, right? But I never tested it! I just <em>assumed</em> that the tag <code>2.3.10</code> meant the Nix release <code>2.3.10</code> – and that version definitely has the bug. But was that not a good assumption?</p>
<p>I’ll have to build that revision by hand and test it manually.</p>
<p>I confirm that collecting garbage after removing the symlink does the thing that I want it to:</p>
<pre tabindex=0><code>claudius $ rm -rf mercurial

claudius $ nix-collect-garbage
finding garbage collector roots...
removing stale link from '/nix/var/nix/gcroots/auto/xcj9j0ibwmjhw421sz2zz5g332gvczw4' to '/home/ian/src/nix/mercurial'
deleting garbage...
deleting '/nix/store/r8iamjpyzwy154g0dvr397gcls2crm3w-mercurial-5.6'
deleting '/nix/store/yl69v76azrz4daiqksrhb8nnmdiqdjg9-python3-3.8.8'
deleting '/nix/store/9gc6b7bazn23m0g7xcg9zv4j36kqraa7-mercurial-5.6.drv'
deleting '/nix/store/xys2byp05w12ixiswi69znw2yrfnfkd0-mercurial-5.6.tar.gz.drv'
deleting '/nix/store/1amg8fs88bj0ac06hbs1fbqf22c9rak5-readline-6.3p08'
deleting '/nix/store/cdz5vbnfp9vq84ir414cgnvzq63wp9m6-gdbm-1.19'
deleting '/nix/store/trash'
deleting unused links...
note: currently hard linking saves -0.00 MiB
6 store paths deleted, 77.14 MiB freed
</code></pre><p>So that in case it’s actually the first thing, I won’t be misled. <em>See you in a bit</em>.</p>
<p>Okay.</p>
<p>Bad news.</p>
<p><code>2.3.10</code> can build mercurial <em>just fine</em>.</p>
<p>What the hell is going on here?</p>
<p>I do a sanity check, and find that <em>my stable <code>nix-build</code> can also build mercurial now</em>. I scroll up, and see that… I didn’t just <em>dream</em> that this was an issue.</p>
<p>And I haven’t run <code>nix-channel --update</code>.</p>
<p>So what changed such that this works now?</p>
<p>I check my <code>~/.nix-defexpr/channels/manifest.nix</code> and see that I’m on Nixpkgs <code>f5f6dc053b1</code> – a commit from 2021-03-05 (it is now the 12th). So it hasn’t like… updated my channel in the background or something. That would have been crazy, but it was the first thing I thought of, because I <em>do</em> have NixOS auto-updating… but that’s a completely different channel on a completely different user.</p>
<p>But something about <em>something</em> has changed such that I can now build this package that I couldn’t build before.</p>
<p>Hmm.</p>
<p>Let’s do a sanity check: it’s still broken on my laptop, right?</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.mercurial
installing 'mercurial-5.6'
these paths will be fetched (3.45 MiB download, 14.95 MiB unpacked):
  /nix/store/ipymk6q0mdpvisyfmr3fz12s7yl2dcgq-mercurial-5.6
copying path '/nix/store/ipymk6q0mdpvisyfmr3fz12s7yl2dcgq-mercurial-5.6' from 'https://cache.nixos.org'...
Assertion failed: (size_ &lt; capacity_), function push_back, file src/libexpr/attr-set.hh, line 54.
[1]    48643 abort      nix-env -iA nixpkgs.mercurial
</code></pre><p>Well thank goodness.</p>
<p>Which means…</p>
<p>Ugh. Which means I’m an idiot. Also on my laptop:</p>
<pre tabindex=0><code>$ nix-build '&lt;nixpkgs&gt;' -A mercurial -o mercurial
/nix/store/ipymk6q0mdpvisyfmr3fz12s7yl2dcgq-mercurial-5.6
</code></pre><p>Heavy sigh. Well, that was a really dumb assumption. That’s on me.</p>
<p>So none of the bisects that I’ve done have meant… anything.</p>
<p>Reset everything to the initial state. Unwind the last, like, 20 pages of text you’ve read. We don’t even know if this bug exists on <code>master</code> or not, because I was checking the wrong thing this whole time. I feel very silly.</p>
<p>I am very curious though… installing and building <em>aren’t very different</em>, right? Like, aren’t we basically just building stuff and then making some symlinks? The error is coming not from the complex evaluation of a Nix expression, but just from the <em>symlinking part?</em> I don’t know. We’ll find out, I guess.</p>
<p>Aaaand:</p>
<pre tabindex=0><code>claudius $ result/bin/nix-env -iA nixpkgs.mercurial -p ~/scratch/profile
installing 'mercurial-5.6'
nix-env: src/libexpr/attr-set.hh:54: void nix::Bindings::push_back(const nix::Attr&amp;): Assertion `size_ &lt; capacity_' failed.
[1]    32002 abort (core dumped)  result/bin/nix-env -iA nixpkgs.mercurial -p ~/scratch/profile
</code></pre><p>Yep. Okay. Gah. Stupid.</p>
<pre tabindex=0><code>claudius $ git checkout master

claudius $ nix-build
</code></pre><p>Well, I’ve wasted a lot <code>claudius</code>’s time here. The poor lad has just been compiling Nix in the background for the past like 24 hours, for no reason. I hope that this serves as a good lesson in, you know, not being an idiot. It was certainly humbling. I truly have made an ass out of you and me.</p>
<p>But one wrong turn will not keep us from our destination. Nor… three wrong turns. Maybe they were all left turns, and now we’re headed in the… <em>right</em> direction.</p>
<pre tabindex=0><code>claudius $ result/bin/nix-env -iA nixpkgs.mercurial -p ~/scratch/profile
installing 'mercurial-5.6'
these 4 paths will be fetched (14.94 MiB download, 78.20 MiB unpacked):
  /nix/store/1amg8fs88bj0ac06hbs1fbqf22c9rak5-readline-6.3p08
  /nix/store/cdz5vbnfp9vq84ir414cgnvzq63wp9m6-gdbm-1.19
  /nix/store/r8iamjpyzwy154g0dvr397gcls2crm3w-mercurial-5.6
  /nix/store/yl69v76azrz4daiqksrhb8nnmdiqdjg9-python3-3.8.8
copying path '/nix/store/cdz5vbnfp9vq84ir414cgnvzq63wp9m6-gdbm-1.19' from 'https://cache.nixos.org'...
downloading 'https://cache.nixos.org/nar/1nh2lym6nmhm8d0hf0hlyrczxzac6p5fyk42z2wx6q6jsz1g7n44.nar.xz'...
copying path '/nix/store/1amg8fs88bj0ac06hbs1fbqf22c9rak5-readline-6.3p08' from 'https://cache.nixos.org'...
downloading 'https://cache.nixos.org/nar/1dfaz2awrdv01cqics7j3i0hyymhzx9y7gn3fs17pnm8aalbp2gx.nar.xz'...
copying path '/nix/store/yl69v76azrz4daiqksrhb8nnmdiqdjg9-python3-3.8.8' from 'https://cache.nixos.org'...
downloading 'https://cache.nixos.org/nar/0jdkfshgiqfz1r51w7710pyg2js61k0iijpcz873fz6j9fywvkxz.nar.xz'...
copying path '/nix/store/r8iamjpyzwy154g0dvr397gcls2crm3w-mercurial-5.6' from 'https://cache.nixos.org'...
downloading 'https://cache.nixos.org/nar/1cxpijnp5m0fvcrylxmd1k9p8m5q58sdg5zcp36dfr8lp37f9n9w.nar.xz'...
building '/nix/store/87c047xnxhjibf8h4wi8j4pxvxp48vn2-user-environment.drv'...
created 3 symlinks in user environment
</code></pre><p><em>Okay</em>. So it <em>is</em> fixed in <code>master</code>. As, you know, as I expected. Now let’s do the correct bisect this time, so we can backport the fix to <code>2.3.10</code>…</p>
<p>I <em>very carefully</em> restore the original script I had run to make sure that I get the old/new terminology right…</p>
<pre><code>old = exit 0 = install-failed
new = exit 1 = install-succeeded
</code></pre>
<p>And just to review:</p>
<pre><code>claudius $ cat ~/scratch/nix-detective
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span>
<span class=nb>set</span> -euo pipefail

nix-env -p ~/scratch/profile --uninstall mercurial <span class=o>||</span> <span class=nb>true</span>
nix-collect-garbage

<span class=k>if</span> <span class=o>[[</span> -e default.nix <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  nix-build <span class=o>||</span> <span class=nb>exit</span> <span class=m>125</span>
<span class=k>else</span>
  nix-build release.nix -A build.x86_64-linux <span class=o>||</span> <span class=nb>exit</span> <span class=m>125</span>
<span class=k>fi</span>

<span class=k>if</span> result/bin/nix-env -p ~/scratch/profile -iA nixpkgs.mercurial<span class=p>;</span> <span class=k>then</span>
  <span class=c1># install succeeded</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>else</span>
  <span class=c1># install failed</span>
  <span class=nb>exit</span> <span class=m>0</span>
<span class=k>fi</span>
</code></pre></div><p>Wish me luck.</p>
<pre><code>claudius $ git bisect start --term-old install-failed --term-new install-succeeded

claudius $ git bisect install-succeeded master

claudius $ git bisect install-failed 2.3.10
Bisecting: a merge base must be tested
[b774845af7a645b44bff69cf9f655c47fe4b9fb2] Set release date

claudius $ git bisect run ~/scratch/nix-detective
</code></pre>
<p>Alright. See you soon.</p>
<p>Oh hey! In the meanwhile I am notified that someone opened a PR that addresses <a href=https://github.com/NixOS/nix/issues/4621>the issue I posted above</a> about not being able to build Nix on macOS. Neat! Although doing these long-running bisects is really much nicer on the remote machine, due to, you know, laptops wanting to take lots of naps. So that doesn’t really affect me yet. But I’m happy to see some movement there!</p>
<p>Anyway. Our bisect finished, and it looks like it actually succeeded:</p>
<pre tabindex=0><code>d27eb0ef573b4739967119448779da4a8b2a2cbf is the first install-succeeded commit
commit d27eb0ef573b4739967119448779da4a8b2a2cbf
Author: David McFarland
Date:   Wed Dec 30 16:20:03 2020 -0400

    Fix insufficent attribute capacity in user profile

 src/nix-env/user-env.cc | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)
bisect run success
</code></pre><p><code>bisect run success</code> indeed. Look at that beautiful <em>actual bisect</em>:</p>
<pre tabindex=0><code>claudius $ git bisect log
git bisect start '--term-old' 'install-failed' '--term-new' 'install-succeeded'
# install-succeeded: [1c0e3e453d41b869e4ac7e25dc1c00c349a7c411] Merge pull request #4601 from lovesegfault/fix-4598
git bisect install-succeeded 1c0e3e453d41b869e4ac7e25dc1c00c349a7c411
# install-failed: [8803753666023882515404177b08f3f8bdad52a0] Merge pull request #4374 from NixOS/2.3-absolute-url-in-binary-caches
git bisect install-failed 8803753666023882515404177b08f3f8bdad52a0
# install-failed: [b774845af7a645b44bff69cf9f655c47fe4b9fb2] Set release date
git bisect install-failed b774845af7a645b44bff69cf9f655c47fe4b9fb2
# install-failed: [09fc06daab280735dd2ec94276f00a9c5bffd9b2] nix flake init: Use git add --force
git bisect install-failed 09fc06daab280735dd2ec94276f00a9c5bffd9b2
# install-failed: [9ee3122ec71ae43f5cd8bf0a9282777ba17342c5] Remove redundant import
git bisect install-failed 9ee3122ec71ae43f5cd8bf0a9282777ba17342c5
# install-failed: [1973669e868f4414b666d0fbd34f1a7a87322ae9] Merge pull request #4271 from wiltaylor/IgnoreReferenceSwitch
git bisect install-failed 1973669e868f4414b666d0fbd34f1a7a87322ae9
# skip: [17beae299d5e6bb511c453d0b9d0d7ef906b3d14] Support binary unit prefixes in command line arguments
git bisect skip 17beae299d5e6bb511c453d0b9d0d7ef906b3d14
# install-failed: [4d458394991f3086c3c9c306d000e6c0058c4fa7] Fix the detection of already built drv outputs
git bisect install-failed 4d458394991f3086c3c9c306d000e6c0058c4fa7
# install-succeeded: [0eb22db3116585821096b7b81295d4bbf5550343] Fix macOS build
git bisect install-succeeded 0eb22db3116585821096b7b81295d4bbf5550343
# install-succeeded: [d27eb0ef573b4739967119448779da4a8b2a2cbf] Fix insufficent attribute capacity in user profile
git bisect install-succeeded d27eb0ef573b4739967119448779da4a8b2a2cbf
# install-failed: [c14ed3f8b2cbddb335227d2ff5188896e76b713f] Add 'nix store' NAR-related manpages
git bisect install-failed c14ed3f8b2cbddb335227d2ff5188896e76b713f
# install-failed: [5178211e963fa111f84c4881b22cc506d5254fde] Add 'nix' manpage
git bisect install-failed 5178211e963fa111f84c4881b22cc506d5254fde
# install-failed: [8927cba62f5afb33b01016d5c4f7f8b7d0adde3c] Merge pull request #4366 from NixOS/readInvalidDerivation-on-remote-caches
git bisect install-failed 8927cba62f5afb33b01016d5c4f7f8b7d0adde3c
# install-failed: [5ef7e63ac61efcab020e64bca39ffdc1716718ed] Merge pull request #4399 from sevan/patch-1
git bisect install-failed 5ef7e63ac61efcab020e64bca39ffdc1716718ed
# install-failed: [093de16223b8b93d803e4cd1cc1d3945cb3dfeb1] README: fix link to hacking guide
git bisect install-failed 093de16223b8b93d803e4cd1cc1d3945cb3dfeb1
# install-failed: [abbf9df7b1c4219d5a6d3234d9149204208be7de] Merge pull request #4407 from cole-h/fix-hacking-link
git bisect install-failed abbf9df7b1c4219d5a6d3234d9149204208be7de
# first install-succeeded commit: [d27eb0ef573b4739967119448779da4a8b2a2cbf] Fix insufficent attribute capacity in user profile
</code></pre><p>Great. So from looking at the patch – it’s pretty small – my first thought is that basically mercurial has <em>too many outputs</em>. There is – or there was – a hardcoded maximum in here, and I guess that the mercurial derivation exceeds that maximum.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=gd>--- a/src/nix-env/user-env.cc
</span><span class=gd></span><span class=gi>+++ b/src/nix-env/user-env.cc
</span><span class=gi></span><span class=gu>@@ -53,10 +53,12 @@ bool createUserEnv(EvalState &amp; state, DrvInfos &amp; elems,
</span><span class=gu></span>            output paths, and optionally the derivation path, as well
            as the meta attributes. */
         Path drvPath = keepDerivations ? i.queryDrvPath() : "";
<span class=gi>+        DrvInfo::Outputs outputs = i.queryOutputs(true);
</span><span class=gi>+        StringSet metaNames = i.queryMetaNames();
</span><span class=gi></span>
         Value &amp; v(*state.allocValue());
         manifest.listElems()[n++] = &amp;v;
<span class=gd>-        state.mkAttrs(v, 16);
</span><span class=gd></span><span class=gi>+        state.mkAttrs(v, 7 + outputs.size());
</span><span class=gi></span>
         mkString(*state.allocAttr(v, state.sType), "derivation");
         mkString(*state.allocAttr(v, state.sName), i.queryName());
<span class=gu>@@ -68,7 +70,6 @@ bool createUserEnv(EvalState &amp; state, DrvInfos &amp; elems,
</span><span class=gu></span>             mkString(*state.allocAttr(v, state.sDrvPath), i.queryDrvPath());

         // Copy each output meant for installation.
<span class=gd>-        DrvInfo::Outputs outputs = i.queryOutputs(true);
</span><span class=gd></span>         Value &amp; vOutputs = *state.allocAttr(v, state.sOutputs);
         state.mkList(vOutputs, outputs.size());
         unsigned int m = 0;
<span class=gu>@@ -88,8 +89,7 @@ bool createUserEnv(EvalState &amp; state, DrvInfos &amp; elems,
</span><span class=gu></span>
         // Copy the meta attributes.
         Value &amp; vMeta = *state.allocAttr(v, state.sMeta);
<span class=gd>-        state.mkAttrs(vMeta, 16);
</span><span class=gd>-        StringSet metaNames = i.queryMetaNames();
</span><span class=gd></span><span class=gi>+        state.mkAttrs(vMeta, metaNames.size());
</span><span class=gi></span>         for (auto &amp; j : metaNames) {
             Value * v = i.queryMeta(j);
             if (!v) continue;
</code></pre></div><p>But when I look at the mercurial package, I can see… well, that it’s constructed with <code>python3Packages.buildPythonApplication</code>. I trace that definition to <code>pkgs/top-level/python-packages.nix</code>:</p>
<pre tabindex=0><code>buildPythonApplication = makeOverridablePythonPackage ( makeOverridable (callPackage ../development/interpreters/python/mk-python-derivation.nix {
    namePrefix = "";        # Python applications should not have any prefix
    toPythonModule = x: x;  # Application does not provide modules.
  }));
</code></pre><p>Alright, you know what, let’s just ask <code>nix repl</code>.</p>
<pre tabindex=0><code>nix-repl&gt; (import &lt;nixpkgs&gt; {}).mercurial.outputs
[ "out" ]
</code></pre><p>So, okay. My theory doesn’t hold up.</p>
<p>Let’s just look at the PR for this commit. I bet it describes the issue.</p>
<p><a href=https://github.com/NixOS/nix/pull/4411>https://github.com/NixOS/nix/pull/4411</a></p>
<p>Aha. Too many outputs might have triggered an assertion failure, but in this case we’re hitting the “too many meta attributes,” which also has a hardcoded capacity. I imagine once upon a time there was some fixed set of meta attributes… or something… I dunno. It’s just a bug.</p>
<pre tabindex=0><code>nix-repl&gt; builtins.length (builtins.attrNames (import &lt;nixpkgs&gt; {}).mercurial.meta)
17
</code></pre><p>Anyway, this was merged into <code>master</code> about 3.5 months ago. I was hoping that by pulling up the PR I would see the associated test case, but… nope. Not a thing.</p>
<p>I like test cases. I wonder how I could write one to demonstrate this bug.</p>
<p>But first off: let’s see if I can backport this patch on my laptop, as that would be a lot more convenient. The macOS build probably wasn’t broken when <code>2.3.10</code> was cut, right?</p>
<pre tabindex=0><code>$ git checkout 2.3.10
Note: switching to '2.3.10'.

$ nix-build release.nix -A build.x86_64-darwin
...
configure: error: in `/private/tmp/nix-build-nix-tarball-2.3.10pre7057_8803753.drv-0/source':
configure: error: C compiler cannot create executables
See `config.log' for more details
build time elapsed:  0m1.078s 0m1.279s 0m8.135s 0m4.238s
builder for '/nix/store/nvbvw12ymdqvqbld2fhc7nzb1arpw6hq-nix-tarball-2.3.10pre7057_8803753.drv' failed with exit code 77
cannot build derivation '/nix/store/h61w59q5xf3gzqsg9s006vzbfqapfdjb-nix-2.3.10pre7057_8803753.drv': 1 dependencies couldn't be built
error: build of '/nix/store/h61w59q5xf3gzqsg9s006vzbfqapfdjb-nix-2.3.10pre7057_8803753.drv' failed
</code></pre><p>Sigh. ‘Kay.</p>
<p>Alright. I look around for tests. There is a directory called <code>tests/</code>. It looks like this:</p>
<pre tabindex=0><code>$ ls tests
add.sh                      binary-cache.sh             brotli.sh
build-dry.sh                build-hook.nix              build-remote.sh
case-hack.sh                case.nar                    check-refs.nix
check-refs.sh               check-reqs.nix              check-reqs.sh
check.nix                   check.sh                    common.sh.in
config.nix                  dependencies.builder0.sh    dependencies.builder1.sh
dependencies.builder2.sh    dependencies.nix            dependencies.sh
dump-db.sh                  export-graph.nix            export-graph.sh
export.sh                   fetchGit.sh                 fetchMercurial.sh
fetchurl.sh                 filter-source.nix           filter-source.sh
fixed.builder1.sh           fixed.builder2.sh           fixed.nix
fixed.sh                    function-trace.sh*          gc-auto.sh
gc-concurrent.builder.sh    gc-concurrent.nix           gc-concurrent.sh
gc-concurrent2.builder.sh   gc-runtime.nix              gc-runtime.sh
gc.sh                       hash-check.nix              hash.sh
import-derivation.nix       import-derivation.sh        init.sh
install-darwin.sh*          lang/                       lang.sh
linux-sandbox.sh            local.mk                    logging.sh
misc.sh                     multiple-outputs.nix        multiple-outputs.sh
nar-access.nix              nar-access.sh               nix-build.sh
nix-channel.sh              nix-copy-closure.nix        nix-copy-ssh.sh
nix-profile.sh              nix-shell.sh                optimise-store.sh
parallel.builder.sh         parallel.nix                parallel.sh
pass-as-file.sh             placeholders.sh             plugins/
plugins.sh                  post-hook.sh                pure-eval.nix
pure-eval.sh                push-to-store.sh*           referrers.sh
remote-builds.nix           remote-store.sh             repair.sh
restricted.nix              restricted.sh               run.nix
run.sh                      search.nix                  search.sh
secure-drv-outputs.nix      secure-drv-outputs.sh       setuid.nix
shell.nix                   shell.shebang.rb            shell.shebang.sh*
signing.sh                  simple.builder.sh           simple.nix
simple.sh                   structured-attrs.nix        structured-attrs.sh
tarball.sh                  timeout.nix                 timeout.sh
user-envs.builder.sh        user-envs.nix               user-envs.sh
</code></pre><p>Jinkies.</p>
<p>Let’s see… <code>user-envs.sh</code> seems to contain the tests for <code>nix-env</code>, and uses this simple file as Nixpkgs to install:</p>
<pre><code>$ cat user-envs.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=c1># Some dummy arguments...</span>
<span class=p>{</span> <span class=n>foo</span> <span class=o>?</span> <span class=s2>"foo"</span>
<span class=p>}:</span>

<span class=k>with</span> <span class=kn>import</span> <span class=sr>./config.nix</span><span class=p>;</span>

<span class=k>assert</span> <span class=n>foo</span> <span class=o>==</span> <span class=s2>"foo"</span><span class=p>;</span>

<span class=k>let</span>

  <span class=n>makeDrv</span> <span class=o>=</span> <span class=n>name</span><span class=p>:</span> <span class=n>progName</span><span class=p>:</span> <span class=p>(</span><span class=n>mkDerivation</span> <span class=p>{</span>
    <span class=k>inherit</span> <span class=n>name</span> <span class=n>progName</span> <span class=n>system</span><span class=p>;</span>
    <span class=n>builder</span> <span class=o>=</span> <span class=sr>./user-envs.builder.sh</span><span class=p>;</span>
  <span class=p>}</span> <span class=o>//</span> <span class=p>{</span>
    <span class=n>meta</span> <span class=o>=</span> <span class=p>{</span>
      <span class=n>description</span> <span class=o>=</span> <span class=s2>"A silly test package"</span><span class=p>;</span>
    <span class=p>};</span>
  <span class=p>});</span>

<span class=k>in</span>

  <span class=p>[</span>
    <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-1.0"</span> <span class=s2>"foo"</span><span class=p>)</span>
    <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-2.0pre1"</span> <span class=s2>"foo"</span><span class=p>)</span>
    <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"bar-0.1"</span> <span class=s2>"bar"</span><span class=p>)</span>
    <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-2.0"</span> <span class=s2>"foo"</span><span class=p>)</span>
    <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"bar-0.1.1"</span> <span class=s2>"bar"</span><span class=p>)</span>
    <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-0.1"</span> <span class=s2>"foo"</span> <span class=o>//</span> <span class=p>{</span> <span class=n>meta</span><span class=o>.</span><span class=n>priority</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span> <span class=p>})</span>
  <span class=p>]</span>
</code></pre></div><p>And here’s an example of a test case that uses it, from <code>user-envs.sh</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># Installing "*" should install one foo and one bar.</span>
nix-env -e <span class=s1>'*'</span>
nix-env -i <span class=s1>'*'</span>
<span class=nb>test</span> <span class=s2>"</span><span class=k>$(</span>nix-env -q <span class=s1>'*'</span> <span class=p>|</span> wc -l<span class=k>)</span><span class=s2>"</span> -eq <span class=m>2</span>
nix-env -q <span class=s1>'*'</span> <span class=p>|</span> grep -q foo-2.0
nix-env -q <span class=s1>'*'</span> <span class=p>|</span> grep -q bar-0.1.1
</code></pre></div><p>Alright. Very straightforward.</p>
<p>I just have to say that this is exactly the sort of thing that Mercurial’s <a href=https://www.mercurial-scm.org/wiki/WritingTests>“unified tests”</a> were made for. Basically instead of writing the above, you’d write something like this:</p>
<pre tabindex=0><code class=language-cram data-lang=cram>Installing "*" should install one foo and one bar.

  $ nix-env -e '*' &gt;dev/null
  $ nix-env -i '*' &gt;dev/null
  $ nix-env -q '*'
  foo-2.0
  bar-0.1.1
</code></pre><p>And when your tests fail, you get much better output – just the diff between expected and actual. At my last job <a href=https://blog.janestreet.com/testing-with-expectations/><em>all</em> tests were written this way</a> – not just tests for command-line tools – and I am extremely spoiled by it. It’s the best way to test that I have ever encountered. Being able to just “observe” properties of your code and witness variations from the expected behavior as normal diffs is just… it’s so life-changingly good. <a href=https://ianthehenry.com/posts/janet-game/judging-janet/>I could wax poetic for hours</a>.</p>
<p><em>Anyway</em> obviously we are not going to change Nix’s testing infrastructure because I happen to like another way of doing things. And honestly the only generic implementation I’ve used of this idea – <a href=https://bitheap.org/cram/>cram</a> – was kind of a nightmare in practice in a lot of ways that were entirely my fault. So I don’t realistically know… anything. I’m just rambling now.</p>
<p>The point of all of this is: I don’t see any sorts of regression tests here. Seems like it only tests for basic functionality: Nix doesn’t seem to be a project that proves the validity of each bug fix with a failing-to-passing test case. (As I already guessed from the above patch that contained no tests.)</p>
<p>But that doesn’t mean I’m not going to write one for myself.</p>
<p>Man, how do I just run tests? The command appears to be <code>make installcheck</code>, but that don’t work:</p>
<pre tabindex=0><code>claudius $ make installcheck
  GEN    Makefile.config
/bin/sh: ./config.status: No such file or directory
  GEN    tests/common.sh
/bin/sh: ./config.status: No such file or directory
make: *** [mk/templates.mk:17: tests/common.sh] Error 127
</code></pre><p>Hmm. Doesn’t work from a <code>nix-shell</code>, either. I guess I need to go through the whole rigmarole in my <code>nix-shell</code>. Not sure why it’s not caching things or whatever from my <code>nix-build</code>… I feel like it should? I don’t know. I don’t know what <code>nix-build release.nix</code> does anyway.</p>
<p>But alright. I’m in a <code>nix-shell</code>. I ran all of the individual build steps. I <code>make installcheck</code> and…</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ make installcheck
running test tests/init.sh... [PASS]
running test tests/hash.sh... [PASS]
...many similar lines omitted....
running test tests/function-trace.sh... [PASS]
All tests succeeded
</code></pre><p>Well that’s a relief. I’m not sure how to just run the <code>user-envs</code> test… so I tweak the <code>tests/local.mk</code> file and comment out everything else. Probably fine, right?</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ make installcheck
running test tests/user-envs.sh... [PASS]
All tests succeeded
</code></pre><p>Excellent. I add a couple of “bad” derivations to <code>tests/user-envs.nix</code>, such that it now contains:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>[</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-1.0"</span> <span class=s2>"foo"</span><span class=p>)</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-2.0pre1"</span> <span class=s2>"foo"</span><span class=p>)</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"bar-0.1"</span> <span class=s2>"bar"</span><span class=p>)</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-2.0"</span> <span class=s2>"foo"</span><span class=p>)</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"bar-0.1.1"</span> <span class=s2>"bar"</span><span class=p>)</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"foo-0.1"</span> <span class=s2>"foo"</span> <span class=o>//</span> <span class=p>{</span> <span class=n>meta</span><span class=o>.</span><span class=n>priority</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span> <span class=p>})</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"many-outputs-0.1"</span> <span class=s2>"many-outputs"</span> <span class=o>//</span> <span class=p>{</span>
    <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span>
      <span class=s2>"a"</span> <span class=s2>"b"</span> <span class=s2>"c"</span> <span class=s2>"d"</span> <span class=s2>"e"</span> <span class=s2>"f"</span> <span class=s2>"g"</span> <span class=s2>"h"</span> <span class=s2>"i"</span> <span class=s2>"j"</span> <span class=s2>"k"</span> <span class=s2>"l"</span> <span class=s2>"m"</span>
      <span class=s2>"n"</span> <span class=s2>"o"</span> <span class=s2>"p"</span> <span class=s2>"q"</span> <span class=s2>"r"</span> <span class=s2>"s"</span> <span class=s2>"t"</span> <span class=s2>"u"</span> <span class=s2>"v"</span> <span class=s2>"w"</span> <span class=s2>"x"</span> <span class=s2>"y"</span> <span class=s2>"z"</span>
    <span class=p>];</span>
  <span class=p>})</span>
  <span class=p>(</span><span class=n>makeDrv</span> <span class=s2>"many-meta-fields-0.1"</span> <span class=s2>"many-meta-fields"</span> <span class=o>//</span> <span class=p>{</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>b</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>c</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>d</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>e</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>g</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>h</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>k</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>l</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>m</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>n</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>o</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>q</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>r</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>s</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>t</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>u</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>v</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>w</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>meta</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>})</span>
<span class=p>]</span>
</code></pre></div><p>Interesting to see that <code>attrs // { foo.bar = 1 }</code> syntax (I stole it from the existing <code>// { meta.priority = 10; }</code> expression). Is this something that’s only allowed in an update operation? No; that would be crazy. It’s probably implicitly creating an empty set? I don’t remember anything in the manual about this. Let’s see:</p>
<pre tabindex=0><code>$ nix repl
Welcome to Nix version 2.3.10. Type :? for help.

nix-repl&gt; { foo = 1 }
error: syntax error, unexpected '}', expecting ';', at (string):1:10

nix-repl&gt; { foo = 1; }
{ foo = 1; }

nix-repl&gt; { foo.bar = 1; }
{ foo = { ... }; }

nix-repl&gt; :p { foo.bar = 1; }
{ foo = { bar = 1; }; }

nix-repl&gt; :p { foo.bar = 1; foo.baz = 2; }
{ foo = { bar = 1; baz = 2; }; }

nix-repl&gt; :p { foo = { x = 1; }; foo.bar = 2; }
{ foo = { bar = 2; x = 1; }; }
</code></pre><p>Okay cool. Works the way I’d expect.</p>
<p>Far <em>more interesting</em> is that we’re using <code>//</code> when the left-hand side is a <em>derivation</em>. So… derivations are just sets? Is that… a thing? Or is <code>//</code> overloaded?</p>
<p>Let’s see.</p>
<pre tabindex=0><code>nix-repl&gt; (import &lt;nixpkgs&gt; {}).mercurial
«derivation /nix/store/jdn30bqb7k2ycjbw0653ryzfr38gvwkd-mercurial-5.6.drv»

nix-repl&gt; :p (import &lt;nixpkgs&gt; {}).mercurial
«derivation /nix/store/jdn30bqb7k2ycjbw0653ryzfr38gvwkd-mercurial-5.6.drv»
</code></pre><p>I had sort of used this derivation as a set before, when I checked the number of outputs, but I didn’t really think about the fact that I was doing something weird, that I was dealing with this strange opaque thing.</p>
<pre tabindex=0><code>nix-repl&gt; (import &lt;nixpkgs&gt; {}).mercurial // { name = "capricious"; }
«derivation /nix/store/jdn30bqb7k2ycjbw0653ryzfr38gvwkd-mercurial-5.6.drv»
</code></pre><p>Hmm.</p>
<pre tabindex=0><code>nix-repl&gt; ((import &lt;nixpkgs&gt; {}).mercurial // { name = "capricious"; }).name
"capricious"

nix-repl&gt; ((import &lt;nixpkgs&gt; {}).mercurial // { name = "capricious"; }).pname
"mercurial"

nix-repl&gt; (import &lt;nixpkgs&gt; {}).mercurial // { name = "capricious"; pname = "capricious"; version = "6.0"; }
«derivation /nix/store/jdn30bqb7k2ycjbw0653ryzfr38gvwkd-mercurial-5.6.drv»
</code></pre><p>Okay; I have no idea. Gotta come back to that later.</p>
<p>Let’s run tests.</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ make installcheck
running test tests/user-envs.sh... [FAIL]
    + '[' -z '' ']'
    + clearStore
    + echo 'clearing store...'
    clearing store...
    + chmod -R +w /run/user/1000/nix-test/store
    + rm -rf /run/user/1000/nix-test/store
    + mkdir /run/user/1000/nix-test/store
    + rm -rf /run/user/1000/nix-test/var/nix
    + mkdir /run/user/1000/nix-test/var/nix
    + nix-store --init
    + clearProfiles
    + profiles=/run/user/1000/nix-test/var/nix/profiles
    + rm -rf /run/user/1000/nix-test/var/nix/profiles
    + clearProfiles
    + profiles=/run/user/1000/nix-test/var/nix/profiles
    + rm -rf /run/user/1000/nix-test/var/nix/profiles
    ++ nix-env -p /run/user/1000/nix-test/var/nix/profiles/test -q '*'
    ++ wc -l
    + test 0 -eq 0
    + mkdir -p /run/user/1000/nix-test/test-home
    + nix-env --switch-profile /run/user/1000/nix-test/var/nix/profiles/test
    ++ wc -l
    ++ nix-env -f ./user-envs.nix -qa '*'
    + test 8 -eq 6
1 out of 1 tests failed
make: *** [mk/tests.mk:12: installcheck] Error 1
</code></pre><p>Certainly not as nice as a diff, but the output makes it <em>pretty clear</em> what’s going on. I update that <code>6</code> to an <code>8</code> and re-run…</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ make installcheck
claudius $ make installcheck
running test tests/user-envs.sh... [FAIL]
    + '[' -z '' ']'
    ...tons of output elided...
    installing 'many-meta-fields-0.1'
    installing 'many-outputs-0.1'
    these derivations will be built:
      /run/user/1000/nix-test/store/cz09h8w2n7zhmydxqzrr313imzw2fbvr-many-meta-fields-0.1.drv
      /run/user/1000/nix-test/store/d07hf54kxndnsgcxk6a4iyf2am63nq66-bar-0.1.1.drv
      /run/user/1000/nix-test/store/hawd6dykvyb2i94pw03pg0fg5k7wx04y-many-outputs-0.1.drv
    building '/run/user/1000/nix-test/store/d07hf54kxndnsgcxk6a4iyf2am63nq66-bar-0.1.1.drv'...
    building '/run/user/1000/nix-test/store/cz09h8w2n7zhmydxqzrr313imzw2fbvr-many-meta-fields-0.1.drv'...
    building '/run/user/1000/nix-test/store/hawd6dykvyb2i94pw03pg0fg5k7wx04y-many-outputs-0.1.drv'...
    nix-env: src/libexpr/attr-set.hh:54: void nix::Bindings::push_back(const nix::Attr&amp;): Assertion `size_ &lt; capacity_' failed.
    user-envs.sh: line 163: 17503 Aborted                 (core dumped) nix-env -i '*'
1 out of 1 tests failed
make: *** [mk/tests.mk:12: installcheck] Error 1
</code></pre><p>Great! Okay. That was all it took to tickle the bug. Now let’s try to cherry-pick the fix…</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ git stash
Saved working directory and index state WIP on (no branch): 880375366 Merge pull request #4374 from NixOS/2.3-absolute-url-in-binary-caches

[nix-shell:~/src/nix]$ git checkout -b backport-user-env-assertion-fix
Switched to a new branch 'backport-user-env-assertion-fix'

[nix-shell:~/src/nix]$ git cherry-pick d27eb0ef5
[backport-user-env-assertion-fix 2fe57daad] Fix insufficent attribute capacity in user profile
 Author: David McFarland
 Date: Wed Dec 30 16:20:03 2020 -0400
 1 file changed, 4 insertions(+), 4 deletions(-)
</code></pre><p>Well… that was a lot easier than I expected it to be.</p>
<p>I recompile, reinstall, and re-run my test.</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ make -j $NIX_BUILD_CORES
  CXX    src/nix-env/user-env.o
  LD     src/nix/nix

[nix-shell:~/src/nix]$ make install
  LD     /home/ian/src/nix/outputs/out/bin/nix

[nix-shell:~/src/nix]$ git stash pop
On branch backport-user-env-assertion-fix
... blah blah blah ...
Dropped refs/stash@{0} (6a9a703177db41f7ca275e3adf11c82df4f8e732)

[nix-shell:~/src/nix]$ make installcheck
running test tests/user-envs.sh... [FAIL]
    + '[' -z '' ']'
    ... elided ...
    created 4 symlinks in user environment
    ++ wc -l
    ++ nix-env -q '*'
    + test 4 -eq 2
1 out of 1 tests failed
make: *** [mk/tests.mk:12: installcheck] Error 1
</code></pre><p>Excellent. That’s actually the test I quoted above – the one that runs <code>nix-env -i '*'</code> and checks that <code>foo</code> and <code>bar</code> get installed. But of course now <code>foo</code>, <code>bar</code>, <code>many-outputs</code>, and <code>many-meta-fields</code> all get installed. I change that <code>2</code> to a <code>4</code> and re-run:</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ make installcheck
running test tests/user-envs.sh... [PASS]
All tests succeeded
</code></pre><p>Alright! Nice and easy. I’ve already forked Nix on GitHub, so:</p>
<pre tabindex=0><code>[nix-shell:~/src/nix]$ git remote rename origin upstream

[nix-shell:~/src/nix]$ git remote add origin git@github.com:ianthehenry/nix.git

[nix-shell:~/src/nix]$ git push --set-upstream origin backport-user-env-assertion-fix
</code></pre><p>And now I have to go into a web browser to finish the process: opening <a href=https://github.com/NixOS/nix/pull/4634>my first Nix pull request</a>. I wrote <em>zero code</em> and it took me <em>less than a calendar week</em>. Wow.</p>
<p>Okay. Man. I don’t think I can keep a diary of any future debugging. It is… slow. Somehow writing down everything I do and everything I think is slowing me down. Weird how that works.</p>
<p>I bet if I were really good at emacs I could set up some kind of fancy literate blog posting mode that would make this natural and easy. But instead I’m actually copying and pasting things into this markdown file. It takes its toll.</p>
<hr>
<ul>
<li>How do I <code>--keep-failed</code> with <code>nix build</code>?</li>
<li>What’s the difference between <code>nix build</code> and <code>nix-build</code>?</li>
<li>What is the not terribly gross way to run <code>nix-shell -p</code> with a package from a custom channel (i.e. without renaming it to <code>"nixpkgs"</code>)</li>
<li>Can I run Nix tests after <code>nix-build</code> without doing a full rebuild from <code>nix-shell</code>?</li>
<li>Are derivations sets or not? Why do they print differently? What makes them different or special or magical?</li>
</ul>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>As I do an editing pass over this post before publication, I feel the need to point out that I <em>actually did</em> write this before I tried to do anything, and before I had any idea what was about to happen to me.&nbsp;<a href=#fnref:1 class=footnote-backref role=doc-backlink>↩︎</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p>Alas. If only I had followed through on this thought… I could have saved myself a lot of time.&nbsp;<a href=#fnref:2 class=footnote-backref role=doc-backlink>↩︎</a></p>
</li>
</ol>
</section></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22My%20first%20Nix%20bug%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>Next up ➜ My first package upgrade</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
