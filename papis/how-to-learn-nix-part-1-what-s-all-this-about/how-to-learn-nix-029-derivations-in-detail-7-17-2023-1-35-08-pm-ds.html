<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/ 
 saved date: Mon Jul 17 2023 13:35:08 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 29: Derivations in detail</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}aside.warning{background-color:var(--aside-warning-bg);color:var(--aside-warning-fg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight,main div.highlight+pre{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .c1{color:var(--palette-dim)}.highlight .kn{color:var(--palette-teal)}.highlight .m{color:var(--palette-orange)}.highlight .nb{color:var(--palette-text)}.highlight .no{color:var(--palette-red)}.highlight .nv{color:var(--palette-red)}.highlight .mi{color:var(--palette-orange)}.highlight .s2{color:var(--palette-green)}.highlight .sr{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 29: Derivations in detail">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>
<meta name=description content="The next few chapters take place in the standard environment “part,” but we have left the standard environment “chapter.” I suppose that that these are details only relevant to stdenv.mkDerivation? Or I shouldn’t read too much into the grouping here.">
<meta property=og:description content="The next few chapters take place in the standard environment “part,” but we have left the standard environment “chapter.” I suppose that that these are details only relevant to stdenv.mkDerivation? Or I shouldn’t read too much into the grouping here.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-04-20>April 20, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>How to Learn Nix, Part&nbsp;29:<br>Derivations in detail</a></h1>
</div>
<div class=post-content><p>The next few chapters take place in the standard environment “part,” but we have left the standard environment “chapter.” I suppose that that these are details only relevant to <code>stdenv.mkDerivation</code>? Or I shouldn’t read too much into the grouping here.</p>
<h1 id=chapter-7-meta-attributeshttpswebarchiveorgweb20210318102415if_httpsnixosorgmanualnixpkgsstablechap-meta><a href=https://web.archive.org/web/20210318102415if_/https://nixos.org/manual/nixpkgs/stable/#chap-meta>Chapter 7. Meta-attributes</a></h1>
<p>We learn that <code>meta</code> attributes are not passed to the derivation’s builder, and thus they do not trigger a rebuild when they change. So that’s nice. It would be pretty annoying if changing the <code>maintainer</code> caused the hash of a package to change.</p>
<p>We already learned about <code>passthru</code>, whose attributes are also not passed along to the derivation, but which are slightly different than <code>meta</code> in that <code>passthru</code> attributes still wind up attached to the top-level derivation. <code>meta</code> attributes get no such treatment:</p>
<pre tabindex=0><code>nix-repl&gt; pkgs.mercurial.maintainers
error: attribute 'maintainers' missing, at (string):1:1

nix-repl&gt; pkgs.mercurial.meta.maintainers
[ { ... } ]
</code></pre><p>Nixpkgs teaches us the <code>--json</code> flag to <code>nix-env -q</code>. That’s something we <a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>discovered for ourselves</a>, way back in the day. No mention of the apparently-vestigial <code>--meta</code> flag.</p>
<p>Then we see a list of “expected” <code>meta</code> attributes.</p>
<pre tabindex=0><code>description
longDescription
branch
homepage
downloadPage
changelog
license
maintainers
priority
platforms
tests
timeout
hydraPlatforms
broken
updateWalker
</code></pre><p>Mostly very straightforward. <code>priority</code> is bad and unnecessary and it should feel bad. But we don’t really have to use it.</p>
<p><code>tests</code> is weird because it’s <em>not</em> <code>meta.tests</code>, it’s <code>passthru.tests</code>, but for some reason it’s documented here, as a “meta attribute,” instead of documented when we learned about <code>passthru</code>. So.</p>
<p><code>timeout</code> seems like… a weird thing to be here. Who respects <code>timeout</code>? <em>All</em> Nix operations? I hope not. I hope that’s only, like, a CI thing.</p>
<pre><code>$ cat sleeper.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span>

<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"timeout-tester-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./sleeper.sh</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><pre><code>$ cat sleeper.sh
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nb>source</span> <span class=nv>$stdenv</span>/setup

sleep <span class=m>5</span>

<span class=nb>echo</span> <span class=s2>"hi"</span> &gt; <span class=s2>"</span><span class=nv>$out</span><span class=s2>"</span>
</code></pre></div><pre tabindex=0><code>$ nix-build sleeper.nix
these derivations will be built:
  /nix/store/whgkpqbpm9mzzknvdbkd8xinx7akrl2r-timeout-tester-1.0.drv
building '/nix/store/whgkpqbpm9mzzknvdbkd8xinx7akrl2r-timeout-tester-1.0.drv'...
/nix/store/lnd1qc1liv7bcr505kz3hpccgvyfx80c-timeout-tester-1.0
</code></pre><p>Okay. That works. But when I add a timeout:</p>
<pre><code>$ cat sleeper.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span>

<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"timeout-tester-1.0"</span><span class=p>;</span>
  <span class=n>builder</span> <span class=o>=</span> <span class=sr>./sleeper.sh</span><span class=p>;</span>
  <span class=n>meta</span> <span class=o>=</span> <span class=p>{</span> <span class=n>timeout</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix-build sleeper.nix
/nix/store/lnd1qc1liv7bcr505kz3hpccgvyfx80c-timeout-tester-1.0
</code></pre><p>Er, right. Changing meta attributes doesn’t change the hash, so the package is the same…</p>
<pre tabindex=0><code>$ rm result

$ nix-store --delete /nix/store/lnd1qc1liv7bcr505kz3hpccgvyfx80c-timeout-tester-1.0
finding garbage collector roots...
removing stale link from '/nix/var/nix/gcroots/auto/qqrfq5975mbpf5p9xpsqwhfpyj7q5jkk' to '/Users/ian/scratch/result'
...
1 store paths deleted, 0.00 MiB freed
</code></pre><p>Second time’s the charm…</p>
<pre tabindex=0><code>$ nix-build sleeper.nix                                             these derivations will be built:
  /nix/store/whgkpqbpm9mzzknvdbkd8xinx7akrl2r-timeout-tester-1.0.drv
building '/nix/store/whgkpqbpm9mzzknvdbkd8xinx7akrl2r-timeout-tester-1.0.drv'...
/nix/store/lnd1qc1liv7bcr505kz3hpccgvyfx80c-timeout-tester-1.0
</code></pre><p>Okay. So this value is not magic to Nix. This is something that certain systems – I’m guessing just Hydra – can choose to look at.</p>
<p><code>hydraPlatforms</code> says:</p>
<blockquote>
<p>The list of Nix platform types for which the Hydra instance at <code>hydra.nixos.org</code> will build the package. (Hydra is the Nix-based continuous build system.) It defaults to the value of <code>meta.platforms</code>. Thus, the only reason to set <code>meta.hydraPlatforms</code> is if you want <code>hydra.nixos.org</code> to build the package on a subset of <code>meta.platforms</code>, or not at all.</p>
</blockquote>
<p>In my head “Hydra” means “the thing that populates cache.nixos.org.” But I don’t really know <em>why</em> I think that. Maybe it isn’t? Maybe it’s really just a piece of test infrastructure? I hope that the manual will go into that a bit, eventually.</p>
<p><code>updateWalker</code> is the last interesting one – it’s only relevant to a script called <code>update-walker.sh</code>, which appears to exist to automate version bumping of packages.</p>
<p>Lastly the chapter talks about different “generic” licenses to use if you don’t know the actual license a package is available under (?). I don’t know why you would ever do that. Nothing too interesting here.</p>
<h1 id=chapter-8-multiple-output-packageshttpswebarchiveorgweb20210318102415if_httpsnixosorgmanualnixpkgsstablechap-multiple-output><a href=https://web.archive.org/web/20210318102415if_/https://nixos.org/manual/nixpkgs/stable/#chap-multiple-output>Chapter 8. Multiple-output packages</a></h1>
<p>We already know that a derivation can specify multiple outputs. Now we learn why:</p>
<blockquote>
<p>The main motivation is to save disk space by reducing runtime closure sizes; consequently also sizes of substituted binaries get reduced. Splitting can be used to have more granular runtime dependencies, for example the typical reduction is to split away development-only files, as those are typically not needed during runtime. As a result, closure sizes of many packages can get reduced to a half or even much less.</p>
</blockquote>
<p>Hmm. Okay. I can definitely understand, like, “I depend on <code>perl</code> but I don’t depend on the <code>perl</code> man pages,” or something. I don’t really understand why “development-only files” would be included in the first place. I feel like I don’t really understand the distinction between runtime and build-time dependencies in Nix.</p>
<blockquote>
<p>The attribute <code>meta.outputsToInstall</code> is used to determine the default set of outputs to install when using the derivation name unqualified.</p>
</blockquote>
<p>That seems like kind of an important <code>meta</code> field! Maybe it could have been documented in the section about meta fields, that we just read?</p>
<p>I remember from my testing that this defaulted to the first entry in the <code>output</code> list. But that does not appear to be the case. The manual links directly to the source:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=c1># If the packager hasn't specified `outputsToInstall`, choose a default,</span>
<span class=c1># which is the name of `p.bin or p.out or p`;</span>
<span class=c1># if he has specified it, it will be overridden below in `// meta`.</span>
<span class=c1>#   Note: This default probably shouldn't be globally configurable.</span>
<span class=c1>#   Services and users should specify outputs explicitly,</span>
<span class=c1>#   unless they are comfortable with this default.</span>
<span class=n>outputsToInstall</span> <span class=err>=</span>
  <span class=k>let</span>
    <span class=n>hasOutput</span> <span class=o>=</span> <span class=n>out</span><span class=p>:</span> <span class=nb>builtins</span><span class=o>.</span><span class=n>elem</span> <span class=n>out</span> <span class=n>outputs</span><span class=p>;</span>
  <span class=k>in</span> <span class=p>[(</span> <span class=n>lib</span><span class=o>.</span><span class=n>findFirst</span> <span class=n>hasOutput</span> <span class=no>null</span> <span class=p>([</span><span class=s2>"bin"</span> <span class=s2>"out"</span><span class=p>]</span> <span class=o>++</span> <span class=n>outputs</span><span class=p>)</span> <span class=p>)]</span>
    <span class=o>++</span> <span class=n>lib</span><span class=o>.</span><span class=n>optional</span> <span class=p>(</span><span class=n>hasOutput</span> <span class=s2>"man"</span><span class=p>)</span> <span class=s2>"man"</span><span class=p>;</span>
</code></pre></div><p>As a native English speaker, it feels very jarring to see a gendered pronoun applied to “the packager.” I had to re-read that a couple times before I parsed it; the strange line break after the semicolon didn’t help.</p>
<p>Anyway, it seems that I remembered incorrectly. Interesting that you can specify a <code>bin</code> output and it will take precedence over the default output name <code>out</code>.</p>
<p>There’s a little bit about NixOS here that I don’t really understand; I skipped it. Then we get:</p>
<blockquote>
<p><code>nix-env</code> lacks an easy way to select the outputs to install. When installing a package, <code>nix-env</code> always installs the outputs listed in <code>meta.outputsToInstall</code>, even when the user explicitly selects an output.</p>
<aside class=warning>
<p><code>nix-env</code> silenty disregards the outputs selected by the user, and instead installs the outputs from <code>meta.outputsToInstall</code>. For example,</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.coreutils.info
</code></pre><p>installs the <code>"out"</code> output (<code>coreutils.meta.outputsToInstall</code> is <code>[ "out" ]</code>) instead of the requested <code>"info"</code>.</p>
</aside>
</blockquote>
<p>Well I’ll be darned. It then says that the only way to actually install specific outputs is to add an overlay that changes that meta attribute.</p>
<p>But hang on! I remember a weird meta-specific override facility hidden deep in the <a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Nix command reference</a>. I couldn’t really come up with a decent use-case for it at the time. But could I use that to change the outputs that <code>nix-env</code> installs? That seems like exactly what this might be useful for.</p>
<p>Let’s test it. We’ll use <code>coreutils</code>, as we did already:</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.coreutils.info -p ~/scratch/profile
installing 'coreutils-8.32'
building '/nix/store/8z1s1xm3b3ljy5mkw30r216n9197mcjs-user-environment.drv'...
created 2 symlinks in user environment

$ tree -l ~/scratch/profile/
/Users/ian/scratch/profile
├── bin -&gt; /nix/store/cpvjym13fdglv6zmdr5xav20g5rbafbx-coreutils-8.32/bin
│   ├── [ -&gt; coreutils
│   ├── b2sum -&gt; coreutils
│   ├── base32 -&gt; coreutils
│   ├── base64 -&gt; coreutils
│   ├── basename -&gt; coreutils
│   ├── basenc -&gt; coreutils
│   ├── cat -&gt; coreutils
│   ├── chcon -&gt; coreutils
│   ├── chgrp -&gt; coreutils
│   ├── chmod -&gt; coreutils
│   ├── chown -&gt; coreutils
│   ├── chroot -&gt; coreutils
│   ├── cksum -&gt; coreutils
│   ├── comm -&gt; coreutils
│   ├── coreutils
│   ├── cp -&gt; coreutils
│   ├── csplit -&gt; coreutils
│   ├── cut -&gt; coreutils
│   ├── date -&gt; coreutils
│   ├── dd -&gt; coreutils
│   ├── df -&gt; coreutils
│   ├── dir -&gt; coreutils
│   ├── dircolors -&gt; coreutils
│   ├── dirname -&gt; coreutils
│   ├── du -&gt; coreutils
│   ├── echo -&gt; coreutils
│   ├── env -&gt; coreutils
│   ├── expand -&gt; coreutils
│   ├── expr -&gt; coreutils
│   ├── factor -&gt; coreutils
│   ├── false -&gt; coreutils
│   ├── fmt -&gt; coreutils
│   ├── fold -&gt; coreutils
│   ├── groups -&gt; coreutils
│   ├── head -&gt; coreutils
│   ├── hostid -&gt; coreutils
│   ├── id -&gt; coreutils
│   ├── install -&gt; coreutils
│   ├── join -&gt; coreutils
│   ├── kill -&gt; coreutils
│   ├── link -&gt; coreutils
│   ├── ln -&gt; coreutils
│   ├── logname -&gt; coreutils
│   ├── ls -&gt; coreutils
│   ├── md5sum -&gt; coreutils
│   ├── mkdir -&gt; coreutils
│   ├── mkfifo -&gt; coreutils
│   ├── mknod -&gt; coreutils
│   ├── mktemp -&gt; coreutils
│   ├── mv -&gt; coreutils
│   ├── nice -&gt; coreutils
│   ├── nl -&gt; coreutils
│   ├── nohup -&gt; coreutils
│   ├── nproc -&gt; coreutils
│   ├── numfmt -&gt; coreutils
│   ├── od -&gt; coreutils
│   ├── paste -&gt; coreutils
│   ├── pathchk -&gt; coreutils
│   ├── pinky -&gt; coreutils
│   ├── pr -&gt; coreutils
│   ├── printenv -&gt; coreutils
│   ├── printf -&gt; coreutils
│   ├── ptx -&gt; coreutils
│   ├── pwd -&gt; coreutils
│   ├── readlink -&gt; coreutils
│   ├── realpath -&gt; coreutils
│   ├── rm -&gt; coreutils
│   ├── rmdir -&gt; coreutils
│   ├── runcon -&gt; coreutils
│   ├── seq -&gt; coreutils
│   ├── sha1sum -&gt; coreutils
│   ├── sha224sum -&gt; coreutils
│   ├── sha256sum -&gt; coreutils
│   ├── sha384sum -&gt; coreutils
│   ├── sha512sum -&gt; coreutils
│   ├── shred -&gt; coreutils
│   ├── shuf -&gt; coreutils
│   ├── sleep -&gt; coreutils
│   ├── sort -&gt; coreutils
│   ├── split -&gt; coreutils
│   ├── stat -&gt; coreutils
│   ├── stdbuf -&gt; coreutils
│   ├── stty -&gt; coreutils
│   ├── sum -&gt; coreutils
│   ├── sync -&gt; coreutils
│   ├── tac -&gt; coreutils
│   ├── tail -&gt; coreutils
│   ├── tee -&gt; coreutils
│   ├── test -&gt; coreutils
│   ├── timeout -&gt; coreutils
│   ├── touch -&gt; coreutils
│   ├── tr -&gt; coreutils
│   ├── true -&gt; coreutils
│   ├── truncate -&gt; coreutils
│   ├── tsort -&gt; coreutils
│   ├── tty -&gt; coreutils
│   ├── uname -&gt; coreutils
│   ├── unexpand -&gt; coreutils
│   ├── uniq -&gt; coreutils
│   ├── unlink -&gt; coreutils
│   ├── uptime -&gt; coreutils
│   ├── users -&gt; coreutils
│   ├── vdir -&gt; coreutils
│   ├── wc -&gt; coreutils
│   ├── who -&gt; coreutils
│   ├── whoami -&gt; coreutils
│   └── yes -&gt; coreutils
├── libexec -&gt; /nix/store/cpvjym13fdglv6zmdr5xav20g5rbafbx-coreutils-8.32/libexec
│   └── coreutils
│       └── libstdbuf.so
└── manifest.nix -&gt; /nix/store/jsmdf1ik7lqm5ajsrjc7bll5158m167g-env-manifest.nix
</code></pre><p>Indeed: no <code>info</code> pages. But I should be able to use…</p>
<pre tabindex=0><code>$ nix-env --set-flag outputsToInstall '["info"]' coreutils -p ~/scratch/profile
setting flag on 'coreutils-8.32'
error: this derivation has bad 'meta.outputsToInstall'
</code></pre><p>Uhhhh. Well that’s… what? I’m guessing that <code>--set-flag</code> only takes a literal string, doesn’t it. I can’t give it a list. Anyway, it didn’t do anything:</p>
<pre tabindex=0><code>$ nix-env -qaA nixpkgs.coreutils --json -p ~/scratch/profile | jq '."nixpkgs.coreutils".meta.outputsToInstall'
[
  "out"
]
</code></pre><p>Note the annoying nested quoting in that <code>jq</code> expression because the key in the result object is the literal string <code>nixpkgs.coreutils</code>.</p>
<p>So, okay. No. It’s not a thing. Still no idea what the point of <code>--set-flag</code> is.</p>
<p>Alright, the next section is a little dense:</p>
<blockquote>
<p>In the Nix language the individual outputs can be reached explicitly as attributes, e.g. <code>coreutils.info</code>, but the typical case is just using packages as build inputs.</p>
</blockquote>
<p>Okay, sure. Just not if you’re using <code>nix-env</code>. Got it.</p>
<blockquote>
<p>When a multiple-output derivation gets into a build input of another derivation, the <code>dev</code> output is added if it exists, otherwise the first output is added. In addition to that, <code>propagatedBuildOutputs</code> of that package which by default contain <code>$outputBin</code> and <code>$outputLib</code> are also added. (See Section 8.4.2, “File type groups”.)</p>
</blockquote>
<p>Okay. No idea what <code>$outputBin</code> or <code>$outputLib</code> are, but we’ll get to that very soon.</p>
<blockquote>
<p>In some cases it may be desirable to combine different outputs under a single store path. A function <code>symlinkJoin</code> can be used to do this. (Note that it may negate some closure size benefits of using a multiple-output package.)</p>
</blockquote>
<p>Okay. No explanation of that function or how to use it, but ⌘F tells me we’ll get to it in a few more chapters.</p>
<blockquote>
<p>In nixpkgs there is a framework supporting multiple-output derivations. It tries to cover most cases by default behavior. You can find the source separated in &lt;<code>nixpkgs/pkgs/build-support/setup-hooks/multiple-outputs.sh</code>&gt;; it’s relatively well-readable. The whole machinery is triggered by defining the <code>outputs</code> attribute to contain the list of desired output names (strings).</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>outputs</span> <span class=err>=</span> <span class=p>[</span> <span class=s2>"bin"</span> <span class=s2>"dev"</span> <span class=s2>"out"</span> <span class=s2>"doc"</span> <span class=p>];</span>
</code></pre></div></blockquote>
<p>Wait.</p>
<p>This is a <em>Nixpkgs</em> thing?</p>
<p>No. I’ve written a multi-output derivation myself. I didn’t use <code>mkDerivation</code> or anything else. <code>outputs</code> is respected by the <code>builtin.derivation</code> function. Hmm. I don’t understand. Let’s keep going.</p>
<p>I learn that I should <em>usually</em> make the first <code>output</code> the one with the binaries in it, because apparently derivations stringify to the path of their first output, so this lets me write <code>$drv/bin/exe</code>. I learn an exception to this is <code>glibc</code>, whose first output is <code>libs</code>. Because you’re more likely to be referencing a library. Easy enough.</p>
<p>Now we learn about “file type groups.”</p>
<blockquote>
<p>The support code currently recognizes some particular kinds of outputs and either instructs the build system of the package to put files into their desired outputs or it moves the files during the fixup phase. Each group of file types has an <code>outputFoo</code> variable specifying the output name where they should go. If that variable isn’t defined by the derivation writer, it is guessed – a default output name is defined, falling back to other possibilities if the output isn’t defined.</p>
</blockquote>
<p>The manual really doesn’t describe what this means. What are “variables” here? Environment variables? Are these supposed to be derivation attributes? It lists a bunch of examples of the form:</p>
<blockquote>
<p><code>$outputDev</code> is for development-only files. These include C(++) headers, pkg-config, cmake and aclocal files. They go to <code>dev</code> or <code>out</code> by default.</p>
</blockquote>
<p>I don’t know what it means by “they go to <code>dev</code> or <code>out</code> by default.” What does… what?</p>
<blockquote>
<p><code>$outputMan</code> is for man pages (except for section 3). They go to <code>man</code> or <code>$outputBin</code> by default.</p>
</blockquote>
<p>Am I supposed to say, like <code>outputBin = "my-executables";</code> or something? Are aliases for output “roles”? I don’t understand.</p>
<p>I am <em>very suspicious</em>, however, about <code>outputDev</code> and <a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>the error I got back in part 13</a>. Oh, yeah! That’s exactly it – it seems that <code>dev</code> and <code>out</code> are not particularly special. From <code>multiple-outputs.sh</code>:</p>
<pre><code>_overrideFirst outputDev "dev" "out"
_overrideFirst outputBin "bin" "out"
</code></pre>
<p>If I had specified <code>dev</code> (but not <code>out</code>), it would have complained about “<code>bin</code> or <code>out</code>” next. And then <code>lib</code>, and then <code>doc</code>… but by providing an output named <code>out</code>, it’s used as a fallback for every one of these.</p>
<p>And yes, I now see what these things are. These are either shell variables or environment variables that are relevant to the <code>$stdenv/setup.sh</code> script. And it seems I could have avoided those errors by specifying every one of <code>outputDev</code>, <code>outputBin</code>, <code>outputLib</code>, and <code>outputDoc</code> to be the string name of my weird unconventional output, if I’m reading the script correctly.</p>
<p>Neat.</p>
<p>The chapter ends with some “common caveats:” no circular references. Don’t needlessly split things up if depending on one output will cause you to depend on all the other outputs. Nothing too exciting.</p>
<p>And that’s it! Pretty good chapters. Made some things more concrete for me.</p>
<hr>
<ul>
<li>Is Hydra responsible for populating <a href=https://cache.nixos.org/?>https://cache.nixos.org?</a></li>
<li>Does Nix not explicitly distinguish between runtime and build-time dependencies?</li>
<li>If I use an override or an overlay or whatever, does that only affect <code>nix-env</code>? Or does that affect any Nix command?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Derivations%20in%20detail%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Next up ➜ Cross-compilation</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
