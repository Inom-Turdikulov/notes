<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/ 
 saved date: Mon Jul 17 2023 13:35:12 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 41: Ambiguous packages</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}sup{font-size:75%}sup a::before{content:"["}sup a::after{content:"]"}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}.footnotes>ol{margin-top:1em}.footnotes li:not(.highlight){transition:background-color 1s}ul ul{padding-left:2em}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}a.footnote-ref:visited,a.footnote-backref:visited,.notation-help-link-container a:visited{color:var(--link)}main *+p,main *+pre,main *+aside,main *+section,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr{margin-top:1em}main pre+div.highlight,main div.highlight+pre{margin-top:1px}main li>ul:last-child{margin-top:0}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .cm{color:var(--palette-dim)}.highlight .kc{color:var(--palette-purple)}.highlight .no{color:var(--palette-red)}.highlight .nt{color:var(--palette-teal)}.highlight .mi{color:var(--palette-orange)}.highlight .s2{color:var(--palette-green)}.highlight .si{color:var(--palette-orange)}.highlight .sr{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 41: Ambiguous packages">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>
<meta name=description content="I opened a PR a few days ago to try to fix the issue I ran into with nix-env -u trying to upgrade to a weird alpha pre-release version of Python.
In my head, I was making the world a better place. It was an issue that bit me; it was an issue that bit someone who emailed me; it seemed like an issue worth fixing. But the maintainer of Python responded to that PR with:

I don’t think we should be doing this. Yes, it resolves the issue for python3, but there are others out there as well. “It is known” that nix-env -i should not be used.

My gut reaction to that comment was: well, sure, but we shouldn’t let perfect be the enemy of good. python3 is such a common, important package! Who cares if there are some random little packages sprinkled here and there that have the same problem. It’s worth fixing for big packages like Python.
But this person knows a lot more about Nix than I do. And a lot more about Nixpkgs. So if they believe that this is not worth fixing, there is a very good chance that this is not worth fixing, regardless of what my gut has to say about it.
So: let’s find out? Let’s look into this, and figure out how widespread this issue actually is.
I had assumed that it was a rare issue, because python3 is the only problematic package I’ve encountered, and I have quite a few packages installed in my environment at this point. Add to that the fact that it’s a relatively recent problem – introduced some time between NixOS 20.09 and NixOS 21.05 – and it seems like this isn’t typical. python3 is a weird outlier, right?
Let’s find out!">
<meta property=og:description content="I opened a PR a few days ago to try to fix the issue I ran into with nix-env -u trying to upgrade to a weird alpha pre-release version of Python.
In my head, I was making the world a better place. It was an issue that bit me; it was an issue that bit someone who emailed me; it seemed like an issue worth fixing. But the maintainer of Python responded to that PR with:

I don’t think we should be doing this. Yes, it resolves the issue for python3, but there are others out there as well. “It is known” that nix-env -i should not be used.

My gut reaction to that comment was: well, sure, but we shouldn’t let perfect be the enemy of good. python3 is such a common, important package! Who cares if there are some random little packages sprinkled here and there that have the same problem. It’s worth fixing for big packages like Python.
But this person knows a lot more about Nix than I do. And a lot more about Nixpkgs. So if they believe that this is not worth fixing, there is a very good chance that this is not worth fixing, regardless of what my gut has to say about it.
So: let’s find out? Let’s look into this, and figure out how widespread this issue actually is.
I had assumed that it was a rare issue, because python3 is the only problematic package I’ve encountered, and I have quite a few packages installed in my environment at this point. Add to that the fact that it’s a relatively recent problem – introduced some time between NixOS 20.09 and NixOS 21.05 – and it seems like this isn’t typical. python3 is a weird outlier, right?
Let’s find out!">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-06-13>June 13, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>How to Learn Nix, Part&nbsp;41:<br>Ambiguous packages</a></h1>
</div>
<div class=post-content><p>I <a href=https://github.com/NixOS/nixpkgs/pull/126038>opened a PR</a> a few days ago to try to fix the issue I ran into with <code>nix-env -u</code> trying to upgrade to <a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>a weird alpha pre-release version of Python</a>.</p>
<p>In my head, I was making the world a better place. It was an issue that bit me; it was an issue that bit someone who emailed me; it seemed like an issue worth fixing. But the maintainer of Python responded to that PR with:</p>
<blockquote>
<p>I don’t think we should be doing this. Yes, it resolves the issue for <code>python3</code>, but there are others out there as well. “It is known” that <code>nix-env -i</code> should not be used.</p>
</blockquote>
<p>My gut reaction to that comment was: well, sure, but we shouldn’t let perfect be the enemy of good. <code>python3</code> is such a common, important package! Who cares if there are some random little packages sprinkled here and there that have the same problem. It’s worth fixing for <em>big</em> packages like Python.</p>
<p>But this person knows a lot more about Nix than I do. And a <em>lot</em> more about Nixpkgs. So if they believe that this is not worth fixing, there is a very good chance that this is not worth fixing, regardless of what my gut has to say about it.</p>
<p>So: let’s find out? Let’s look into this, and figure out how widespread this issue actually is.</p>
<p>I had <em>assumed</em> that it was a rare issue, because <code>python3</code> is the only problematic package I’ve encountered, and I have quite a few packages installed in my environment at this point. Add to that the fact that it’s a relatively recent problem – introduced some time between NixOS 20.09 and NixOS 21.05 – and it <em>seems</em> like this isn’t typical. <code>python3</code> is a weird outlier, right?</p>
<p>Let’s find out!</p>
<p>So I did. I found out. I did the thing. And, having done the thing, I have changed my tune:</p>
<p><code>python3</code> is the least of our worries.</p>
<p><code>nix-env -i</code> is broken for <em>so many</em> packages – big, important packages – that there’s no point fixing <code>python3</code>. <code>nix-env -i</code> will never work; <code>nix-env -u</code> will never work; we should give up and go home and focus all efforts on fixing the manual so no one ever runs those commands again. We should honestly just <em>deprecate</em> those commands and print a warning to stderr any time someone runs them that explains how broken they are and why you shouldn’t run them and what to do instead.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
<p>So: how did I arrive at this conclusion? Let’s crack open my diary, and find out…</p>
<hr>
<p>Okay, I want to do an experiment: I would like to find all of the derivations with names like <code>nixpkgs.foo</code> and see which ones are different from the derivation “named” <code>foo</code>, according to <code>nix-env -i</code>’s rules.</p>
<p>So like…</p>
<pre tabindex=0><code>$ time (nix-env --dry-run -i python3 --profile ~/scratch/profile 2&gt;&amp;1 | sed -En -e "s/^installing '([^']+)'/\1/p")
python3-3.10.0a5
9.10s user 1.31s system 100% cpu 10.406 total
</code></pre><p>Huh. Ten seconds per derivation… times <code>12,850</code> derivations… it would take 36 hours to check this using <code>nix-env -i --dry-run</code>. So I’m not doin' that.</p>
<p>Instead, I can write my own implementation of the algorithm, and run it in one pass over the output of <code>nix-env -qa --json</code>. Right?</p>
<p>Right.</p>
<pre tabindex=0><code>$ nix-env -qa --json &gt;nix-env-qa.json

$ du -h nix-env-qa.json
 56M    nix-env-qa.json
</code></pre><p>Okay. I only care about <code>pname</code>, <code>version</code>, and <code>meta.priority</code>. So let’s simplify this:</p>
<pre tabindex=0><code>$ jq &lt;nix-env-qa.json &gt;nix-env-qa.simple.json '.[] |= { pname, version, priority: .meta.priority }'

$ du -h nix-env-qa.simple.json
4.1M    nix-env-qa.simple.json

$ head nix-env-qa.simple.json
{
  "nixpkgs._0verkill": {
    "pname": "0verkill-unstable",
    "version": "2011-01-13",
    "priority": null
  },
  "nixpkgs._0x0": {
    "pname": "0x0",
    "version": "2018-06-24",
    "priority": null
</code></pre><p>Let’s see. I only care about the immediate <code>nixpkgs.*</code> packages; I will ignore derivations like <code>nixpkgs.pythonDocs.text.python27</code>. Well, from <em>one</em> half of my calculation. But I can’t ignore them completely, can I? Because <code>nix-env -i python27</code> is going to consider <code>nixpkgs.pythonDocs.text.python27</code> when it does does its check, right? Otherwise it wouldn’t have showed up in <code>nix-env -qa</code>. (I’m not 100% sure this is true, but it makes sense to me. Worst case scenario this will cause me to flag ambiguous packages that are not actually ambiguous. Maybe I’ll double check them afterwards.)</p>
<p>So, okay. I need to form a lookup table – basically invert this shape so that <code>pname</code> is the top key.</p>
<p><code>jq</code> has <code>group_by</code>, but it annoyingly doesn’t produce an object? I get that you might not be grouping by a string property, but it’s kind of annoying there’s no specialized alternative. I wind up with a pretty hairy-looking:</p>
<pre tabindex=0><code>$ jq &lt;nix-env-qa.simple.json &gt;by-name.json 'to_entries | group_by(.value.pname) | map({ key: .[0] | .value.pname, value: map(.value.attr = .key | .value) }) | from_entries'
</code></pre><p>Which is the lookup table I want:</p>
<pre><code>$ jq &lt;by-name.json '.python3'
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>[</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.10.0a5"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python310"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.6.13"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python36"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.6.13"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python36Full"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.7.10"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python37"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.7.10"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python37Full"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.8.9"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.gnuradio3_8Packages.python"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.8.9"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python3Full"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.8.9"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.sourcehut.python"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.8.9"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python38Full"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.9.4"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python39"</span>
  <span class=p>},</span>
  <span class=p>{</span>
    <span class=nt>"pname"</span><span class=p>:</span> <span class=s2>"python3"</span><span class=p>,</span>
    <span class=nt>"version"</span><span class=p>:</span> <span class=s2>"3.9.4"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
    <span class=nt>"attr"</span><span class=p>:</span> <span class=s2>"nixpkgs.python39Full"</span>
  <span class=p>}</span>
<span class=p>]</span>
</code></pre></div><p>Nice.</p>
<p>Now we can sort these by priority and then version… but we might not use the same sort function as Nix! That’s an important caveat, and another reason to check our work with <code>nix-env -i --dry-run</code> afterwards.</p>
<p>I assume <code>jq</code> is going to sort asciibetically:</p>
<pre tabindex=0><code>$ echo '["3.5.0", "3.10.0", "3.1.0"]' | jq 'sort'
[
  "3.1.0",
  "3.10.0",
  "3.5.0"
]
</code></pre><p>Indeed. So that’s no good. We’ll need to try to simulate what (I think) Nix is doing.</p>
<p>I can think of a super hacky way to get what we want, basically padding each version component with <code>0</code>s…</p>
<p>But for some reason my <code>jq</code> doesn’t have a <code>sub()</code> or <code>gsub()</code> function? Huh?</p>
<pre tabindex=0><code>$ jq 'sub("x", "y")'
jq: error: sub/1 is not defined at &lt;top-level&gt;, line 1:
sub("x", "y")
jq: 1 compile error
</code></pre><p>I look in the definition and see there is an argument called <code>onigurumaSupport</code>, which defaults to <code>true</code>… but I have no idea if <code>nixpkgs.jq</code> passes an explicit false or not.</p>
<p>This seems like something I <em>should</em> be able to see, without having to dive into <code>all-packages.nix</code> as I always have before. Like, we have <code>jq.override</code> – that must capture the arguments in a closure. But I can’t get it out of the closure, can I? Here’s a really hacky way to see it:</p>
<pre tabindex=0><code>nix-repl&gt; jq.override { onigurumaSupport = true; }
«derivation /nix/store/m3rs5m4826bxqkmhbh22a1201kqbgisk-jq-1.6.drv»

nix-repl&gt; jq
«derivation /nix/store/m3rs5m4826bxqkmhbh22a1201kqbgisk-jq-1.6.drv»
</code></pre><p>Since those have the same hash, I can be confident that I have <code>oniguruma</code> support.</p>
<p>Hmm. I dunno why my <code>jq</code> doesn’t have <code>sub()</code>. I google it, and find that <code>jq</code> needs the arguments to be semicolon-separated? Oof. That’s a really bad error message. But sure.</p>
<p>Apparently <code>jq</code> only supports named capture groups; I flail a bit with the syntax…</p>
<pre tabindex=0><code>$ echo '["3.5.0", "3.10.0", "3.1.0"]' | jq '
&gt; def pad: (length | if (. &gt;= 6) then "" else "0" * (6 - .) end) + .;
&gt; def pad_version: gsub("^(?&lt;major&gt; \\d+) \\. (?&lt;minor&gt; \\d+) \\. (?&lt;patch&gt; .*)$"; "\(.major | pad).\(.minor | pad).\(.patch | pad)"; "x");
&gt; map(pad_version) | sort'
[
  "000003.000005.000000",
  "000003.000010.000000",
  "000003.000001.000000"
]
</code></pre><p>Gosh. We have <em>definitely</em> exceeded the level of complexity at which <code>jq</code> is a reasonable choice. We should jump to a real language. However, I currently find myself between scripting languages, and don’t have any that I would <em>like</em> to reach for. Python, Ruby, Perl, JS… they spark no joy anymore. So I press on.</p>
<p>That has the version bit sorted, for the most part. It’s weird if you have like a date-based version and a semver-looking version, and it doesn’t work for packages with more than <code>3</code> version components. Actually it’s much cleaner to do the more general thing:</p>
<pre tabindex=0><code>$ echo '["3.5.0", "3.10.0", "3.1.0"]' | jq '
&gt; def pad: (length | if (. &gt;= 6) then "" else "0" * (6 - .) end) + .;
&gt; def pad_version: split(".") | map(pad) | join(".");
&gt; map(pad_version) | sort'
[
  "000003.000001.000000",
  "000003.000005.000000",
  "000003.000010.000000"
]
</code></pre><p>Yeah. I should’ve just started there. The other way is terrifying. I was thinking regexes because I wanted to use the padding-replacement-feature of some regex engines, but <code>jq</code> doesn’t support that, so yeah. No reason to use a regex at all.</p>
<p><em>Okay</em>. Let’s test some slightly harder cases:</p>
<pre tabindex=0><code>$ echo '["3.5.0", "3.10.0a5", "1003.1-2008", "2021-04-01", "3.1.0"]' | jq '
&gt; def pad: (length | if (. &gt;= 6) then "" else "0" * (6 - .) end) + .;
&gt; def pad_version: split(".") | map(pad) | join(".");
&gt; map(pad_version) | sort | reverse'
[
  "2021-04-01",
  "001003.1-2008",
  "000003.000010.0000a5",
  "000003.000005.000000",
  "000003.000001.000000"
]
</code></pre><p>That’s not <em>really</em> what I want. Although I don’t know what Nix would do in that situation, I feel like the date-based ones <em>should</em> rank the lowest… and I have no idea if you have different versioning schemes. Let’s assume that doesn’t happen.</p>
<pre tabindex=0><code>$ echo '["3.5.0", "3.10.0a5", "3.10.0-2008", "2021-04-01", "3.1.0"]' | jq '
&gt; def pad: (length | if (. &gt;= 6) then "" else "0" * (6 - .) end) + .;
&gt; def pad_version: split(".") | map(pad) | join(".") | sub("(?&lt;date&gt;\\d+-\\d+-\\d+)"; "000000: \(.date)");
&gt; map(pad_version) | sort | reverse'
[
  "000003.000010.0000a5",
  "000003.000010.0-2008",
  "000003.000005.000000",
  "000003.000001.000000",
  "000000: 2021-04-01"
]
</code></pre><p>I dunno; good enough, probably? Who knows.</p>
<p>So to do the priority sort, we coalesce <code>null</code> to <code>0</code> and then take advantage of this guarantee made by <code>group_by</code>:</p>
<blockquote>
<p><code>group_by(.foo)</code> takes as input an array, groups the elements having the same <code>.foo</code> field into separate arrays, and produces all of these arrays as elements of a larger array, <em>sorted by the value of the <code>.foo</code> field</em>.</p>
</blockquote>
<p>Emphasis mine. Without all the insane version stuff:</p>
<pre tabindex=0><code>$ jq &lt;by-name.json '.[] |= (group_by(.priority // 0) | .[0] | sort_by(.version) | .[0].version)'
...
</code></pre><p>So you can see how the priority check works in isolation. That one’s pretty simple. Takes a long time to run, though!</p>
<p>Now let’s put it all together, and test an easy one:</p>
<pre tabindex=0><code>$ jq &lt;by-name.json '
&gt; def pad: (length | if (. &gt;= 6) then "" else "0" * (6 - .) end) + .;
&gt; def pad_version: split(".") | map(pad) | join(".") | sub("(?&lt;date&gt;\\d+-\\d+-\\d+)"; "000000: \(.date)");
&gt; .python3 | (group_by(.priority // 0) | .[0] | sort_by(.version | pad_version) | reverse | .[0].version)'
"3.10.0a5"
</code></pre><p>Okay. That one works. Let’s try the whole thing:</p>
<pre tabindex=0><code>$ time jq &lt;by-name.json &gt;resolved-version.json '
&gt; def pad: (length | if (. &gt;= 6) then "" else "0" * (6 - .) end) + .;
&gt; def pad_version: split(".") | map(pad) | join(".") | sub("(?&lt;date&gt;\\d+-\\d+-\\d+)"; "000000: \(.date)");
&gt; .[] |= (group_by(.priority // 0) | .[0] | sort_by(.version | pad_version) | reverse | .[0].version)'
68.72s user 0.76s system 96% cpu 1:12.33 total
</code></pre><p>Pretty slow! But it’s less than 36 hours. And it looks like it worked:</p>
<pre tabindex=0><code>$ head resolved-version.json
{
  "0verkill-unstable": "2011-01-13",
  "0x0": "2018-06-24",
  "1oom": "1.0",
  "1password": "8.0.34",
  "2048-in-terminal": "2017-11-29",
  "20kly": "1.5.0",
  "2bwm": "0.3",
  "2fa": "1.2.0",
  "3270font": "2.3.0",
</code></pre><p>Nice. Let’s spot check a few. We know <code>python3</code> worked… but let’s find one with an explicit priority.</p>
<pre tabindex=0><code>$ jq &lt;by-name.json '.[] | select(any(.priority != null))'
(lots of output)
</code></pre><p>Hmm, this is too many. Let’s find one with an explicit priority and actually different versions…</p>
<pre tabindex=0><code>$ jq &lt;by-name.json '.[] | select(any(.priority != null)) | select(length &gt; 3) | unique_by(.version) | select(length &gt; 1)'
(still lots of output)
</code></pre><p>Okay, that gives me several interesting packages. For example:</p>
<pre tabindex=0><code>[
  {
    "pname": "tesseract",
    "version": "3.05.00",
    "priority": null,
    "attr": "nixpkgs.tesseract"
  },
  {
    "pname": "tesseract",
    "version": "4.1.1",
    "priority": 10,
    "attr": "nixpkgs.tesseract4"
  }
]
</code></pre><p>So <code>nix-env -i tesseract</code> should install <code>3.05.00</code>, not <code>4.1.1</code>. What answer did I get?</p>
<pre tabindex=0><code>$ jq &lt;resolved-version.json .tesseract
"3.05.00"
</code></pre><p>Nice! Okay. Let’s try to find some more complicated version examples:</p>
<pre tabindex=0><code>$ jq &lt;by-name.json '.[] | unique_by(.version) | select(length &gt; 10) | .[0].pname'
"boost"
"cudatoolkit"
"electron"
"luajit"
"octave"
"protobuf"

$ jq &lt;by-name.json '.protobuf | .[] | .version'
"2.5.0"
"3.1.0"
"3.10.1"
"3.11.4"
"3.12.4"
"3.13.0.1"
"3.14.0"
"3.15.8"
"3.16.0"
"3.6.1.3"
"3.7.1"
"3.8.0"
"3.9.2"
</code></pre><p>So, <code>3.16.0</code>? But different versions have different numbers of components – which shouldn’t matter to us.</p>
<pre tabindex=0><code>$ jq &lt;resolved-version.json '.protobuf'
"3.16.0"
</code></pre><p>Good! Okay.</p>
<p>So that was an <em>extremely</em> unscientific series of tests… but whatever this is good enough for now.</p>
<p>Now lets do the same thing in the other direction. We want to exclude things like <code>nixpkgs.ocamlPackages.utop</code>, so we only look at the top-level attributes.</p>
<p>Oh, but hmm. This might actually, sometimes, give you a differently <em>named</em> package, mightn’t it? We should include that as well. So we have:</p>
<pre tabindex=0><code>$ jq &lt;nix-env-qa.simple.json &gt;resolved.by-attr.json '
&gt;  with_entries( select(.key | split(".") | length == 2) 
&gt;              | { key: (.key | split(".") | .[1]),
&gt;                  value: (.value.pname + "-" + .value.version) })'

$ head resolved.by-attr.json
{
  "_0verkill": "0verkill-unstable-2011-01-13",
  "_0x0": "0x0-2018-06-24",
  "_1oom": "1oom-1.0",
  "_1password": "1password-1.9.1",
  "_1password-gui": "1password-8.0.34",
  "_2048-in-terminal": "2048-in-terminal-2017-11-29",
  "_20kly": "20kly-1.5.0",
  "_2bwm": "2bwm-0.3",
  "go-2fa": "2fa-1.2.0",
</code></pre><p>And let’s make <code>resolved-version.json</code> match this same format…</p>
<pre tabindex=0><code>$ jq &lt;resolved-version.json &gt;resolved.by-name.json '
&gt; with_entries(.value = (.key + "-" + .value))'

$ head resolved.by-name.json
{
  "0verkill-unstable": "0verkill-unstable-2011-01-13",
  "0x0": "0x0-2018-06-24",
  "1oom": "1oom-1.0",
  "1password": "1password-8.0.34",
  "2048-in-terminal": "2048-in-terminal-2017-11-29",
  "20kly": "20kly-1.5.0",
  "2bwm": "2bwm-0.3",
  "2fa": "2fa-1.2.0",
  "3270font": "3270font-2.3.0",
</code></pre><p>Okay! Looks good.</p>
<p>You can already see some problems with this approach: you can <code>nix-env -iA nixpkgs._1password</code>, but you cannot <code>nix-env -i _1password</code>.</p>
<p>But that’s fine. I wasn’t really thinking precisely enough about what I’m trying to find here. The <em>important</em> question is “if I <code>nix-env -iA nixpkgs._1password</code>, and then <code>nix-env -u</code>, does anything <em>happen?</em>”</p>
<p>That’s what I’m looking for, really. So I need to do a sort of jump: look up each attribute, and learn 1) what name they have and 2) what name-version pair. Then look up the name, and see if it gives me the same name-version pair. I can’t just, like, <code>comm</code> them. Which is sort of what I was thinking going into this.</p>
<p>Okay. Slight backpedaling:</p>
<pre tabindex=0><code>$ jq &lt;nix-env-qa.simple.json &gt;resolved.by-attr.json '
&gt; with_entries(select(.key | split(".") | length == 2)
&gt;             | { key: (.key | split(".") | .[1]),
&gt;                 value: { name: .value.pname, version: .value.version } })'

$ head resolved.by-attr.json
{
  "_0verkill": {
    "name": "0verkill-unstable",
    "version": "2011-01-13"
  },
  "_0x0": {
    "name": "0x0",
    "version": "2018-06-24"
  },
  "_1oom": {
</code></pre><p>And we can revert to the original <code>"name": "version"</code> format of our <code>by-name</code> map:</p>
<pre tabindex=0><code>$ mv resolved-version.json resolved.by-name.json

$ head resolved.by-name.json
{
  "0verkill-unstable": "2011-01-13",
  "0x0": "2018-06-24",
  "1oom": "1.0",
  "1password": "8.0.34",
  "2048-in-terminal": "2017-11-29",
  "20kly": "1.5.0",
  "2bwm": "0.3",
  "2fa": "1.2.0",
  "3270font": "2.3.0",
</code></pre><p>Okay!</p>
<p>We can combine both of these into a single file with <code>--slurp</code>:</p>
<pre tabindex=0><code>$ jq '{ byName: .[0], byAttr: .[1] }' --slurp resolved.by-name.json resolved.by-attr.json &gt;packages.json
</code></pre><p>Which will simplify subsequent stuff. So let’s do the thing!</p>
<p>I am learning that <code>|=</code> makes <code>jq</code> like… several thousands times slower. Here’s a version without it:</p>
<pre tabindex=0><code>$ jq &lt;packages.json &gt;bad-packages.json '
&gt; .byName as $byName | .byAttr | to_entries | .[]
&gt; | { attr: .key,
&gt;     name: .value.name,
&gt;     version: .value.version,
&gt;     latest: (.value.name as $name | $byName | .[$name]) }
&gt; | select(.version != .latest)'
</code></pre><p>And that’s the final answer! Maybe!</p>
<p>There are a <em>lot</em> of packages in here.</p>
<pre tabindex=0><code>$ jq &lt;bad-packages.json --slurp 'length'
626
</code></pre><p>Except, sadly… it seems I have made a foolish mistake.</p>
<p>This does not include <code>python3</code>.</p>
<p>Because <code>python3</code> isn’t in my original <code>nix-env-qa.json</code> dump. Why? Because it also exists as the path <code>nixpkgs.sourcehut.python3</code>, and <code>nix-env -qa</code> doesn’t repeat elements, so only the first entry appears. Which wouldn’t matter, except that <code>nixpkgs.sourcehut.python3</code> is filtered out of my thing, because it’s a “nested” key, and I only looked at simple top-level things.</p>
<p>Alas. I wish I’d thought of that earlier.</p>
<p>So this is clearly incomplete. But it’s still interesting to look at. It <em>does</em> include things like <code>nixpkgs.python36</code> and friends, which of course probably aren’t going to get <code>nix-env -i</code>’d.</p>
<p>If we only look at problematic packages where the attribute is equal to the name, we’re left with 118. As a lower-bound, remember, because it does not include <code>python3</code> or other packages that occur all over the tree. 118 is a small enough number that I can look through them.</p>
<p>And some of these seem pretty important!</p>
<p><code>bash</code>, for one:</p>
<pre tabindex=0><code>$ nix-env --dry-run -i bash --profile ~/scratch/profile 2&gt;&amp;1 | sed -En -e "s/^installing '([^']+)'/\1/p"
bash-5.1-p4

$ nix-env --dry-run -iA nixpkgs.bash --profile ~/scratch/profile 2&gt;&amp;1 | sed -En -e "s/^installing '([^']+)'/\1/p"
bash-4.4-p23
</code></pre><p>Here’s the list I have – note that this is <em>not</em> complete:</p>
<pre><code>$ jq &lt;bad-packages.json 'select(.name == .attr) | delpaths([["attr"]])' -c
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"allegro"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.4.3.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.2.7.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"antlr"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.7.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.8"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"arangodb"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.4.8"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"aseprite"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.1.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.2.16.3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"bash"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.4-p23"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.1-p4"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"bazel"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.7.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.1.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"bird"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.6.8"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.0.8"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"blas"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.8.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"boost"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.69.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.75.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"botan"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.10.17"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.18.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"cairomm"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.12.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.16.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"cde"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.3.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"cgal"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.14.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.2.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"clang-manpages"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"claws-mail"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.17.8"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.99.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"clisp"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.49"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.50pre20171114"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"coq"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"8.13.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"8.5pl3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"crawl"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.26.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.26.1-tiles"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"cura"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.9.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"15.04"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"curaengine"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.9.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"15.04.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"db"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5.3.28"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6.2.23"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"dex"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.9.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.28.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"diamond"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.8.36"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.10"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"dotnet-sdk"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.1.810"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.0.202"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"elasticsearch"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"elasticsearch-oss"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"erlang"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"24.0.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"16B02.basho10"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"etcd"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.3.25"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.4.16"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"filebeat"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"fltk"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.3.5"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.4.x-r13121"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"fplll"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5.3.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"20160331"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"fsharp"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.0.1.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.1.34"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"gcc-arm-embedded"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"10-2020-q4-major"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"9-2020-q2-update"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"gegl"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.2.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.4.30"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"geogebra"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5-0-644-0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6-0-644-0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"git-lfs"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.13.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.5.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"glibmm"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.64.5"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.68.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"gmime"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.6.23"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.2.7"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"goocanvas"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.0.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.0.4"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"gr-limesdr"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.0.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.0.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"gr-osmosdr"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.1.5"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.2.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"gr-rds"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.8.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"grantlee"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.5.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.2.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"hadoop"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.7.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.1.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"heartbeat"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"helm"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.9.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.6.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"imagemagick"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.0.11-9"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6.9.12-12"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"influxdb"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.8.6"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.0.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"insync"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.5.7.37371"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.2.4.40856"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"journalbeat"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"julia"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.0.4"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.5.4"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"julia-bin"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.0.5"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.6.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"junit"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.11"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.12"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"kibana"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"kibana-oss"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"kubelogin"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.0.9"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.23.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libav"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"11.12"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libcxx"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libcxxabi"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libfprint"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.90.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2-tod1-goodix-0.0.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libftdi"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.20"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.5"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libgnome-keyring"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.32.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.12.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libmicrohttpd"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.9.71"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.9.72"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libmusicbrainz"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.0.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.1.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"libwebsockets"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.2.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.1.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"lilyterm"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.9.9.4"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2019-07-25"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"lld"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"lldb"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"11.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"llvm"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"12.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"llvm-manpages"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"7.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"11.1.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"logstash"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"love"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.10.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"11.3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"lua"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5.2.4"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.4.3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"luajit"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.1.0-2021-05-29"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.1.0-2021-05-29-vstruct-2.0.2-1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"metricbeat"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"miniupnpc"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.9.20160209"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.1.20190625"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"minizip"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.2.11"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.10.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"mps"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.117.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2020.3.3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"nccl"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.7.8-1-cuda-10.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.7.8-1-cuda-11.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"ncurses"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6.2-abi5-compat"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"nginx"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.20.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.21.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"nodejs-slim"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"14.17.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"16.3.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"nomad"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.0.6"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.1.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"nootka"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.4.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.7.0-beta1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"notify-osd"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.9.34"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.9.35+16.04.20160415"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"nv-codec-headers"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"9.1.23.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"10.0.26.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"obsidian"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.12.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"47.04a"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"openafs"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.8.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.9.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"openapi-generator-cli"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5.1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6.0.0-2021-01-18"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"openimageio"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.8.17"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.2.12.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"packetbeat"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.8.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.5.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"perl"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5.32.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.35.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"pgf"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.00"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6.14.12"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"phantomjs"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.9.8"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.1.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"postgresql"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"11.11"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"13.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"prison"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.81.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"psqlodbc"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"09.01.0200"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"10.01.0000"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"quota"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1003.1-2008"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.05"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"qwt"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"5.2.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"6.1.6"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"R"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"4.0.4"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.0.4-wrapper"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"racer"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.1"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.1.44"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"ragel"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.10"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"7.0.0.12"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"readline"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"6.3p08"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"8.1p0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"ruby"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.7.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.0.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"saxonb"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"8.8"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"9.1.0.8"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"scribus"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.4.8"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.5.7"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"spandsp"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.0.6"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"sqlite"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.35.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.27.2+replication3"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"swagger-codegen"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.4.19"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.0.25"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"swig"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.0.12"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"4.0.2"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"terraform"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.12.31"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.15.5"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"tinc"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.0.36"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"1.1pre17"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"tinyxml"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.6.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2-6.0.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"vdr"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"2.4.7"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"2.4.7-skincurses"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"vtk"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"8.2.0"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"9.0.1"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"wcm"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.7.0-wrapped"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.7.0"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"xcb-util-cursor"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"0.1.3"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"0.1.1-3-unstable-2017-04-05"</span><span class=p>}</span>
<span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"zoom"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"1.1.5"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"5.6.20278.0524"</span><span class=p>}</span>
</code></pre></div><p>But even this incomplete list is very convincing. <code>python3</code> is the least of our problems; I just <em>happened</em> to hit that one first. Other things you might reasonably expect to find in a typical user environment include <code>antlr</code>, <code>bazel</code>, <code>lua</code>, <code>perl</code>, <code>ruby</code>, <code>sqlite</code>, <code>terraform</code>… not to mention, you know, <code>bash</code>.</p>
<p>So okay. Are those actually right? This looks like an example where my hacky sort attempt didn’t work:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span><span class=nt>"name"</span><span class=p>:</span><span class=s2>"sqlite"</span><span class=p>,</span><span class=nt>"version"</span><span class=p>:</span><span class=s2>"3.35.2"</span><span class=p>,</span><span class=nt>"latest"</span><span class=p>:</span><span class=s2>"3.27.2+replication3"</span><span class=p>}</span>
</code></pre></div><p>But nope! That’s correct:</p>
<pre><code>$ nix-env -qa sqlite --json | jq '.[] |= { name, priority: .meta.priority }'
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"nixpkgs.sqlite-replication"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"sqlite-3.27.2+replication3"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=kc>null</span>
  <span class=p>},</span>
  <span class=nt>"nixpkgs.sqlite"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"name"</span><span class=p>:</span> <span class=s2>"sqlite-3.35.2"</span><span class=p>,</span>
    <span class=nt>"priority"</span><span class=p>:</span> <span class=mi>10</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p><code>nixpkgs.sqlite</code> has an explicit lower priority set. Huh?</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>sqlite</span> <span class=err>=</span> <span class=n>lowPrio</span> <span class=p>(</span><span class=n>callPackage</span> <span class=sr>../development/libraries/sqlite</span> <span class=p>{</span> <span class=p>});</span>
</code></pre></div><p>Weird. Okay? I’m guessing that Nixpkgs mostly uses <code>meta.priority</code> to resolve filename collisions, and doesn’t actually use it to differentiate which version should be installed.</p>
<p>I kinda sorta start to blame it, but it takes ages, and it wasn’t added in the most recent commit to touch that line, so I give up.</p>
<p>Ugh okay fine I’ll learn how to <code>blame</code> properly. I am very spoiled by having access to a fancy interactive blame thingy at my last job. Maybe <code>magit</code> can do this? Hmm. The docs don’t imply so.</p>
<p>Well, I’m sort of… crippled by the size of this repository, huh? It takes a while.</p>
<p>I don’t know if there’s a smoother way to do this than appending a bunch of <code>--ignore-rev</code>s as I go.</p>
<p>I make it back to April 2013 before I give up again. I think there’s a good chance <code>sqlite</code> has been <code>lowPrio</code> since the dawn of time.</p>
<p>Not important.</p>
<p>More important: I <em>have</em> <code>sqlite</code> installed in my environment right now. Why doesn’t <code>nix-env -u</code> try to upgrade it?</p>
<pre tabindex=0><code>$ nix-env -q sqlite
sqlite-3.35.2

$ nix-env -u sqlite --dry-run
(dry run; not doing anything)
</code></pre><p>Huh! But…</p>
<pre tabindex=0><code>$ nix-env -i sqlite --dry-run
(dry run; not doing anything)
replacing old 'sqlite-3.35.2'
installing 'sqlite-3.27.2+replication3'
</code></pre><p>What! That’s crazy.</p>
<p>So I guess… <code>nix-env -u</code> doesn’t… think about priority? Or… what? No. I checked this! I did! Here’s an example, after I upped the <code>python3</code> priority in an override:</p>
<pre><code>cat ~/.config/nixpkgs/config.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>let</span> <span class=n>overridePackageAttrs</span> <span class=o>=</span> <span class=n>overrides</span><span class=p>:</span> <span class=n>pkgs</span><span class=p>:</span>
  <span class=k>let</span> <span class=n>update</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>lib</span><span class=p>;</span> <span class=p>(</span><span class=n>flip</span> <span class=n>recursiveUpdate</span><span class=p>);</span> <span class=k>in</span>
  <span class=n>pkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>mapAttrs</span> <span class=p>(</span><span class=n>packageName</span><span class=p>:</span> <span class=n>attrUpdates</span><span class=p>:</span>
    <span class=n>pkgs</span><span class=o>.</span><span class=si>${</span><span class=n>packageName</span><span class=si>}</span><span class=o>.</span><span class=n>overrideAttrs</span> <span class=p>(</span><span class=n>update</span> <span class=n>attrUpdates</span><span class=p>))</span>
    <span class=n>overrides</span><span class=p>;</span>
<span class=k>in</span>
<span class=p>{</span>
  <span class=n>allowUnfree</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>overridePackageAttrs</span> <span class=p>{</span>
    <span class=n>python3</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>priority</span> <span class=o>=</span> <span class=mi>-100</span><span class=p>;</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix-env -i python3 --profile ~/scratch/profile
warning: there are multiple derivations named 'python3-3.8.9'; using the first one
installing 'python3-3.8.9'
building '/nix/store/0mgi2imsgp55p268qvvfasjv8by9jmrk-user-environment.drv'...
created 4 symlinks in user environment

$ nix-env -u --profile ~/scratch/profile

$ nix-env -u python3 --profile ~/scratch/profile
</code></pre><p>See? It works correctly.</p>
<p>But it also <em>doesn’t</em> work correctly:</p>
<pre tabindex=0><code>$ nix-env -u python3 --dry-run
(dry run; not doing anything)
upgrading 'python3-3.8.9' to 'python3-3.10.0a5'
</code></pre><p>Isn’t that <em>fascinating</em>. My real profile behaves differently from my little scratch profile. Presumably… because when I installed the <code>python3</code> in my “real” environment, it had a <code>null</code> priority? What other difference could there be? Let’s try a weird experiment:</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.python3
replacing old 'python3-3.8.9'
installing 'python3-3.8.9'
building '/nix/store/136b4yn3k0yjk75fhhzcnpbvsfmvm8ww-user-environment.drv'...
error: packages '/nix/store/p6k14ihyfaq3z4sycxr09cvgpis2zjd5-python3-3.8.9/bin/idle' and '/nix/store/i3719gs514i6061s99rv6r9q5adnj8p9-python-2.7.18/bin/idle' have the same priority -100; use 'nix-env --set-flag priority NUMBER INSTALLED_PKGNAME' to change the priority of one of the conflicting packages (0 being the highest priority)
builder for '/nix/store/136b4yn3k0yjk75fhhzcnpbvsfmvm8ww-user-environment.drv' failed with exit code 1
error: build of '/nix/store/136b4yn3k0yjk75fhhzcnpbvsfmvm8ww-user-environment.drv' failed
</code></pre><p>Huh! Interesting. Okay sure. I change the <code>python3</code>’s priority to <code>-99</code>…</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.python3
replacing old 'python3-3.8.9'
installing 'python3-3.8.9'
</code></pre><p>Okay. So it reinstalled the same thing, but with a different priority. And now if I upgrade…</p>
<pre tabindex=0><code>$ nix-env -u python3 --dry-run
(dry run; not doing anything)
</code></pre><p>Huh! Look at that. Yeah; it depends on the priority that each package was installed with (?).</p>
<p>So… I have no idea what the actual semantics of <code>nix-env -u</code> are. I assumed it was the same as <code>nix-env -i</code>, but clearly that was wrong. From <code>man nix-env</code>:</p>
<blockquote>
<p>The upgrade operation creates a new user environment, based on the current generation of the active profile, in which all store paths are replaced for which there are newer versions in the set of paths described by <code>args</code>. Paths for which there are no newer versions are left untouched; this is not an error. It is also not an error if an element of <code>args</code> matches no installed derivations.</p>
<p>For a description of how <code>args</code> is mapped to a set of store paths, see <code>--install</code>. If <code>args</code> describes multiple store paths with the same symbolic name, only the one with the highest version is installed.</p>
</blockquote>
<p>But like… clearly priority <em>does</em> matter as well, sort of – but only the priority of the installed package? I have <em>no idea</em>. This is fully crazy town, and undocumented crazy town at that.</p>
<p><em>Anyway</em>.</p>
<p>I check <code>nix-env -i --dry-run</code> to confirm that <code>bash</code> and <code>sqlite</code> and <code>ruby</code> are all, in fact, problematic, and my script did not flag them incorrectly:</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.{ruby,bash,sqlite} --profile ~/scratch/profile
installing 'ruby-2.7.3'
installing 'bash-4.4-p23'
installing 'sqlite-3.35.2'

$ nix-env -u --profile ~/scratch/profile
upgrading 'ruby-2.7.3' to 'ruby-3.0.1'
upgrading 'bash-4.4-p23' to 'bash-5.1-p4'

$ nix-env -i sqlite --profile ~/scratch/profile
replacing old 'sqlite-3.35.2'
installing 'sqlite-3.27.2+replication3'
</code></pre><p>Head explodes. No idea. I have convinced myself: this is hopelessly broken, and I close my PR.</p>
<hr>
<ul>
<li>Is there a sane standard alternative to <code>nix-env -u</code>?</li>
<li>How can I see the arguments that a given package was invoked with, without combing through <code>all-packages.nix</code>?</li>
<li>What on earth is <code>nix-env -u</code> doing with package priorities?
<ul>
<li>
<p>Actually, I’m gonna go ahead and close that one right here. I look in the source of <code>nix-env</code>, and find <a href=https://github.com/NixOS/nix/blob/59acbc52208429c5e46c090acc6616f987a212c3/src/nix-env/nix-env.cc#L556>the following comment</a>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=cm>/* Find the derivation in the input Nix expression
</span><span class=cm>   with the same name that satisfies the version
</span><span class=cm>   constraints specified by upgradeType.  If there are
</span><span class=cm>   multiple matches, take the one with the highest
</span><span class=cm>   priority.  If there are still multiple matches,
</span><span class=cm>   take the one with the highest version.
</span><span class=cm>   Do not upgrade if it would decrease the priority. */</span>
</code></pre></div><p>And looking through the code explains everything we’re seeing. <code>nix-env -u</code> explicitly looks for something with <em>both</em> 1) a higher version than our installed package <em>and</em> 2) a higher-or-equal priority than our <em>installed</em> package. So even though <code>sqlite-3.27.2+replication3</code> had a higher priority, it did not have a higher version, so the upgrade skipped it. If there were, say, <code>sqlite-3.99.2+replication3</code>, we would have upgraded to that.</p>
<p>This makes <em>some</em> sense: it would be weird for an “upgrade” to actually “downgrade” a package. But my mind deeply expects, on some primordial level, <code>nix-env -u package</code> to be the same as <code>nix-env -e package</code> followed by <code>nix-env -i package</code>. The fact that those are so different is very upsetting to me. But, you know, it’s not like I’m ever going to run <code>nix-env -u</code> again, so who cares.</p>
<p>Reading the code tells me that you <em>can</em> get the behavior I was expecting with <code>nix-env -u --always</code>, which <em>appears</em> to have the same behavior as running <code>nix-env -i</code> for all your packages:</p>
<pre tabindex=0><code>$ nix-env -u --always --dry-run
(dry run; not doing anything)
downgrading 'imagemagick-7.0.11-9' to 'imagemagick-6.9.12-12'
downgrading 'sqlite-3.35.2' to 'sqlite-3.27.2+replication3'
</code></pre><p>As well as resolving the thing where my <code>python3</code> would still upgrade because it had a lower priority when I initially installed it, although <code>--leq</code> would have resolved that as well. From <code>man nix-env</code>:</p>
<pre tabindex=0><code>--leq
    In addition to upgrading to newer versions, also "upgrade" to
    derivations that have the same version. Version are not a unique
    identification of a derivation, so there may be many derivations
    that have the same version. This flag may be useful to force
    "synchronisation" between the installed and available derivations.
</code></pre></li>
</ul>
</li>
</ul>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Uhh… what <em>should</em> you do instead? I know the answer for <code>nix-env -i</code>, but I honestly don’t know what the “correct” alternative is to <code>nix-env -u</code>. Is there one? I have <a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>my solution, with my little file thingy</a>, but it’s not like I can recommend that to everyone. I don’t know the answer!&nbsp;<a href=#fnref:1 class=footnote-backref role=doc-backlink>↩︎</a></p>
</li>
</ol>
</section></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Ambiguous%20packages%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Next up ➜ Running zsh in nix-shell</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
