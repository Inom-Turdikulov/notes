<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/ 
 saved date: Mon Jul 17 2023 13:35:16 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 42: Running zsh in nix-shell</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div{margin-top:1em}main pre+div.highlight,main div.highlight+pre,main pre+pre{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .cm{color:var(--palette-dim)}.highlight .cp{color:var(--palette-dim)}.highlight .c1{color:var(--palette-dim)}.highlight .kn{color:var(--palette-teal)}.highlight .m{color:var(--palette-orange)}.highlight .s{color:var(--palette-green)}.highlight .nb{color:var(--palette-text)}.highlight .nv{color:var(--palette-red)}.highlight .s2{color:var(--palette-green)}.highlight .sr{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 42: Running zsh in nix-shell">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>
<meta name=description content="I’ve been using Nix for a few months now, and one of my largest outstanding pain points is that any time I’m in a nix-shell, none of my stuff works the way I want it to.
On a scale from “uses the stock PS1” to “wrote their own shell,” I’m prettttty far to the right. I haven’t actually written my own shell, but, you know, I’ve started writing my own shell, and I have lots of aliases and a fancy custom fzf-based autocomplete thing and weird tmux integrations and strong feelings about how my shell should behave.
And I cannot tell you the number of times I have seen this error message:">
<meta property=og:description content="I’ve been using Nix for a few months now, and one of my largest outstanding pain points is that any time I’m in a nix-shell, none of my stuff works the way I want it to.
On a scale from “uses the stock PS1” to “wrote their own shell,” I’m prettttty far to the right. I haven’t actually written my own shell, but, you know, I’ve started writing my own shell, and I have lots of aliases and a fancy custom fzf-based autocomplete thing and weird tmux integrations and strong feelings about how my shell should behave.
And I cannot tell you the number of times I have seen this error message:">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-06-16>June 16, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>How to Learn Nix, Part&nbsp;42:<br>Running zsh in nix-shell</a></h1>
</div>
<div class=post-content><p>I’ve been using Nix for a few months now, and one of my largest outstanding pain points is that any time I’m in a <code>nix-shell</code>, none of my stuff works the way I want it to.</p>
<p>On a scale from “uses the stock <code>PS1</code>” to “wrote their own shell,” I’m prettttty far to the right. I haven’t actually written my own shell, but, you know, I’ve <em>started</em> writing my own shell, and I have lots of aliases and a fancy custom <a href=https://github.com/ianthehenry/zsh-expander><code>fzf</code>-based autocomplete thing</a> and <a href=https://ianthehenry.com/posts/tmux-copy-last-command/>weird tmux integrations</a> and strong feelings about <a href=https://github.com/ianthehenry/zsh-autoquoter>how my shell <em>should</em> behave</a>.</p>
<p>And I cannot tell you the number of times I have seen this error message:</p>
<pre tabindex=0><code>[nix-shell:~]$ ll
bash: ll: command not found
</code></pre><p>It’s very annoying.</p>
<p>And yes: I know that I can just run <code>zsh</code> from within my <code>nix-shell</code>. I made my <code>.zshenv</code> not do anything to my <code>PATH</code> when I’m running <code>IN_NIX_SHELL</code>, so that it works correctly, and doesn’t clobber the <code>nix-shell</code> environment.</p>
<p>And I <em>do</em> do that, sometimes. But it’s terrible, and it makes leaving and re-entering the <code>nix-shell</code> really annoying, and usually I only remember to do it because I run into some problem in the first place and anyway whatever I don’t have to justify this to you.</p>
<p>I like <code>zsh</code>, and I want <code>nix-shell</code> to run <code>zsh</code>.</p>
<p>So. All the way <a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>back in part 16</a>, I learned that I could run this:</p>
<pre><code>$ NIX_BUILD_SHELL=zsh nix-shell
bash: no such option: rcfile
</code></pre>
<p>If I wanted a fun little confusing error message. My conclusion at the time was that it actually <em>was</em> invoking <code>zsh</code>, but it was invoking it <em>as</em> <code>bash</code> – i.e., an <code>argv[0]</code> of <code>"bash"</code>, hence the weird error message. That still sounds plausible to me.</p>
<p>But I don’t actually know what <code>zsh</code>… is? Like, is that getting the <code>zsh</code> on my <code>PATH</code>? Is that the derivation <em>named</em> <code>zsh</code>? Is that the derivation at <code>nixpkgs.zsh</code>?</p>
<p><code>man nix-shell</code> only says:</p>
<blockquote>
<pre tabindex=0><code>NIX_BUILD_SHELL
</code></pre><p>Shell used to start the interactive environment. Defaults to the <code>bash</code> found in <code>PATH</code>.</p>
</blockquote>
<p>Which is… weird, right? That it’s not some Nix derivation; that it’s doing an actual <code>PATH</code> lookup. But it doesn’t say “defaults to <code>bash</code>;” it says the <code>bash</code> found in <code>PATH</code>… it’s very weird.</p>
<p>And by now I’ve read all of the manuals, so I know there’s nothing in the manuals about this. So in order to learn more, I’ve got to dive into the source.</p>
<p>Doing so teaches me that <code>nix-shell</code> is implemented in <code>nix-build.cc</code>, which does make some sense to me: <code>nix-shell</code> and <code>nix-build</code> are basically identical when they realize dependencies and setting up the environment; they only really vary in what command they end up running in that environment.</p>
<p>Anyway, <a href=https://github.com/NixOS/nix/blob/59acbc52208429c5e46c090acc6616f987a212c3/src/nix-build/nix-build.cc#L334>here’s a comment</a> that implies that the <code>man</code> page is lying:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=cm>/* Figure out what bash shell to use. If $NIX_BUILD_SHELL
</span><span class=cm>   is not set, then build bashInteractive from
</span><span class=cm>   &lt;nixpkgs&gt;. */</span>
</code></pre></div><p>And indeed, that comment is accurate; the documentation is in fact lying. I am sort of relieved, because this behavior is much more reasonable than the thing in the <code>man</code> page. Although it does do that less reasonable thing as a last resort, if it cannot build <code>nixpkgs.bashInteractive</code>, with a warning:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>printError</span><span class=p>(</span><span class=s>"warning: %s; will use bash from your environment"</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>what</span><span class=p>());</span>
</code></pre></div><p>So okay. Then it writes down a little file, of initialization stuff. Can I see that file? I should be able to…</p>
<pre tabindex=0><code>[nix-shell:~]$ ps $$
  PID   TT  STAT      TIME COMMAND
46836 s004  S      0:01.24 bash --rcfile /private/tmp/nix-shell-46836-0/rc

[nix-shell:~]$ cat /private/tmp/nix-shell-46836-0/rc
cat: /private/tmp/nix-shell-46836-0/rc: No such file or directory
</code></pre><p>But it seems that the first thing that file does is destroy itself. How do I know? Well, I can see <a href=https://github.com/NixOS/nix/blob/59acbc52208429c5e46c090acc6616f987a212c3/src/nix-build/nix-build.cc#L414>the code that <em>generates</em> the file</a>, but it’s a mess of string interpolation, and does not make very pleasant reading.</p>
<p>There is no <code>--keep-tmp</code> or any sort of flag to <code>nix-shell</code>, but reading the source teaches me that I can keep the temp directory around by <a href=https://github.com/NixOS/nix/blob/59acbc52208429c5e46c090acc6616f987a212c3/src/nix-build/nix-build.cc#L398>having a single <code>passAsFile</code> argument</a>…</p>
<pre><code>[nix-shell:~/src/mixologician]$ cat shell.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=n>mkShell</span> <span class=p>{</span>
  <span class=n>nativeBuildInputs</span> <span class=o>=</span> <span class=p>[</span> <span class=n>souffle</span> <span class=n>python39Packages</span><span class=o>.</span><span class=n>cram</span> <span class=p>];</span>
  <span class=n>passAsFile</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"passAsFile"</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>[nix-shell:~/src/mixologician]$ cat $(ps $$ -o command= | awk '{print $NF}')
[ -n "$PS1" ] &amp;&amp; [ -e ~/.bashrc ] &amp;&amp; source ~/.bashrc; p=$PATH; dontAddDisableDepTrack=1; [ -e $stdenv/setup ] &amp;&amp; source $stdenv/setup; PATH=$PATH:$p; unset p; PATH="/nix/store/n6kzbax7sjy3kha78hpfh024ghbykgxa-bash-interactive-4.4-p23/bin:$PATH"; SHELL=/nix/store/n6kzbax7sjy3kha78hpfh024ghbykgxa-bash-interactive-4.4-p23/bin/bash; set +e; [ -n "$PS1" ] &amp;&amp; PS1='\n\[\033[1;32m\][nix-shell:\w]\$\[\033[0m\] '; if [ "$(type -t runHook)" = function ]; then runHook shellHook; fi; unset NIX_ENFORCE_PURITY; shopt -u nullglob; unset TZ; shopt -s execfail;
</code></pre><p>Nice. Let me try to prettify that for you:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>[</span> -n <span class=s2>"</span><span class=nv>$PS1</span><span class=s2>"</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> -e ~/.bashrc <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>source</span> ~/.bashrc

<span class=nv>p</span><span class=o>=</span><span class=nv>$PATH</span>
<span class=nv>dontAddDisableDepTrack</span><span class=o>=</span><span class=m>1</span>
<span class=o>[</span> -e <span class=nv>$stdenv</span>/setup <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>source</span> <span class=nv>$stdenv</span>/setup
<span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:<span class=nv>$p</span>
<span class=nb>unset</span> p

<span class=nv>PATH</span><span class=o>=</span><span class=s2>"/nix/store/n6kzbax7sjy3kha78hpfh024ghbykgxa-bash-interactive-4.4-p23/bin:</span><span class=nv>$PATH</span><span class=s2>"</span>
<span class=nv>SHELL</span><span class=o>=</span>/nix/store/n6kzbax7sjy3kha78hpfh024ghbykgxa-bash-interactive-4.4-p23/bin/bash

<span class=nb>set</span> +e

<span class=o>[</span> -n <span class=s2>"</span><span class=nv>$PS1</span><span class=s2>"</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nv>PS1</span><span class=o>=</span><span class=s1>'\n\[\033[1;32m\][nix-shell:\w]\$\[\033[0m\] '</span>

<span class=k>if</span> <span class=o>[</span> <span class=s2>"</span><span class=k>$(</span><span class=nb>type</span> -t runHook<span class=k>)</span><span class=s2>"</span> <span class=o>=</span> <span class=k>function</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  runHook shellHook
<span class=k>fi</span>

<span class=nb>unset</span> NIX_ENFORCE_PURITY
<span class=nb>shopt</span> -u nullglob
<span class=nb>unset</span> TZ
<span class=nb>shopt</span> -s execfail
</code></pre></div><p>Okay. So there’s some interesting info here.</p>
<p>I don’t have a <code>~/.bashrc</code> so I don’t need to worry about that bit.</p>
<p>This <code>nix</code> command has knowledge of the internal workings of <code>$stdenv/setup</code> from Nixpkgs: <code>dontAddDisableDepTrack</code> is meaningful to that script. This is a weird amount of coupling, but like, not <em>that</em> weird. <code>nix-shell</code> is a user-friendly helper thing, not some primitive fundamental part of Nix, so the fact that it “knows” a lot about Nixpkgs isn’t that upsetting.</p>
<p>I had <em>assumed</em> that my <code>PATH</code> was set in a <code>nix-shell</code> because <code>stdenv.mkDerivation</code> added an implicit <code>shellHook</code> to my derivation to set it. But it doesn’t! And that kinda makes sense, when I think about it, since <code>shellHooks</code> are like… propagated? Right? So every one of my dependencies would set their own <code>PATH</code> and that would be kind of dumb. But I guess you could have some mechanism of non-propagated <code>shellHook</code>s or something. I dunno. It doesn’t really matter. It works by implicitly sourcing <code>$stdenv/setup</code> instead.</p>
<p>The <code>-n $PS1</code> thing is pretty bizarre. It’s checking if <code>PS1</code> is set to a nonempty string… and then clobbering it <em>if it is?</em> Weird. Weird. I guess this is like… an attempt to detect if it’s running interactively or not? I don’t know.</p>
<p>Anyway; all of this is fine. I can’t just source this as if it were a <code>zsh</code> script – <code>shopt</code> is a <code>bash</code> builtin, and I’m sure something in <code>$stdenv/setup</code> is not compatible – but I can source it from <code>bash</code> and then <code>exec zsh</code>, I think, more or less like I’ve been doing manually.</p>
<p>But first, let’s see what happens when we set <code>NIX_BUILD_SHELL=zsh</code>. The only difference is these two lines:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nv>PATH</span><span class=o>=</span><span class=s2>".:</span><span class=nv>$PATH</span><span class=s2>"</span>
<span class=nv>SHELL</span><span class=o>=</span>zsh
</code></pre></div><p>Which… huh. Okay. So clearly it <em>expects</em> an absolute path. That’s easy enough:</p>
<pre tabindex=0><code>$ echo $SHELL
/nix/store/bainh95kdn1h0gy5rdayjj7qq15a6q46-zsh-5.8/bin/zsh

$ NIX_BUILD_SHELL=$SHELL nix-shell
bash: no such option: rcfile
</code></pre><p>Alright. Now we’re talking. The code confirms that it’s invoking us as <code>bash</code>; all we need to do now is handle the <code>--rcfile</code> correctly.</p>
<p><em>But.</em></p>
<p>Surely someone has done this already, right? I <code>nix search zsh</code>, and find these relevant-looking hits:</p>
<pre tabindex=0><code>* nixpkgs.any-nix-shell (any-nix-shell-1.2.1)
  fish and zsh support for nix-shell

* nixpkgs.zsh-nix-shell (zsh-nix-shell)
  zsh plugin that lets you use zsh in nix-shell shell
</code></pre><p>I don’t like the sound of “plugin.” I want, like, a tiny wrapper script. I look through the source of both of them, and am not very satisfied.</p>
<p><a href=https://github.com/chisui/zsh-nix-shell><code>zsh-nix-shell</code></a> is in fact a plugin, and the installation instructions are like… scary and weird and involve installing a custom <code>zsh</code> derivation, and I am not there yet.</p>
<p><a href=https://github.com/haslersn/any-nix-shell><code>any-nix-shell</code></a> similarly wants to do a bunch of fancy stuff and wants me to source it instead of just being the thing I set <code>NIX_BUILD_SHELL</code> to. It seems very complicated, and all I want to do is like… ignore a single command line argument.</p>
<p>So I write my own.</p>
<p>In the course of doing so I learn that my system <code>bash</code> actually <em>can’t handle</em> all the setup hooks that are run in this trivial derivation.</p>
<pre tabindex=0><code>/nix/store/7qk9mqi411ip2jh10d1bbj7x7mgrfksg-cctools-binutils-darwin-wrapper-949.0.1/nix-support/setup-hook:
line 134: ${cmd^^}${role_post}=${cmd}: bad substitution
</code></pre><p>I have to source it with <code>nixpkgs.bashInteractive</code> instead. Huh.</p>
<p>But there’s one more thing to worry about. Because <code>nix-shell</code> is going to invoke <code>zsh</code> as <code>bash</code>, I’m worried that <code>zsh</code> might put us in some sort of weird compatibility mode. <code>man zsh</code> says it will emulate <code>sh</code> or <code>ksh</code> when invoked as such, but the <code>man</code> page does not saying anything about <code>bash</code>…</p>
<p>Actually, no. Darn. I need to read more closely. From <code>man zsh</code>:</p>
<blockquote>
<p>Zsh tries to emulate <code>sh</code> or <code>ksh</code> when it is invoked as <code>sh</code> or <code>ksh</code> respectively; more precisely, it looks at the first letter of the name by which it was invoked, excluding any initial ‘<code>r</code>’ (assumed to stand for ‘restricted’), and if that is ‘<code>b</code>’, ‘<code>s</code>’ or ‘<code>k</code>’ it will emulate <code>sh</code> or <code>ksh</code>. Furthermore, if invoked as <code>su</code> (which happens on certain systems when the shell is executed by the <code>su</code> command), the shell will try to find an alternative name from the <code>SHELL</code> environment variable and perform emulation based on that.</p>
</blockquote>
<p>Okay. So the emulation mode <em>seems</em> rather innocuous, reading about it. But just to be sure, I’ll invoke <code>zsh</code> with <code>--emulate zsh</code>.</p>
<p>Anyway, here’s the first working attempt at my little wrapper script:</p>
<pre><code>$ cat ~/bin/nix-zshell
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/nix/store/n6kzbax7sjy3kha78hpfh024ghbykgxa-bash-interactive-4.4-p23/bin/bash
</span><span class=cp></span>
<span class=k>if</span> <span class=o>[[</span> <span class=s2>"</span><span class=nv>$1</span><span class=s2>"</span> !<span class=o>=</span> <span class=s2>"--rcfile"</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nb>echo</span> <span class=s2>"Something is wrong: invoked as:"</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
  <span class=nb>echo</span> <span class=s2>"</span><span class=nv>$0</span><span class=s2> </span><span class=nv>$@</span><span class=s2>"</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>fi</span>

<span class=nv>rcfile</span><span class=o>=</span><span class=s2>"</span><span class=nv>$2</span><span class=s2>"</span>
<span class=nb>source</span> <span class=s2>"</span><span class=nv>$rcfile</span><span class=s2>"</span>

<span class=nb>exec</span> zsh --emulate zsh
</code></pre></div><p>Obviously this is dumb; it hardcodes the path to <code>bashInteractive</code> (which probably won’t exist, after a good garbage collection) and it invokes the <code>zsh</code> on my <code>PATH</code> instead of <code>nixpkgs.zsh</code>. But in order to fix it, we need to make it into a derivation. Easy enough:</p>
<pre><code>$ cat nix-zshell
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!@bashInteractive@/bin/bash
</span><span class=cp></span>
<span class=k>if</span> <span class=o>[[</span> <span class=s2>"</span><span class=nv>$1</span><span class=s2>"</span> !<span class=o>=</span> <span class=s2>"--rcfile"</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nb>echo</span> <span class=s2>"Something is wrong: invoked as:"</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
  <span class=nb>echo</span> <span class=s2>"</span><span class=nv>$0</span><span class=s2> </span><span class=nv>$@</span><span class=s2>"</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>fi</span>

<span class=nv>rcfile</span><span class=o>=</span><span class=s2>"</span><span class=nv>$2</span><span class=s2>"</span>
<span class=nb>source</span> <span class=s2>"</span><span class=nv>$rcfile</span><span class=s2>"</span>

<span class=nb>exec</span> @zsh@/bin/zsh --emulate zsh
</code></pre></div><pre><code>$ cat default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span>
<span class=n>stdenvNoCC</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"nix-zshell"</span><span class=p>;</span>

  <span class=n>script</span> <span class=o>=</span> <span class=n>substituteAll</span> <span class=p>{</span>
    <span class=n>src</span> <span class=o>=</span> <span class=sr>./nix-zshell</span><span class=p>;</span>
    <span class=k>inherit</span> <span class=n>zsh</span> <span class=n>bashInteractive</span><span class=p>;</span>
  <span class=p>};</span>

  <span class=n>phases</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"installPhase"</span><span class=p>];</span>

  <span class=n>installPhase</span> <span class=o>=</span> <span class=s2>"install $script $out"</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><aside>
<p><code>nix-shell -p coreutils-full --command 'man install'</code> teaches me that the default perms of the file it copies will be <code>rwxr-xr-x</code>, but experimentation reveals that <code>nix</code> will clear the <code>w</code> bit for me. I could also just use <code>cp</code> and <code>chmod</code>, but like, <code>install</code> is neat? Why not? Certainly more useful if you’re copying to a <code>bin/</code> directory.</p>
</aside>
<p>That was my first time using <code>substituteAll</code>. It’s pretty nice! I had to look in the source to see the usage, because it doesn’t seem to be documented in the Nixpkgs manual? Weird. The shell function is documented, but not the incredibly-useful derivation helper.</p>
<p>Okay, so this works. I set it as my <code>NIX_BUILD_SHELL</code>, and in order to make it more nice, I add a few lines to my <code>.zshrc</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=k>if</span> <span class=o>[[</span> -n <span class=s2>"</span><span class=nv>$IN_NIX_SHELL</span><span class=s2>"</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nv>label</span><span class=o>=</span><span class=s2>"nix-shell"</span>
  <span class=k>if</span> <span class=o>[[</span> <span class=s2>"</span><span class=nv>$name</span><span class=s2>"</span> !<span class=o>=</span> <span class=s2>"</span><span class=nv>$label</span><span class=s2>"</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
    <span class=nv>label</span><span class=o>=</span><span class=s2>"</span><span class=nv>$label</span><span class=s2>:</span><span class=nv>$name</span><span class=s2>"</span>
  <span class=k>fi</span>
  <span class=nb>export</span> <span class=nv>PS1</span><span class=o>=</span><span class=s1>$'%{$fg[green]%}'</span><span class=s2>"</span><span class=nv>$label</span><span class=s2> </span><span class=nv>$PS1</span><span class=s2>"</span>
  <span class=nb>unset</span> label
<span class=k>fi</span>
</code></pre></div><p>(<code>"$name" == "nix-shell"</code> when you use the <code>mkShell</code> helper).</p>
<p>And I’m done! For now. We’ll see how this holds up. It’s certainly going to be nice to have my tab completion back.</p>
<p>This also has an interesting subtle benefit that I didn’t think of beforehand:</p>
<p>I previously learned <a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>how to prevent my shell-dependencies from being garbage collected</a>. But it was weirdly <em>incomplete</em>. Observe:</p>
<aside>
<p>I deleted my <code>nix-zshell</code> script to clear the GC root, and I unset <code>NIX_BUILD_SHELL</code> for this demonstration.</p>
</aside>
<pre tabindex=0><code>$ nix-instantiate shell.nix --indirect --add-root ./.nix-gc-roots/shell.drv &gt;/dev/null
</code></pre><pre tabindex=0><code>$ nix-collect-garbage
finding garbage collector roots...
deleting garbage...
deleting '/nix/store/trash'
deleting unused links...
note: currently hard linking saves 0.00 MiB
0 store paths deleted, 0.00 MiB freed
</code></pre><pre tabindex=0><code>$ nix-shell
these paths will be fetched (0.51 MiB download, 2.47 MiB unpacked):
  /nix/store/09qfwy98lb4k6nkjvqzap6vz3xw2qbfx-bash-interactive-4.4-p23-dev
  /nix/store/7v4vy0c9s6w372fff8z6cg9940l1r9vc-bash-interactive-4.4-p23-info
  /nix/store/8rffdnidm329k1gjl237cyqxjm9lqk49-bash-interactive-4.4-p23-doc
  /nix/store/rp1my891q8x3kvd8gqwlb5fk2f13dn68-bash-interactive-4.4-p23-man
copying path '/nix/store/8rffdnidm329k1gjl237cyqxjm9lqk49-bash-interactive-4.4-p23-doc' from 'https://cache.nixos.org'...
copying path '/nix/store/09qfwy98lb4k6nkjvqzap6vz3xw2qbfx-bash-interactive-4.4-p23-dev' from 'https://cache.nixos.org'...
copying path '/nix/store/7v4vy0c9s6w372fff8z6cg9940l1r9vc-bash-interactive-4.4-p23-info' from 'https://cache.nixos.org'...
copying path '/nix/store/rp1my891q8x3kvd8gqwlb5fk2f13dn68-bash-interactive-4.4-p23-man' from 'https://cache.nixos.org'...
</code></pre><p><em>Even though</em> I saved all the dependencies of my shell from being garbage collected, I <em>didn’t</em> save <code>bashInteractive</code>, because <code>bashInteractive</code> is <em>not</em> a dependency of my derivation. It’s something that’s hardcoded into <code>nix-shell</code> itself.</p>
<p>But by setting <code>NIX_BUILD_SHELL</code> explicitly, I no longer have this issue. Not because that has an explicit dependency on <code>bashInteractive</code> – that’s not strictly necessary – but just because the implicit dependency is gone. So: yay! A fun side effect.</p>
<p>Alright. I am happy, for now. My <code>nix-shell</code> works the way I want it to; there is no more weird context switch between “regular programming” and “programming in a <code>nix-shell</code>.”</p>
<p>It’s… not <em>great</em> that I had to think about this in first place, though. I suspect it wouldn’t be too hard to patch <code>nix-shell</code> to just transparently use whatever <code>$SHELL</code> it was invoked under. Sure, maybe not in <code>--pure</code> mode, but for “regular” development, it would take <code>nix-shell</code> from being “really useful but also really annoying” to just “really useful.” It would make it a little easier to recommend it.</p>
<p>Anyway this is the part at the end of a post where I ramble hoping to come up with some sort of pithy concluding remarks and eventually just cut it off abruptly and hit publish.</p>
<aside>
<p>Since writing this post, I have changed my wrapper script to the following:</p>
<pre><code>$ cat nix-zshell
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!@bashInteractive@/bin/bash
</span><span class=cp></span>
<span class=c1># when using nix-shell, we will be invoked like this:</span>
<span class=c1>#</span>
<span class=c1>#     /path/to/result --rcfile /path/to/file</span>
<span class=c1>#</span>
<span class=c1># When using nix-shell -i, we will be invoked like this:</span>
<span class=c1>#</span>
<span class=c1>#     /path/to/result /path/to/file</span>
<span class=c1>#</span>
<span class=c1># We use the presence of --rcfile to decide if we're supposed</span>
<span class=c1># to be run interactively or not.</span>

<span class=k>if</span> <span class=o>[[</span> <span class=s2>"</span><span class=nv>$1</span><span class=s2>"</span> <span class=o>=</span> <span class=s2>"--rcfile"</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nv>rcfile</span><span class=o>=</span><span class=s2>"</span><span class=nv>$2</span><span class=s2>"</span>
  <span class=nb>source</span> <span class=s2>"</span><span class=nv>$rcfile</span><span class=s2>"</span>

  <span class=nb>exec</span> @zsh@/bin/zsh --emulate zsh
<span class=k>else</span>
  <span class=nb>exec</span> @bashInteractive@/bin/bash <span class=s2>"</span><span class=nv>$@</span><span class=s2>"</span>
<span class=k>fi</span>
</code></pre></div><p>So that I can use <code>nix-shell -i</code>. I’m not sure if there are other cases where this might fail, but after six months of usage this is the only other invocation I’ve run into.</p>
</aside></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Running%20zsh%20in%20nix-shell%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>Next up ➜ My first brush with flakes</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></strong>&nbsp;←&nbsp;you are here</li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
