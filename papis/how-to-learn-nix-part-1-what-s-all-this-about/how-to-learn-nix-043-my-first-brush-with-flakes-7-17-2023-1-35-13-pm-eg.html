<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/flakes/ 
 saved date: Mon Jul 17 2023 13:35:13 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 43: My first brush with flakes</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}h2{font-size:120%}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1,main *+h2{margin-top:1em}main pre+div.highlight,main div.highlight+pre,main pre+pre{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .c1{color:var(--palette-dim)}.highlight .kc{color:var(--palette-purple)}.highlight .kn{color:var(--palette-teal)}.highlight .nb{color:var(--palette-text)}.highlight .no{color:var(--palette-red)}.highlight .nt{color:var(--palette-teal)}.highlight .w{color:var(--palette-text)}.highlight .mi{color:var(--palette-orange)}.highlight .s2{color:var(--palette-green)}.highlight .se{color:var(--palette-orange)}.highlight .si{color:var(--palette-orange)}.highlight .sr{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 43: My first brush with flakes">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>
<meta name=description content="Nix 2.4 came out on November 1, 2021, and that’s sort of a big deal.
It’s been more than two years since the last major Nix release, and there are some pretty important changes. Including some breaking changes, which is why I have waited so long to upgrade.
Because I think that, in order to keep using Nix, I’m finally going to have to learn what “flakes” are, and do a bunch of other stuff just to restore the functionality that I was enjoying before.
Or maybe not. It might be painless. Let’s find out!">
<meta property=og:description content="Nix 2.4 came out on November 1, 2021, and that’s sort of a big deal.
It’s been more than two years since the last major Nix release, and there are some pretty important changes. Including some breaking changes, which is why I have waited so long to upgrade.
Because I think that, in order to keep using Nix, I’m finally going to have to learn what “flakes” are, and do a bunch of other stuff just to restore the functionality that I was enjoying before.
Or maybe not. It might be painless. Let’s find out!">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-12-05>December 5, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>How to Learn Nix, Part&nbsp;43:<br>My first brush with flakes</a></h1>
</div>
<div class=post-content><p>Nix 2.4 came out on November 1, 2021, and that’s sort of a big deal.</p>
<p>It’s been more than two years since the last major Nix release, and there are some pretty important changes. Including some <em>breaking</em> changes, which is why I have waited so long to upgrade.</p>
<p>Because I think that, in order to keep using Nix, I’m finally going to have to learn what “flakes” are, and do a bunch of other stuff just to restore the functionality that I was enjoying before.</p>
<p>Or maybe not. It might be painless. Let’s find out!</p>
<pre tabindex=0><code>$ nix-env -iA nixpkgs.nix
replacing old 'nix-2.3.16'
installing 'nix-2.4'
...
$ nix --version
nix (Nix) 2.4
</code></pre><p>Well that was easy.</p>
<p>The closest thing to “documentation” about Nix 2.4 is <a href=https://discourse.nixos.org/t/nix-2-4-released/15822>the release notes</a>, so let’s try reading through them to learn what’s changed.</p>
<p>The big picture highlights are:</p>
<ul>
<li>
<p>The <code>nix</code> command is better, apparently, but it is also now <em>disabled by default</em>, so anyone using Nix has to add the line <code>experimental-features = nix-command</code> to their Nix config file.</p>
<p>I guess this is a nice way to teach people where the Nix config file lives…? But I would consider Nix basically unusable without <code>nix search</code>, so this is a very strange choice.</p>
<p>But even after you do this, <code>nix search</code> no longer works, so… yeah okay.</p>
</li>
<li>
<p>Flakes, a controversial new feature that I don’t fully understand but am personally very bullish about, has taken over much of the UI.</p>
</li>
<li>
<p>Content-addressable store paths. I’m interested to see how these work and what this is, because it’s not obvious to me how you implement this seamlessly on top of Nix’s existing situation.</p>
</li>
<li>
<p>The manual has been subjected to an automated conversion to <a href=https://github.com/rust-lang/mdBook><code>mdbook</code></a> that makes it completely unsearchable and much more difficult to read, conspiring to make Nix harder to learn than ever before. But it <em>also</em> makes it much easier for people to contribute changes to the documentation, so perhaps given time the positive slope may be able to overcome the negative y-intercept that this change inflicted.</p>
<p>Fortunately, the Nixpkgs manual and NixOS manual have not undergone the same migration… at least, not yet.</p>
</li>
<li>
<p>Single-user installs on macOS are no longer supported.</p>
<p>This is very sad for me, as I never would have tried Nix in the first place if I had to do a multi-user install, and I imagine that there are many people who feel similarly to me.</p>
<p>I understand that it is <em>possible</em> to hack the install script to do a single-user install on macOS, but it was already pretty difficult to install in the first place, and this makes it basically impossible to market Nix to macOS users who are not already “sold” on Nix.</p>
</li>
</ul>
<p>The release of 2.4 feels bittersweet for me. On the one hand, I’m excited about the UX improvements in the <code>nix</code> command line – mostly <code>nix profile</code>, I guess, because <code>nix-env</code> has been the source of most of my Nix UX complaints. On the other hand, it feels like a huge step backward for “macOS users who want to learn Nix by themselves.” Which described me, earlier this year. If my first introduction to Nix had been Nix 2.4, this blog series never would have existed, and I’d still be stuck with Homebrew.</p>
<p>But anyway. First things first: let’s try to restore all of the functionality that we had before we upgraded to Nix 2.4. That means:</p>
<pre><code>nix search
nix repl
nix path-info
nix show-derivation
</code></pre>
<p><code>nix repl</code> seems to work out of the box just fine, once I enable the <code>nix</code> binary again. And so does <code>nix show-derivation</code>. <code>nix search</code> and <code>nix path-info</code> both yell about flakes, though, and their API seems to have changed.</p>
<p>So I guess I have to learn something about flakes. I opted into it in my config:</p>
<pre><code>$ grep 'experimental' ~/.config/nix/nix.conf
experimental-features = nix-command flakes
</code></pre>
<p>And now when I run <code>nix search</code>:</p>
<pre tabindex=0><code>$ nix search git
error: cannot find flake 'flake:git' in the flake registries
</code></pre><p>Hmm. Nothing about how to fix that, so I suppose I’ll have to start studying.</p>
<p>The release announcement links to <a href=https://www.tweag.io/blog/2020-05-25-flakes/>this blog post</a> as an introduction to flakes, so I suppose I’ll start there.</p>
<p>But first: I have <em>heard</em> of flakes over the course of my regular Nix usage this year. I am not coming in blind; I am vaguely aware of the feature already. My shaky half-understanding going into all of this is:</p>
<ul>
<li>it’s a new way to download Nix expressions from the internet that replaces “channels”</li>
<li>it’s a way to import Nix expressions from elsewhere on the internet, instead of just <code>NIX_PATH</code></li>
<li>it makes it easy to pin/lock dependencies without resorting to a third-party tool like <a href=https://github.com/nmattia/niv>niv</a></li>
<li>it makes it easy to install software that is <em>not</em> packaged in Nixpkgs, so you can easily distribute your own software without getting it merged into the Nixpkgs monorepo</li>
<li>it’s ergonomically <em>very unpleasant</em> to write <code>flake.nix</code> files, and a lot of people are upset about that</li>
</ul>
<p>I am <em>hopeful</em> that flakes will make it possible to break up the Nixpkgs monolith, so that you can depend on, like, helper functions or the build infrastructure without also having to download every package description for every Haskell package ever published or whatever.</p>
<p>But I don’t actually <em>know</em> any of those things. So let’s dive in and try to find out more.</p>
<h1 id=nix-flakes-part-1-an-introduction-and-tutorialhttpswwwtweagioblog2020-05-25-flakes><a href=https://www.tweag.io/blog/2020-05-25-flakes/>Nix Flakes, Part 1: An introduction and tutorial</a></h1>
<blockquote>
<p>A flake is simply a source tree (such as a Git repository) containing a file named <code>flake.nix</code> that provides a standardized interface to Nix artifacts such as packages or NixOS modules. Flakes can have dependencies on other flakes, with a “lock file” pinning those dependencies to exact revisions to ensure reproducible evaluation.</p>
</blockquote>
<p>Okay, simple enough. Nothing about the “flake registry” yet… but it’s going into a simple example of a project called <a href=https://github.com/edolstra/dwarffs><code>dwarffs</code></a>. Let’s take a look at its <a href=https://github.com/edolstra/dwarffs/blob/f691e2c991e75edb22836f1dbe632c40324215c5/flake.nix><code>flake.nix</code> file</a>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A filesystem that fetches DWARF debug info from the Internet on demand"</span><span class=p>;</span>

  <span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>follows</span> <span class=o>=</span> <span class=s2>"nix/nixpkgs"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nix</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span>

    <span class=k>let</span>
      <span class=n>supportedSystems</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"x86_64-linux"</span> <span class=s2>"i686-linux"</span> <span class=s2>"aarch64-linux"</span> <span class=p>];</span>
      <span class=n>forAllSystems</span> <span class=o>=</span> <span class=n>f</span><span class=p>:</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>genAttrs</span> <span class=n>supportedSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=n>f</span> <span class=n>system</span><span class=p>);</span>
      <span class=n>version</span> <span class=o>=</span> <span class=s2>"0.1.</span><span class=si>${</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>substring</span> <span class=mi>0</span> <span class=mi>8</span> <span class=n>self</span><span class=o>.</span><span class=n>lastModifiedDate</span><span class=si>}</span><span class=s2>.</span><span class=si>${</span><span class=n>self</span><span class=o>.</span><span class=n>shortRev</span> <span class=n>or</span> <span class=s2>"dirty"</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
    <span class=k>in</span>

    <span class=p>{</span>

      <span class=n>overlay</span> <span class=o>=</span> <span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>

        <span class=n>dwarffs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>final</span><span class=p>;</span> <span class=k>let</span> <span class=n>nix</span> <span class=o>=</span> <span class=n>final</span><span class=o>.</span><span class=n>nix</span><span class=p>;</span> <span class=k>in</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
          <span class=n>name</span> <span class=o>=</span> <span class=s2>"dwarffs-</span><span class=si>${</span><span class=n>version</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>

          <span class=n>buildInputs</span> <span class=o>=</span> <span class=p>[</span> <span class=n>fuse</span> <span class=n>nix</span> <span class=n>nlohmann_json</span> <span class=n>boost</span> <span class=p>];</span>

          <span class=n>NIX_CFLAGS_COMPILE</span> <span class=o>=</span> <span class=s2>"-I </span><span class=si>${</span><span class=n>nix</span><span class=o>.</span><span class=n>dev</span><span class=si>}</span><span class=s2>/include/nix -include </span><span class=si>${</span><span class=n>nix</span><span class=o>.</span><span class=n>dev</span><span class=si>}</span><span class=s2>/include/nix/config.h -D_FILE_OFFSET_BITS=64 -DVERSION=</span><span class=se>\"</span><span class=si>${</span><span class=n>version</span><span class=si>}</span><span class=se>\"</span><span class=s2>"</span><span class=p>;</span>

          <span class=n>src</span> <span class=o>=</span> <span class=n>self</span><span class=p>;</span>

          <span class=n>installPhase</span> <span class=o>=</span>
            <span class=s1>''
</span><span class=s1>              mkdir -p $out/bin $out/lib/systemd/system
</span><span class=s1>
</span><span class=s1>              cp dwarffs $out/bin/
</span><span class=s1>              ln -s dwarffs $out/bin/mount.fuse.dwarffs
</span><span class=s1>
</span><span class=s1>              cp </span><span class=si>${</span><span class=sr>./run-dwarffs.mount</span><span class=si>}</span><span class=s1> $out/lib/systemd/system/run-dwarffs.mount
</span><span class=s1>              cp </span><span class=si>${</span><span class=sr>./run-dwarffs.automount</span><span class=si>}</span><span class=s1> $out/lib/systemd/system/run-dwarffs.automount
</span><span class=s1>            ''</span><span class=p>;</span>
        <span class=p>};</span>

      <span class=p>};</span>

      <span class=n>defaultPackage</span> <span class=o>=</span> <span class=n>forAllSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>(</span><span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span>
        <span class=k>inherit</span> <span class=n>system</span><span class=p>;</span>
        <span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>overlay</span> <span class=n>nix</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
      <span class=p>})</span><span class=o>.</span><span class=n>dwarffs</span><span class=p>);</span>

      <span class=n>checks</span> <span class=o>=</span> <span class=n>forAllSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>{</span>
        <span class=n>build</span> <span class=o>=</span> <span class=n>self</span><span class=o>.</span><span class=n>defaultPackage</span><span class=o>.</span><span class=si>${</span><span class=n>system</span><span class=si>}</span><span class=p>;</span>

        <span class=n>test</span> <span class=o>=</span>
          <span class=k>with</span> <span class=kn>import</span> <span class=p>(</span><span class=n>nixpkgs</span> <span class=o>+</span> <span class=s2>"/nixos/lib/testing-python.nix"</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>inherit</span> <span class=n>system</span><span class=p>;</span>
          <span class=p>};</span>

          <span class=n>makeTest</span> <span class=p>{</span>
            <span class=n>nodes</span> <span class=o>=</span> <span class=p>{</span>
              <span class=n>client</span> <span class=o>=</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}:</span> <span class=p>{</span>
                <span class=n>imports</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>nixosModules</span><span class=o>.</span><span class=n>dwarffs</span> <span class=p>];</span>
                <span class=n>nixpkgs</span><span class=o>.</span><span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>nix</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
              <span class=p>};</span>
            <span class=p>};</span>

            <span class=n>testScript</span> <span class=o>=</span>
              <span class=s1>''
</span><span class=s1>                start_all()
</span><span class=s1>                client.wait_for_unit("multi-user.target")
</span><span class=s1>                client.succeed("dwarffs --version")
</span><span class=s1>                client.succeed("cat /run/dwarffs/README")
</span><span class=s1>                client.succeed("[ -e /run/dwarffs/.build-id/00 ]")
</span><span class=s1>              ''</span><span class=p>;</span>
          <span class=p>};</span>
      <span class=p>});</span>

      <span class=n>nixosModules</span><span class=o>.</span><span class=n>dwarffs</span> <span class=o>=</span>
        <span class=p>{</span> <span class=n>pkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
        <span class=p>{</span>
          <span class=n>nixpkgs</span><span class=o>.</span><span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>

          <span class=n>systemd</span><span class=o>.</span><span class=n>packages</span> <span class=o>=</span> <span class=p>[</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>dwarffs</span> <span class=p>];</span>

          <span class=n>system</span><span class=o>.</span><span class=n>fsPackages</span> <span class=o>=</span> <span class=p>[</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>dwarffs</span> <span class=p>];</span>

          <span class=n>systemd</span><span class=o>.</span><span class=n>units</span><span class=o>.</span><span class=s2>"run-dwarffs.automount"</span><span class=o>.</span><span class=n>wantedBy</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"multi-user.target"</span> <span class=p>];</span>

          <span class=n>environment</span><span class=o>.</span><span class=n>variables</span><span class=o>.</span><span class=n>NIX_DEBUG_INFO_DIRS</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"/run/dwarffs"</span> <span class=p>];</span>

          <span class=n>systemd</span><span class=o>.</span><span class=n>tmpfiles</span><span class=o>.</span><span class=n>rules</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"d /var/cache/dwarffs 0755 dwarffs dwarffs 7d"</span> <span class=p>];</span>

          <span class=n>users</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>dwarffs</span> <span class=o>=</span>
            <span class=p>{</span> <span class=n>description</span> <span class=o>=</span> <span class=s2>"Debug symbols file system daemon user"</span><span class=p>;</span>
              <span class=n>group</span> <span class=o>=</span> <span class=s2>"dwarffs"</span><span class=p>;</span>
              <span class=n>isSystemUser</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
            <span class=p>};</span>

          <span class=n>users</span><span class=o>.</span><span class=n>groups</span><span class=o>.</span><span class=n>dwarffs</span> <span class=o>=</span> <span class=p>{};</span>
        <span class=p>};</span>

    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>Wow! That’s a lot. I don’t… I don’t think this a very good starting point. I can sort of squint and ignore most of it:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A filesystem that fetches DWARF debug info from the Internet on demand"</span><span class=p>;</span>

  <span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>follows</span> <span class=o>=</span> <span class=s2>"nix/nixpkgs"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nix</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span>
    <span class=k>let</span>
      <span class=n>supportedSystems</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"x86_64-linux"</span> <span class=s2>"i686-linux"</span> <span class=s2>"aarch64-linux"</span> <span class=p>];</span>
      <span class=n>forAllSystems</span> <span class=o>=</span> <span class=n>f</span><span class=p>:</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>genAttrs</span> <span class=n>supportedSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=n>f</span> <span class=n>system</span><span class=p>);</span>
      <span class=n>version</span> <span class=o>=</span> <span class=s2>"0.1.</span><span class=si>${</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>substring</span> <span class=mi>0</span> <span class=mi>8</span> <span class=n>self</span><span class=o>.</span><span class=n>lastModifiedDate</span><span class=si>}</span><span class=s2>.</span><span class=si>${</span><span class=n>self</span><span class=o>.</span><span class=n>shortRev</span> <span class=n>or</span> <span class=s2>"dirty"</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
    <span class=k>in</span>
    <span class=p>{</span>
      <span class=n>overlay</span> <span class=o>=</span> <span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span> <span class=n>dwarffs</span> <span class=o>=</span> <span class=o>...</span><span class=p>;</span> <span class=p>};</span>
      <span class=n>defaultPackage</span> <span class=o>=</span> <span class=n>forAllSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>(</span><span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span>
        <span class=k>inherit</span> <span class=n>system</span><span class=p>;</span>
        <span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>overlay</span> <span class=n>nix</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
      <span class=p>})</span><span class=o>.</span><span class=n>dwarffs</span><span class=p>);</span>
      <span class=n>checks</span> <span class=o>=</span> <span class=n>forAllSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>{</span> <span class=o>...</span> <span class=p>});</span>
      <span class=n>nixosModules</span><span class=o>.</span><span class=n>dwarffs</span> <span class=o>=</span> <span class=o>...</span><span class=p>;</span>
    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>So it has <code>description</code>, <code>inputs</code>, and <code>outputs</code>. Remember that that input line is just shorthand for:</p>
<pre><code>inputs = { nixpkgs = { follows = "nix/nixpkgs"; }; };
</code></pre>
<p>We can also see all the boilerplate that I have heard complaints about – the <code>forAllSystems</code> stuff. So in order to reasonably <em>define</em> a flake, you sort of have to include Nixpkgs as one of your dependencies, because the helpers you need in order to define flakes live in Nixpkgs. Even though they <em>could</em> just live in a separate <code>flake-helpers</code> repo or something.</p>
<p>Of course, there is nothing stopping us from making our own <code>flake-helpers</code> repo and using it instead, as we’re no longer restricted to treating Nixpkgs like the only source of Nix expressions.</p>
<p>There is also a <a href=https://github.com/edolstra/dwarffs/blob/f691e2c991e75edb22836f1dbe632c40324215c5/flake.lock><code>flake.lock</code> file</a>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"nodes"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"lowdown-src"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"flake"</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
      <span class=nt>"locked"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"lastModified"</span><span class=p>:</span> <span class=mi>1598695561</span><span class=p>,</span>
        <span class=nt>"narHash"</span><span class=p>:</span> <span class=s2>"sha256-gyH/5j+h/nWw0W8AcR2WKvNBUsiQ7QuxqSJNXAwV+8E="</span><span class=p>,</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"kristapsdz"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"lowdown"</span><span class=p>,</span>
        <span class=nt>"rev"</span><span class=p>:</span> <span class=s2>"1705b4a26fbf065d9574dce47a94e8c7c79e052f"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>},</span>
      <span class=nt>"original"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"kristapsdz"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"lowdown"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>"nix"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"inputs"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"lowdown-src"</span><span class=p>:</span> <span class=s2>"lowdown-src"</span><span class=p>,</span>
        <span class=nt>"nixpkgs"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span>
      <span class=p>},</span>
      <span class=nt>"locked"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"lastModified"</span><span class=p>:</span> <span class=mi>1610390819</span><span class=p>,</span>
        <span class=nt>"narHash"</span><span class=p>:</span> <span class=s2>"sha256-XE2ajw0BOtmEksRfeY5+CKN8PNlZnsMGL73sxykdQdM="</span><span class=p>,</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"NixOS"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"nix"</span><span class=p>,</span>
        <span class=nt>"rev"</span><span class=p>:</span> <span class=s2>"6254b1f5d298ff73127d7b0f0da48f142bdc753c"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>},</span>
      <span class=nt>"original"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"nix"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>"nixpkgs"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"locked"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"lastModified"</span><span class=p>:</span> <span class=mi>1602702596</span><span class=p>,</span>
        <span class=nt>"narHash"</span><span class=p>:</span> <span class=s2>"sha256-fqJ4UgOb4ZUnCDIapDb4gCrtAah5Rnr2/At3IzMitig="</span><span class=p>,</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"NixOS"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"rev"</span><span class=p>:</span> <span class=s2>"ad0d20345219790533ebe06571f82ed6b034db31"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>},</span>
      <span class=nt>"original"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"ref"</span><span class=p>:</span> <span class=s2>"nixos-20.09-small"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>"root"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"inputs"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"nix"</span><span class=p>:</span> <span class=s2>"nix"</span><span class=p>,</span>
        <span class=nt>"nixpkgs"</span><span class=p>:</span> <span class=p>[</span>
          <span class=s2>"nix"</span><span class=p>,</span>
          <span class=s2>"nixpkgs"</span>
        <span class=p>]</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>"root"</span><span class=p>:</span> <span class=s2>"root"</span><span class=p>,</span>
  <span class=nt>"version"</span><span class=p>:</span> <span class=mi>7</span>
<span class=p>}</span>
</code></pre></div><p>Which appears to be JSON.</p>
<p>I’m not really sure what <code>lowdown-src</code> is, or where that came from? There’s no mention of that in the <code>flake.nix</code> file. But it seems that <code>nixpkgs</code> depends on <code>nix</code>, which depends on <code>lowdown-src</code>. Huh. And indeed, we can see that if we look at the <a href=https://github.com/NixOS/nix/blob/2e606e87c44a8dc42664f8938eac1d4b63047dd6/flake.nix>flake.nix file for Nix itself</a>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"The purely functional package manager"</span><span class=p>;</span>

  <span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>"nixpkgs/nixos-21.05-small"</span><span class=p>;</span>
  <span class=n>inputs</span><span class=o>.</span><span class=n>lowdown-src</span> <span class=o>=</span> <span class=p>{</span> <span class=n>url</span> <span class=o>=</span> <span class=s2>"github:kristapsdz/lowdown"</span><span class=p>;</span> <span class=n>flake</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span> <span class=p>};</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=o>...</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Interesting! <a href=https://github.com/kristapsdz/lowdown>Lowdown seems to be a markdown parser</a>, presumably one that Nix uses to generate its new manual/man pages.</p>
<p>That’s <em>weird</em>, right?</p>
<p>Like, it sounds like a build-time dependency; it sounds like an implementation detail of Nix. It does not sound like something that anyone depending on Nixpkgs should pull in.</p>
<p>And maybe they don’t; I don’t really have any sense of what this means yet. But it seems <em>weird</em>.</p>
<p>Oh, I’m supposed to be using <code>nix flake</code> commands to inspect all of this. I’m not supposed to be looking at the raw files. Let’s give that a shot:</p>
<pre tabindex=0><code>$ nix flake metadata github:edolstra/dwarffs
Resolved URL:  github:edolstra/dwarffs
Locked URL:    github:edolstra/dwarffs/f691e2c991e75edb22836f1dbe632c40324215c5
Description:   A filesystem that fetches DWARF debug info from the Internet on demand
Path:          /nix/store/769s05vjydmc2lcf6b02az28wsa9ixh1-source
Revision:      f691e2c991e75edb22836f1dbe632c40324215c5
Last modified: 2021-01-21 06:41:26
Inputs:
├───nix: github:NixOS/nix/6254b1f5d298ff73127d7b0f0da48f142bdc753c
│   ├───lowdown-src: github:kristapsdz/lowdown/1705b4a26fbf065d9574dce47a94e8c7c79e052f
│   └───nixpkgs: github:NixOS/nixpkgs/ad0d20345219790533ebe06571f82ed6b034db31
└───nixpkgs follows input 'nix/nixpkgs'
</code></pre><p>We only have an explicit dependency on Nixpkgs, but <code>nix</code> is listed here. So I guess that this line:</p>
<pre tabindex=0><code>inputs.nixpkgs.follows = "nix/nixpkgs";
</code></pre><p>Means “I depend on whatever version of Nixpkgs that Nix itself depends on?” Okay. So Nixpkgs doesn’t depend on Nix; it’s the other way around. So <code>lowdown-src</code> is probably <em>not</em> infecting any other projects. Got it got it. Still getting my bearings here.</p>
<p>Let’s see if I’m right:</p>
<pre tabindex=0><code>$ nix flake metadata github:nixos/nixpkgs
Resolved URL:  github:nixos/nixpkgs
Locked URL:    github:nixos/nixpkgs/e98afa97d3554e00661e436ba5ab5938d40bc761
Description:   A collection of packages for the Nix package manager
Path:          /nix/store/xh4gyysicnjk9kbsxcxykmk85chqc12f-source
Revision:      e98afa97d3554e00661e436ba5ab5938d40bc761
Last modified: 2021-12-05 12:16:45
Inputs:
</code></pre><p>Okay, so no inputs. Good good. The world is in order.</p>
<p>You can’t see it in this blog post, but these commands come with nice little animated download progress spinner thingies.</p>
<p>That command took a <em>really long time</em> to run, even after the download completed. But subsequent invocations were basically instantaneous. So… huh. I don’t know how to explain that.</p>
<p>Anyway. Then we learn:</p>
<pre tabindex=0><code>$ nix flake show github:edolstra/dwarffs
github:edolstra/dwarffs/f691e2c991e75edb22836f1dbe632c40324215c5
├───checks
│   ├───aarch64-linux
│   │   ├───build: derivation 'dwarffs-0.1.20210121.f691e2c'
│   │   └───test: derivation 'vm-test-run-unnamed'
│   ├───i686-linux
│   │   ├───build: derivation 'dwarffs-0.1.20210121.f691e2c'
│   │   └───test: derivation 'vm-test-run-unnamed'
│   └───x86_64-linux
│       ├───build: derivation 'dwarffs-0.1.20210121.f691e2c'
│       └───test: derivation 'vm-test-run-unnamed'
├───defaultPackage
│   ├───aarch64-linux: package 'dwarffs-0.1.20210121.f691e2c'
│   ├───i686-linux: package 'dwarffs-0.1.20210121.f691e2c'
│   └───x86_64-linux: package 'dwarffs-0.1.20210121.f691e2c'
├───nixosModules
│   └───dwarffs: NixOS module
└───overlay: Nixpkgs overlay
</code></pre><p>Okay. That’s <em>about</em> what I hacked the <code>flake.nix</code> file into showing. Interesting that some of these things are <em>derivations</em> (under the <code>checks</code> attribute), but some of these things are <em>packages</em>. I have no idea what “package” means in the Nix world, but hopefully I will find out.</p>
<blockquote>
<p>While a flake can have arbitrary outputs, some of them, if they exist, have a special meaning to certain Nix commands and therefore must have a specific type. For example, the output <code>defaultPackage.&lt;system&gt;</code> must be a derivation; it’s what <code>nix build</code> and <code>nix shell</code> will build by default unless you specify another output.</p>
</blockquote>
<p>Okay, so… why is it called a package, then? If it’s just a derivation? That’s… this is confusing.</p>
<p>I look back at the original source, which defines these as:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>defaultPackage</span> <span class=err>=</span> <span class=n>forAllSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>(</span><span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span>
  <span class=k>inherit</span> <span class=n>system</span><span class=p>;</span>
  <span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>overlay</span> <span class=n>nix</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
<span class=p>})</span><span class=o>.</span><span class=n>dwarffs</span><span class=p>);</span>
</code></pre></div><p>So… this is a little bit of strange indirection, but basically we’re adding <code>nixpkgs.dwarffs</code> using an overlay, and then looking up the result of applying that overlay.</p>
<p>The overlay just defines it as a normal derivation:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>overlay</span> <span class=err>=</span> <span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>

  <span class=n>dwarffs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>final</span><span class=p>;</span> <span class=k>let</span> <span class=n>nix</span> <span class=o>=</span> <span class=n>final</span><span class=o>.</span><span class=n>nix</span><span class=p>;</span> <span class=k>in</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
    <span class=n>name</span> <span class=o>=</span> <span class=s2>"dwarffs-</span><span class=si>${</span><span class=n>version</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
    <span class=o>...</span>
  <span class=p>};</span>
<span class=p>};</span>
</code></pre></div><p>So no idea why it reports it as a package, or what makes a package different from a derivation. Very confusing.</p>
<p>Maybe we’ll get to it if we keep reading.</p>
<blockquote>
<p>The <code>nix</code> CLI allows you to specify another output through a syntax reminiscent of URL fragments:</p>
<pre tabindex=0><code>$ nix build github:edolstra/dwarffs#checks.aarch64-linux.build
</code></pre></blockquote>
<p>Okay. Do we have to type out the platform name, though? I guess I don’t really know when I would ever do this, so maybe it isn’t cumbersome in practice. I don’t really know how to reason about “multi-output flakes” when we already have “multi-output derivations” or how they might differ. I guess that something like <code>nixpkgs</code> probably doesn’t have a <code>defaultPackage</code> thing. That makes sense.</p>
<blockquote>
<p>By the way, the standard <code>checks</code> output specifies a set of derivations to be built by a continuous integration system such as Hydra. Because flake evaluation is hermetic and the lock file locks all dependencies, it’s guaranteed that the <code>nix build</code> command above will evaluate to the same result as the one in the CI system.</p>
</blockquote>
<p>I was wondering about <code>checks</code>. That’s pretty neat? I like that this is a first-class thing.</p>
<h2 id=the-flake-registry>The Flake Registry</h2>
<p>Okay, here we go.</p>
<blockquote>
<p>Flake locations are specified using a URL-like syntax such as <code>github:edolstra/dwarffs</code> or <code>git+https://github.com/NixOS/patchelf</code>. But because such URLs would be rather verbose if you had to type them all the time on the command line, there also is a flake registry that maps symbolic identifiers such as <code>nixpkgs</code> to actual locations like <code>https://github.com/NixOS/nixpkgs</code>. So the following are (by default) equivalent:</p>
<pre tabindex=0><code>$ nix shell nixpkgs#cowsay --command cowsay Hi!
$ nix shell github:NixOS/nixpkgs#cowsay --command cowsay Hi!
</code></pre></blockquote>
<p>Alright. This section introduces us to the <code>nix registry</code> subcommand, and I learn that I can try <code>nix registry list</code>, because I am curious if I have a <code>nixpkgs</code> entry “by default” after upgrading.</p>
<pre tabindex=0><code>$ nix registry list
global flake:blender-bin github:edolstra/nix-warez?dir=blender
global flake:dwarffs github:edolstra/dwarffs
global flake:hydra github:NixOS/hydra
global flake:mach-nix github:DavHau/mach-nix
global flake:nimble github:nix-community/flake-nimble
global flake:nix github:NixOS/nix
global flake:nixops github:NixOS/nixops
global flake:nixos-hardware github:NixOS/nixos-hardware
global flake:nixos-homepage github:NixOS/nixos-homepage/flake
global flake:nur github:nix-community/NUR
global flake:nixpkgs github:NixOS/nixpkgs
global flake:templates github:NixOS/templates
global flake:patchelf github:NixOS/patchelf
global flake:nix-serve github:edolstra/nix-serve
global flake:nickel github:tweag/nickel
</code></pre><p>Wow, what? That’s a <em>lot!</em> <code>blender-bin</code>?? What… what is all of this stuff? What is <code>nix-warez</code>? It is obviously <a href=https://github.com/edolstra/nix-warez>a GitHub repository</a>, and it contains… Baldur’s Gate? As two of the five things here. Weird weird weird.</p>
<p>Okay, so we have a pretty large and robust default flake registry.</p>
<p>I thought that my search was failing because I needed to do something to initialize my package registry. But apparently not?</p>
<pre><code>$ nix search git
error: cannot find flake 'flake:git' in the flake registries
</code></pre>
<p>So apparently I need to search <code>nixpkgs</code> now…?</p>
<pre><code>$ nix search nixpkgs
</code></pre>
<p>I tried running that by itself but it’s kind of just… hanging. Oh, and then it printed out every package in the universe. Okay.</p>
<pre><code>$ nix search nixpkgs git
</code></pre>
<p>So initially I thought that it felt slower than the old search, and then I realized that it was respecting the fact that I have <code>NIX_PAGER=</code> set, so I could see the speed that it printed results. When I pipe into <code>less</code>, I can see that it’s printing output faster than I can scroll through it. And all without needing to update a cache? That’s pretty great.</p>
<aside>
<p>I don’t really know what I was thinking when I wrote this.</p>
<p>The old <code>nix search</code> also respected <code>NIX_PAGER</code>, although I guess I just got used to piping it into <code>less</code> whenever I called it. But it was also <em>much</em> faster.</p>
<p>Here’s Nix 2.3.15:</p>
<pre><code>$ time nix search git &gt;/dev/null
warning: using cached results; pass '-u' to update the cache
0.92s user 0.03s system 98% cpu 0.967 total
</code></pre>
<p>And here’s how long it takes to repopulate the cache:</p>
<pre><code>$ time nix search -u git &gt;/dev/null
15.88s user 5.63s system 53% cpu 39.989 total
</code></pre>
<p>Meanwhile, here’s 2.4:</p>
<pre><code>$ time nix search nixpkgs git &gt;/dev/null
24.23s user 36.00s system 89% cpu 1:06.96 total
</code></pre>
<p>A full minute.</p>
<p>It had to download something, for some reason, even though I haven’t asked it to update anything and I know I just ran this command yesterday (I added this <code>&lt;aside&gt;</code> the day after I wrote this post).</p>
<p>I have a terrible feeling that Nix may have inherited the worst feature of Homebrew: deciding to update packages at the <em>one moment</em> that I’m trying to use it to do something. Maybe not, though. Maybe installing an old version of Nix with <code>nix-shell -p</code> confused it? I don’t know.</p>
<p>In any case, yes, it took longer to search that. But perhaps it’s unfair to count that download time (<em>What was it downloading?</em> It didn’t say. It just showed a progress spinner.)</p>
<pre tabindex=0><code>$ time nix search nixpkgs git &gt;/dev/null
1.90s user 0.08s system 95% cpu 2.085 total
</code></pre><p>So two seconds instead of one second. That’s not really that bad.</p>
<p>It <em>feels</em> much slower, but I think that might be a trick.</p>
<p>I think that the old Nix search spent 90% of its time thinking, and then almost no time printing out output. So it paused for a second, and then <em>felt</em> instantaneous.</p>
<p>The new Nix 2.4 search prints results out as it finds them, so you can “feel” it taking more time. And, I mean, it is taking more time – twice as long! – but the time scales here are not as egregious as they feel. Remember:</p>
<pre><code>$ time brew search git &gt;/dev/null
4.81s user 3.21s system 58% cpu 13.661 total
</code></pre>
<p>Given the choice obviously I prefer a one second search to a two second search, but that’s not really a fair comparison, because of the amortized cost of cache updates. Or the intangible cost of seeing stale search results because I <em>forgot</em> to update my cache.</p>
</aside>
<p>Okay. I realize that <code>nix search git</code> is a little more intuitive than <code>nix search nixpkgs git</code>. But I personally prefer the explicitness of this; I never really understood <em>what</em> <code>nix search</code> was actually searching, with Nix 2.3. Just <code>nixpkgs</code>? Everything on my <code>NIX_PATH</code>? I never knew. But now it’s clear.</p>
<p>Let’s try searching another “flake:”</p>
<pre><code>$ nix search nur git
error: cannot write modified lock file of flake 'flake:nur' (use '--no-write-lock-file' to ignore)
</code></pre>
<p>What? Why? Other flakes seem to work:</p>
<pre><code>$ nix search nixops git
error: no results for the given search term(s)!

$ nix search nimble git
error: no results for the given search term(s)!
</code></pre>
<p>What’s different about <code>nur</code>?</p>
<pre><code>$ nix search nur git --show-trace
error: cannot write modified lock file of flake 'flake:nur' (use '--no-write-lock-file' to ignore)

       … while updating the lock file of flake 'github:nix-community/NUR/a47ee757c61690b442324d60812c3269fecb9916'
</code></pre>
<p>That doesn’t really tell me anything.</p>
<p>What’s going on here? Where do these lockfiles live? Where does the registry live?</p>
<p>I don’t see anything likely in my home directory. Nor are there any new subdirectories in <code>/nix/var/nix</code>.</p>
<pre><code>$ sqlite3 /nix/var/nix/db/db.sqlite .schema
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>ValidPaths</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>id</span><span class=w>               </span><span class=nb>integer</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=n>autoincrement</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>path</span><span class=w>             </span><span class=nb>text</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>hash</span><span class=w>             </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>registrationTime</span><span class=w> </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>deriver</span><span class=w>          </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>narSize</span><span class=w>          </span><span class=nb>integer</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>ultimate</span><span class=w>         </span><span class=nb>integer</span><span class=p>,</span><span class=w> </span><span class=c1>-- null implies "false"
</span><span class=c1></span><span class=w>    </span><span class=n>sigs</span><span class=w>             </span><span class=nb>text</span><span class=p>,</span><span class=w> </span><span class=c1>-- space-separated
</span><span class=c1></span><span class=w>    </span><span class=n>ca</span><span class=w>               </span><span class=nb>text</span><span class=w> </span><span class=c1>-- if not null, an assertion that the path is content-addressed; see ValidPathInfo
</span><span class=c1></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sqlite_sequence</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=n>seq</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>Refs</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>referrer</span><span class=w>  </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>reference</span><span class=w> </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>reference</span><span class=p>),</span><span class=w>
</span><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>referrer</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>ValidPaths</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>cascade</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>reference</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>ValidPaths</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>restrict</span><span class=w>
</span><span class=w></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>IndexReferrer</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>Refs</span><span class=p>(</span><span class=n>referrer</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>IndexReference</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>Refs</span><span class=p>(</span><span class=n>reference</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TRIGGER</span><span class=w> </span><span class=n>DeleteSelfRefs</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>ValidPaths</span><span class=w>
</span><span class=w>  </span><span class=k>begin</span><span class=w>
</span><span class=w>    </span><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Refs</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>referrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>old</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>reference</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>old</span><span class=p>.</span><span class=n>id</span><span class=p>;</span><span class=w>
</span><span class=w>  </span><span class=k>end</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>DerivationOutputs</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>drv</span><span class=w>  </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>id</span><span class=w>   </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w> </span><span class=c1>-- symbolic output id, usually "out"
</span><span class=c1></span><span class=w>    </span><span class=n>path</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>drv</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>),</span><span class=w>
</span><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>drv</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>ValidPaths</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>cascade</span><span class=w>
</span><span class=w></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>IndexDerivationOutputs</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>DerivationOutputs</span><span class=p>(</span><span class=n>path</span><span class=p>);</span><span class=w>
</span></code></pre></div><p>Some new stuff in there for content-addressed paths, but nothing about flakes. Which is expected: the store shouldn’t really know anything about them.</p>
<p>But I’m sort of running out of places to look. I know Nix stores stuff in <code>~/.cache</code>, but nothing… important, right?</p>
<pre tabindex=0><code>$ ls ~/.cache/nix
binary-cache-v5.sqlite
binary-cache-v5.sqlite-journal
binary-cache-v6.sqlite
binary-cache-v6.sqlite-journal
eval-cache-v2/
fetcher-cache-v1.sqlite
fetcher-cache-v1.sqlite-journal
flake-registry.json@ -&gt; /nix/store/qi48i5dkbffrdxc15rhdz1x4mpm6q6n3-flake-registry.json
gitv2/
package-search.json
tarballs/
</code></pre><p>Aha. <code>flake-registry.json</code> certainly sounds promising.</p>
<pre><code>$ cat /nix/store/qi48i5dkbffrdxc15rhdz1x4mpm6q6n3-flake-registry.json
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"flakes"</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>"from"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"nur"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>},</span>
      <span class=nt>"to"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"nix-community"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"NUR"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>"from"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>},</span>
      <span class=nt>"to"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"NixOS"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=err>...</span>
  <span class=p>],</span>
  <span class=nt>"version"</span><span class=p>:</span> <span class=mi>2</span>
<span class=p>}</span>
</code></pre></div><p>So <code>nur</code> doesn’t look any different from <code>nixpkgs</code>. Hmm. This is all very strange. Perhaps it will explain where the lock files live, if I keep reading.</p>
<h2 id=writing-your-first-flake>Writing your first flake</h2>
<p>The next thing the blog post describes is writing my own <code>flake.nix</code> file. It looks… easy?</p>
<p>Let’s try it. I wrote <a href=https://ianthehenry.com/posts/sd-my-script-directory/>a little tool called <code>sd</code></a> that is 1) useful and 2) not in Nixpkgs. Maybe I can make a flake out of it, so that people could install it with Nix, if they wanted to.</p>
<p>It’s literally just a shell script, so hopefully it won’t be too difficult to package.</p>
<pre tabindex=0><code>$ cd ~/src/sd

$ nix flake init

$ cat flake.nix
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A very basic flake"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span> <span class=p>{</span>

    <span class=n>packages</span><span class=o>.</span><span class=n>x86_64-linux</span><span class=o>.</span><span class=n>hello</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>legacyPackages</span><span class=o>.</span><span class=n>x86_64-linux</span><span class=o>.</span><span class=n>hello</span><span class=p>;</span>

    <span class=n>defaultPackage</span><span class=o>.</span><span class=n>x86_64-linux</span> <span class=o>=</span> <span class=n>self</span><span class=o>.</span><span class=n>packages</span><span class=o>.</span><span class=n>x86_64-linux</span><span class=o>.</span><span class=n>hello</span><span class=p>;</span>

  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>Okay. Strange. I’m on <code>x86_64-darwin</code>, first of all. Second of all… where the heck does <code>nixpkgs</code> come from? There are no inputs here. Does it… <em>implicitly</em> depend on <code>nixpkgs</code>?</p>
<pre tabindex=0><code>$ nix flake metadata
warning: Git tree '/Users/ian/src/sd' is dirty
warning: creating lock file '/Users/ian/src/sd/flake.lock'
warning: Git tree '/Users/ian/src/sd' is dirty
Resolved URL:  git+file:///Users/ian/src/sd
Locked URL:    git+file:///Users/ian/src/sd
Description:   A very basic flake
Path:          /nix/store/ikqp3gx8c796gpc3s8ggsjd5xzz1sk84-source
Last modified: 2021-12-05 09:05:48
Inputs:
└───nixpkgs: github:NixOS/nixpkgs/e1e7c171a258fc15424b22a1566d9af530784aa7
</code></pre><p>Apparently… yes? This behavior has not been described yet, though. It certainly <em>feels weird</em> to me. I would expect it to be just explicitly listed in the new flake template, instead of defaulted by whatever part of Nix is evaluating this. Hmm.</p>
<blockquote>
<p>The <code>outputs</code> attribute is the heart of the flake: it’s a function that produces an attribute set. The function arguments are the flakes specified in <code>inputs</code>.</p>
<p>The <code>self</code> argument denotes this flake. Its primarily useful for referring to the source of the flake (as in <code>src = self;</code>) or to other outputs (e.g. <code>self.defaultPackage.x86_64-linux</code>).</p>
</blockquote>
<p>So that’s interesting. <code>src = self;</code> – so a flake is like… a first class value, that is an attribute set but also a path? Or something? I don’t really know how to reason about this. It goes on to say:</p>
<blockquote>
<p>Every flake has some metadata, such as <code>self.lastModifiedDate</code>, which is used to generate a version string like <code>hello-20191015</code>.</p>
</blockquote>
<p>So flakes are like… they’re like derivations, in that they are magic things that sort of look like they’re just attribute sets but secretly they’re something slightly different? And there are no types anywhere, so we just have to guess and check until we gain some kind of intuition for how they behave.</p>
<p>But how do I <em>observe</em> a flake? Let’s try the repl.</p>
<pre tabindex=0><code>$ nix repl
nix-repl&gt; import ./.
error: opening file '/Users/ian/src/sd/default.nix': No such file or directory
</code></pre><p>Okay, so not quite. And if I just:</p>
<pre tabindex=0><code>nix-repl&gt; import ./flake.nix
{ description = "A very basic flake"; outputs = «lambda @ /Users/ian/src/sd/flake.nix:4:13»; }
</code></pre><p>Then I just import it as a raw attribute set – aka, as the thing that it looks like. It would be weird if it <em>didn’t</em> import it as a regular file – how does it <em>know</em> that it’s a flake?</p>
<p>But how do any other commands know? Are flakes built into the language? Or… if not, what is adding the magic <code>lastModifiedDate</code> metadata thing, and how can I observe it?</p>
<p>Presumably by using the <code>nix flake</code> subcommands. But they aren’t showing me the <em>value</em> of the flake. They’re just showing me these pretty human-readable things. I want to see the raw thing, somehow.</p>
<p>Here are my options, from <code>nix flake --help</code>:</p>
<pre tabindex=0><code>· nix flake archive - copy a flake and all its inputs to a store
· nix flake check - check whether the flake evaluates and run its tests
· nix flake clone - clone flake repository
· nix flake info - show flake metadata
· nix flake init - create a flake in the current directory from a template
· nix flake lock - create missing lock file entries
· nix flake metadata - show flake metadata
· nix flake new - create a flake in the specified directory from a template
· nix flake prefetch - download the source tree denoted by a flake
  reference into the Nix store
· nix flake show - show the outputs provided by a flake
· nix flake update - update flake lock file
</code></pre><p>Hmm.</p>
<pre tabindex=0><code>$ nix flake info
warning: 'nix flake info' is a deprecated alias for 'nix flake metadata'
warning: Git tree '/Users/ian/src/sd' is dirty
Resolved URL:  git+file:///Users/ian/src/sd
Locked URL:    git+file:///Users/ian/src/sd
Description:   A very basic flake
Path:          /nix/store/ikqp3gx8c796gpc3s8ggsjd5xzz1sk84-source
Last modified: 2021-12-05 09:05:48
Inputs:
└───nixpkgs: github:NixOS/nixpkgs/e1e7c171a258fc15424b22a1566d9af530784aa7
</code></pre><p>Aw. Worth a shot.</p>
<p>I can try <code>trace</code>? I’ve never actually used it before, but I think it’s my only hope of trying to understand what the heck these values actually are.</p>
<p>My first attempt failed:</p>
<pre><code>$ cat flake.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A very basic flake"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span> <span class=p>{</span>
    <span class=n>packages</span><span class=o>.</span><span class=n>x86_64-linux</span><span class=o>.</span><span class=n>hello</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>legacyPackages</span><span class=o>.</span><span class=n>x86_64-linux</span><span class=o>.</span><span class=n>hello</span><span class=p>;</span>

    <span class=n>defaultPackage</span><span class=o>.</span><span class=n>x86_64-linux</span> <span class=o>=</span> <span class=nb>builtins</span><span class=o>.</span><span class=n>trace</span> <span class=n>self</span> <span class=n>self</span><span class=o>.</span><span class=n>packages</span><span class=o>.</span><span class=n>x86_64-linux</span><span class=o>.</span><span class=n>hello</span><span class=p>;</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix flake show
warning: Git tree '/Users/ian/src/sd' is dirty
git+file:///Users/ian/src/sd
├───defaultPackage
error: invalid value
</code></pre><p>I have to give it a string, it seems. But how do I create a string that represents it? I just <code>toString</code> it, and I get a path:</p>
<pre tabindex=0><code>$ nix flake show
warning: Git tree '/Users/ian/src/sd' is dirty
git+file:///Users/ian/src/sd
├───defaultPackage
trace: /nix/store/vzgc0bww6i611sqv1j54c35nf61rii5l-source
│   └───x86_64-linux: package 'hello-2.10'
└───packages
    └───x86_64-linux
        └───hello: package 'hello-2.10'
</code></pre><p>But it seems to be caching the evaluation result <em>somewhere</em>, which means that it only traces on the first invocation. If I run it again, the <code>trace</code> does not run:</p>
<pre tabindex=0><code>$ nix flake show
warning: Git tree '/Users/ian/src/sd' is dirty
git+file:///Users/ian/src/sd
├───defaultPackage
│   └───x86_64-linux: package 'hello-2.10'
└───packages
    └───x86_64-linux
        └───hello: package 'hello-2.10'
</code></pre><p>So… a fun debugging experience. But as long as I’m changing the value I’m tracing, it isn’t too confusing. I learn the following things:</p>
<pre><code>isAttrs: true
isPath: false
</code></pre>
<p>Well that’s a relief, I guess. But why does it <code>toString</code> as a path? It doesn’t have a <code>__toString</code>. It doesn’t have a <code>drvPath</code>, which I know is also special to <code>toString</code>. It doesn’t have a <code>type</code> attribute.</p>
<p>I try:</p>
<pre tabindex=0><code>defaultPackage.x86_64-linux = builtins.trace "${nixpkgs.lib.generators.toPretty {multiline = true;} self}" self.packages.x86_64-linux.hello;
</code></pre><p>But I am met with:</p>
<pre tabindex=0><code>$ nix flake show
warning: Git tree '/Users/ian/src/sd' is dirty
git+file:///Users/ian/src/sd
├───defaultPackage
error: infinite recursion encountered

       at /nix/store/rjmn9kzjnz0n89411hr2yqxrdhyqmwjv-source/flake.nix:7:5:

            6|
            7|     defaultPackage.x86_64-linux = builtins.trace "${nixpkgs.lib.generators.toPretty {multiline = true;} self}" self.packages.x86_64-linux.hello;
             |     ^
            8|   };
(use '--show-trace' to show detailed location information)
</code></pre><p>Sigh. Great looking error message, though!</p>
<p>I am still mystified by how difficult it is to just <em>observe</em> values in Nix. It took me weeks of reading documentation to figure out how to just <em>print out a derivation</em>. And now there’s a new magic type of thing that seems even more wily. Maybe in a few more weeks, I will understand how to get hold of one…</p>
<p>Anyway. I looked through the Nix source, but like who knows. It’s its own bespoke thing, but it can coerce to an attribute set, I guess? And also has a custom <code>toString</code>. I don’t know what I’m doing here. It seems that there is a type of thing called a <em>tree</em>, and that flakes are also <em>trees</em>, and maybe there are ways to fetch “trees” built into Nix. I don’t remember anything about this when I was reading the manual, so presumably this is a new 2.4 concept.</p>
<p>I try to search the manual for “trees” but, obviously, it thinks I want to search for “tree” and gosh there is nothing worse than a client-side JavaScript full-text search when all I want to do is ⌘F. Remember when you could just ⌘F through the manual? <em>I remember</em>. I am still salty about this.</p>
<p><em>Anyway</em>. Let’s assume, for now, that it’s magic, and let our minds crystallize around the fact that flakes are difficult and mysterious, until we are afraid to try to understand them further.</p>
<p>What was I trying to do?</p>
<p>Oh, package <code>sd</code> as a flake. Okay. This isn’t really a prerequisite. I’ll just… pretend that <code>self</code> is a path but also remember that it isn’t. No problem.</p>
<p>The template that it created for me seems kind of… insufficient. I liked what <code>dwarffs</code> did; that makes sense to me. I want to publish an overlay, so that you can install it as <code>nixpkgs.sd</code> or whatever. I <em>assume</em> that’s what the <code>overlay</code> thing is for. So I’m going to copy <em>that</em> instead, and then modify it to suit my purposes:</p>
<pre><code>$ cat flake.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A simple command dispatch tool"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span>
    <span class=k>let</span>
      <span class=n>supportedSystems</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"x86_64-linux"</span> <span class=s2>"x86_64-darwin"</span> <span class=s2>"aarch64-linux"</span> <span class=s2>"aarch64-darwin"</span> <span class=p>];</span>
      <span class=n>forAllSystems</span> <span class=o>=</span> <span class=n>f</span><span class=p>:</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>genAttrs</span> <span class=n>supportedSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=n>f</span> <span class=n>system</span><span class=p>);</span>
      <span class=n>version</span> <span class=o>=</span> <span class=s2>"0.1.</span><span class=si>${</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>substring</span> <span class=mi>0</span> <span class=mi>8</span> <span class=n>self</span><span class=o>.</span><span class=n>lastModifiedDate</span><span class=si>}</span><span class=s2>.</span><span class=si>${</span><span class=n>self</span><span class=o>.</span><span class=n>shortRev</span> <span class=n>or</span> <span class=s2>"dirty"</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
    <span class=k>in</span>
    <span class=p>{</span>
      <span class=n>overlay</span> <span class=o>=</span> <span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>
        <span class=n>sd</span> <span class=o>=</span> <span class=k>with</span> <span class=n>final</span><span class=p>;</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
          <span class=n>pname</span> <span class=o>=</span> <span class=s2>"sd"</span><span class=p>;</span>
          <span class=k>inherit</span> <span class=n>version</span><span class=p>;</span>

          <span class=n>src</span> <span class=o>=</span> <span class=n>self</span><span class=p>;</span>

          <span class=n>installPhase</span> <span class=o>=</span>
            <span class=s1>''
</span><span class=s1>              install -D sd -m 0555 "$out/bin/sd"
</span><span class=s1>              install -D _sd -m 0444 "$out/share/zsh/site-functions/_sd"
</span><span class=s1>            ''</span><span class=p>;</span>
        <span class=p>};</span>
      <span class=p>};</span>

      <span class=n>defaultPackage</span> <span class=o>=</span> <span class=n>forAllSystems</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>(</span><span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span>
        <span class=k>inherit</span> <span class=n>system</span><span class=p>;</span>
        <span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
      <span class=p>})</span><span class=o>.</span><span class=n>sd</span><span class=p>);</span>
    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>I had heard people of complaining about flake boilerplate before, and now I can see what they were talking about.</p>
<p>This is also something that I <em>don’t</em> already have a <code>default.nix</code> for. If I <em>did</em> have a <code>default.nix</code>, it would presumably start with something like:</p>
<pre><code>with import &lt;nixpkgs&gt; {}; mkDerivation { ... }
</code></pre>
<p>How would I translate <em>that</em> into a flake? I guess I would make a function that took <code>nixpkgs</code> and returned a derivation, then call that from my <code>flake.nix</code> and my <code>default.nix</code>? Do I still need <code>default.nix</code> files, now that there are flakes? I don’t really understand.</p>
<p>Anyway, let’s see if this works.</p>
<p>Can I, umm… build it?</p>
<pre tabindex=0><code>$ nix build

$ ll result/bin
total 16
-r-xr-xr-x  1 ian   5.4K Dec 31  1969 sd*
</code></pre><p>Okay! It had to download 700mb of <em>something</em> for some reason first, but it did work! Eventually.</p>
<p>So two of those lines are lines that <em>I</em> wrote. And the other 29 are… boilerplate that I copied. So that’s a little… bad. That’s bad.</p>
<p>But! With the power flakes, we are able to improve our lot. Since it’s now possible to write helper functions that don’t live in Nixpkgs, there are helper functions for us that don’t live in Nixpkgs.</p>
<p>One of them is called <a href=https://github.com/numtide/flake-utils><code>flake-utils</code></a>, and it is a collection of helper functions of exactly the sort I am after. So let’s try it?</p>
<p>We have to include it as an input, and then it seems like I just write:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A simple command dispatch tool"</span><span class=p>;</span>

  <span class=n>inputs</span><span class=o>.</span><span class=n>flake-utils</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>"github:numtide/flake-utils"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=n>flake-utils</span> <span class=p>}:</span>
    <span class=n>flake-utils</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>simpleFlake</span> <span class=p>{</span>
      <span class=k>inherit</span> <span class=n>self</span> <span class=n>nixpkgs</span><span class=p>;</span>
      <span class=n>name</span> <span class=o>=</span> <span class=s2>"sd"</span><span class=p>;</span>
      <span class=n>overlay</span> <span class=o>=</span> <span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>
        <span class=n>sd</span> <span class=o>=</span> <span class=k>with</span> <span class=n>final</span><span class=p>;</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
          <span class=n>pname</span> <span class=o>=</span> <span class=s2>"sd"</span><span class=p>;</span>
          <span class=n>version</span> <span class=o>=</span> <span class=s2>"0.1.</span><span class=si>${</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>substring</span> <span class=mi>0</span> <span class=mi>8</span> <span class=n>self</span><span class=o>.</span><span class=n>lastModifiedDate</span><span class=si>}</span><span class=s2>.</span><span class=si>${</span><span class=n>self</span><span class=o>.</span><span class=n>shortRev</span> <span class=n>or</span> <span class=s2>"dirty"</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>

          <span class=n>src</span> <span class=o>=</span> <span class=n>self</span><span class=p>;</span>

          <span class=n>installPhase</span> <span class=o>=</span>
            <span class=s1>''
</span><span class=s1>              install -D sd -m 0555 "$out/bin/sd"
</span><span class=s1>              install -D _sd -m 0444 "$out/share/zsh/site-functions/_sd"
</span><span class=s1>            ''</span><span class=p>;</span>
        <span class=p>};</span>
      <span class=p>};</span>
    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>Hmm, but no. That does not work.</p>
<pre tabindex=0><code>$ nix build
warning: Git tree '/Users/ian/src/sd' is dirty
error: flake 'git+file:///Users/ian/src/sd' does not provide attribute 'packages.x86_64-darwin.defaultPackage.x86_64-darwin', 'legacyPackages.x86_64-darwin.defaultPackage.x86_64-darwin' or 'defaultPackage.x86_64-darwin'
</code></pre><p>Because although there is <code>flake-utils.lib.defaultSystems</code>, those are not… the default systems. When you use <code>simpleFlake</code>. So we have to write:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>outputs</span> <span class=err>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=n>flake-utils</span> <span class=p>}:</span>
  <span class=n>flake-utils</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>simpleFlake</span> <span class=p>{</span>
    <span class=k>inherit</span> <span class=n>self</span> <span class=n>nixpkgs</span><span class=p>;</span>
    <span class=n>systems</span> <span class=o>=</span> <span class=n>flake-utils</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>defaultSystems</span><span class=p>;</span>
    <span class=o>...</span>
  <span class=p>};</span>
</code></pre></div><p>But that <em>still</em> doesn’t work. It fails with the same error. What?</p>
<pre><code>$ nix flake show
</code></pre>
<pre tabindex=0><code>warning: Git tree '/Users/ian/src/sd' is dirty
git+file:///Users/ian/src/sd
└───legacyPackages
warning:     ├───aarch64-darwin: omitted (use '--legacy' to show)
warning:     ├───aarch64-linux: omitted (use '--legacy' to show)
warning:     ├───i686-linux: omitted (use '--legacy' to show)
warning:     ├───x86_64-darwin: omitted (use '--legacy' to show)
warning:     └───x86_64-linux: omitted (use '--legacy' to show)
</code></pre><p>Wha? So… it doesn’t work? It generates something that is actually incompatible with flakes?</p>
<pre tabindex=0><code>$ nix flake show --legacy
warning: Git tree '/Users/ian/src/sd' is dirty
git+file:///Users/ian/src/sd
└───legacyPackages
    ├───aarch64-darwin: package 'sd-0.1.20211205.dirty'
    ├───aarch64-linux: package 'sd-0.1.20211205.dirty'
    ├───i686-linux: package 'sd-0.1.20211205.dirty'
    ├───x86_64-darwin: package 'sd-0.1.20211205.dirty'
    └───x86_64-linux: package 'sd-0.1.20211205.dirty'
</code></pre><p>Okay, so whatever this is… is useless to me. Let’s try something else.</p>
<p>I find <a href=https://github.com/gytis-ivaskevicius/flake-utils-plus><code>flake-utils-plus</code></a>, but it is… the documentation is a single 123-line long Nix file. That is obviously too complicated for what I am trying to do.</p>
<blockquote>
<p>The library is meant to be easy to understand and use.</p>
</blockquote>
<p><em>Sigh.</em></p>
<p>Even just reading the documentation requires learning some new terminology – it uses the word “channels” here to mean something that I <em>assume</em> is incompatible with “Nix channels,” because… what do channels have to do with flakes? Don’t you <em>replace</em> channels with flakes? You can use flakes to… export channels? This makes no sense to me yet.</p>
<p>Sigh. Okay. So I have no idea what the <em>right</em> way to write flakes is, then.</p>
<p>Copy 30 lines of boilerplate around? Write out that bizarre overlay-application-lookup thing manually every time? This seems awful, and I am left with a very sour taste in my mouth.</p>
<p>I guess the answer is “write my own helper library that actually works the way I want it to,” but… come on.</p>
<p>I settle for this disappointing compromise:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>description</span> <span class=o>=</span> <span class=s2>"A simple command dispatch tool"</span><span class=p>;</span>

  <span class=n>inputs</span><span class=o>.</span><span class=n>flake-utils</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>"github:numtide/flake-utils"</span><span class=p>;</span>

  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=n>flake-utils</span> <span class=p>}:</span> <span class=p>{</span>
    <span class=n>overlay</span> <span class=o>=</span> <span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>
      <span class=n>sd</span> <span class=o>=</span> <span class=k>with</span> <span class=n>final</span><span class=p>;</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
        <span class=n>pname</span> <span class=o>=</span> <span class=s2>"sd"</span><span class=p>;</span>
        <span class=n>version</span> <span class=o>=</span> <span class=s2>"0.1.</span><span class=si>${</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>substring</span> <span class=mi>0</span> <span class=mi>8</span> <span class=n>self</span><span class=o>.</span><span class=n>lastModifiedDate</span><span class=si>}</span><span class=s2>.</span><span class=si>${</span><span class=n>self</span><span class=o>.</span><span class=n>shortRev</span> <span class=n>or</span> <span class=s2>"dirty"</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>

        <span class=n>src</span> <span class=o>=</span> <span class=n>self</span><span class=p>;</span>

        <span class=n>installPhase</span> <span class=o>=</span>
          <span class=s1>''
</span><span class=s1>            install -D sd -m 0555 "$out/bin/sd"
</span><span class=s1>            install -D _sd -m 0444 "$out/share/zsh/site-functions/_sd"
</span><span class=s1>          ''</span><span class=p>;</span>
      <span class=p>};</span>
    <span class=p>};</span>
  <span class=p>}</span> <span class=o>//</span>
  <span class=n>flake-utils</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>eachDefaultSystem</span> <span class=p>(</span><span class=n>system</span><span class=p>:</span> <span class=p>{</span>
    <span class=n>defaultPackage</span> <span class=o>=</span> <span class=p>(</span><span class=kn>import</span> <span class=n>nixpkgs</span> <span class=p>{</span>
      <span class=k>inherit</span> <span class=n>system</span><span class=p>;</span>
      <span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>self</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
    <span class=p>})</span><span class=o>.</span><span class=n>sd</span><span class=p>;</span>
  <span class=p>});</span>
<span class=p>}</span>
</code></pre></div><p>It’s better than not using <code>flake-utils</code> at all, but I’m sad that I still have to write that <code>(import nixpkgs { overlays = ...; }).sd</code> nonsense.</p>
<p>Alllllright.</p>
<p>Did I learn flakes?</p>
<p>I got to the end of that blog post. I wrote my first flake. It was… not very pleasant, but I think in order to make it better I will have to make my own helper library, and I don’t want to do that right now.</p>
<p>I’m not really sure what to <em>do</em> with my flake now that I’ve written it, since I still don’t know how to <em>install</em> a flake, or how to import it from a Nix expression, or how to actually apply my overlay to my copy of Nixpkgs. So I have a <code>flake.nix</code> file, and nothing more.</p>
<p>I did not learn much about how flakes actually work, but there are still two blog posts in this series, and then the man pages, so there should be plenty of time to fix that.</p>
<hr>
<ul>
<li>Why is <code>lowdown</code> a dependency of the Nix flake?</li>
<li>What is the difference between a “derivation” and a “package”?</li>
<li>Why does <code>nix search nur git</code> fail?</li>
<li>Where is the flake registry written down? Is it a per-user thing, or a global thing…?</li>
<li>Where are flake lockfiles stored?</li>
<li>Why is <code>nixpkgs</code> an implicit flake dependency? Is the URL of this GitHub repo hardcoded in Nix…?</li>
<li>What <em>is</em> a flake in the Nix expression language? What type of value is it? How do I print one?</li>
<li>How do I translate an existing <code>default.nix</code> into a flake?</li>
<li>Why does Nix randomly decide to download things when I run <code>nix search</code>? What is it downloading? How can I make it stop? Please, please don’t tell me it’s “automatically” updating my flakes.</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22My%20first%20brush%20with%20flakes%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://twitter.com/ianthehenry/status/1467686212295020544>comment via twitter</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>Next up ➜ More flakes, unfortunately</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
