<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/ 
 saved date: Mon Jul 17 2023 13:35:15 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 45: Fancy new profiles</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+article,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .p{color:var(--palette-text)}.highlight .kc{color:var(--palette-purple)}.highlight .nt{color:var(--palette-teal)}.highlight .mi{color:var(--palette-orange)}.highlight .s2{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 45: Fancy new profiles">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>
<meta name=description content="Okay. So: so far I’ve managed to write a flake, but I have no idea how to… use it. And I’ve managed to restore nix search to functionality, basically, by pinning my nixpkgs flake… but now I am searching something different than I will be installing by using nix-env, or by referencing in my shell.nix files, and this bothers me.
Which means I’m going to try the new flake-powered profiles, and figure out what the flake-equivalent version of a shell.nix is, and the new way to write nix-shell -i and nix-shell -p, and all of that good stuff.
But before I get into that, there was one other nix command that didn’t work for me before, because it depended on flakes. So let’s see if it works now that I’ve enabled them:
$ nix path-info 'nixpkgs#git'
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 307 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 515 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 1400 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 2038 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); using cached version
querying info about missing paths/nix/store/bcjf7pr923hinmzcci9qh47g4zd3ds4q-git-2.34.0
Oh okay neat great I love that.">
<meta property=og:description content="Okay. So: so far I’ve managed to write a flake, but I have no idea how to… use it. And I’ve managed to restore nix search to functionality, basically, by pinning my nixpkgs flake… but now I am searching something different than I will be installing by using nix-env, or by referencing in my shell.nix files, and this bothers me.
Which means I’m going to try the new flake-powered profiles, and figure out what the flake-equivalent version of a shell.nix is, and the new way to write nix-shell -i and nix-shell -p, and all of that good stuff.
But before I get into that, there was one other nix command that didn’t work for me before, because it depended on flakes. So let’s see if it works now that I’ve enabled them:
$ nix path-info 'nixpkgs#git'
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 307 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 515 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 1400 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 2038 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); using cached version
querying info about missing paths/nix/store/bcjf7pr923hinmzcci9qh47g4zd3ds4q-git-2.34.0
Oh okay neat great I love that.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-12-08>December 8, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>How to Learn Nix, Part&nbsp;45:<br>Fancy new profiles</a></h1>
</div>
<div class=post-content><p>Okay. So: so far I’ve managed to write a flake, but I have no idea how to… use it. And I’ve managed to restore <code>nix search</code> to functionality, basically, by pinning my <code>nixpkgs</code> flake… but now I am searching something <em>different</em> than I will be installing by using <code>nix-env</code>, or by referencing in my <code>shell.nix</code> files, and this bothers me.</p>
<p>Which means I’m going to try the new flake-powered profiles, and figure out what the flake-equivalent version of a <code>shell.nix</code> is, and the new way to write <code>nix-shell -i</code> and <code>nix-shell -p</code>, and all of that good stuff.</p>
<p>But <em>before</em> I get into that, there was one other <code>nix</code> command that didn’t work for me before, because it depended on flakes. So let’s see if it works now that I’ve enabled them:</p>
<pre tabindex=0><code>$ nix path-info 'nixpkgs#git'
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 307 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 515 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 1400 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); retrying in 2038 ms
warning: error: unable to download 'https://github.com/NixOS/flake-registry/raw/master/flake-registry.json': Couldn't connect to server (7); using cached version
querying info about missing paths/nix/store/bcjf7pr923hinmzcci9qh47g4zd3ds4q-git-2.34.0
</code></pre><p>Oh okay neat great I love that.</p>
<p>Didn’t I <em>just pin <code>nixpkgs</code></em> so that I <em>wouldn’t</em> need to download things?</p>
<p>Ugh ugh ugh.</p>
<p>Okay, so I actually saw an option yesterday, when I was scanning through <code>man 5 nix.conf</code>, but I didn’t mention it at the time because I was busy with other things. But I believe that it’s relevant here:</p>
<pre tabindex=0><code>• flake-registry

  Path or URI of the global flake registry.

  Default:
  https://github.com/NixOS/flake-registry/raw/master/flake-registry.json
</code></pre><p>I mention that because I don’t know where I would have even begun to look into this if I hadn’t seen that. But now I have some idea that it has to <em>download the global flake registry</em> every time (<em>every</em> time?) I do anything involving flakes. Which… yeah cool no thank you.</p>
<p>It <em>has</em> a cached version, too. It just… doesn’t want to use it, until it spends over <em>four seconds</em> retrying this download.</p>
<p>So obviously… let’s not do that. I download the file locally, and add this line to my <code>~/.config/nix/nix.conf</code>:</p>
<pre tabindex=0><code>$ grep flake-registry ~/.config/nix/nix.conf
flake-registry = ~/dotfiles/flake-registry.json
</code></pre><p>So let’s try that again.</p>
<pre tabindex=0><code>$ nix path-info 'nixpkgs#git'
warning: error: unable to download '~/dotfiles/flake-registry.json': Couldn't resolve host name (6); retrying in 320 ms
warning: error: unable to download '~/dotfiles/flake-registry.json': Couldn't resolve host name (6); retrying in 567 ms
warning: error: unable to download '~/dotfiles/flake-registry.json': Couldn't resolve host name (6); retrying in 1003 ms
warning: error: unable to download '~/dotfiles/flake-registry.json': Couldn't resolve host name (6); retrying in 2782 ms
error: unable to download '~/dotfiles/flake-registry.json': Couldn't resolve host name (6)
nix path-info 'nixpkgs#git'  0.08s user 0.03s system 2% cpu 4.808 total
</code></pre><p>Heavy sigh. I guess that <code>~</code> expansion is a feature of my <em>shell</em>, so it was foolish of me to expect Nix to parse that as a local file path. Is that really a valid, like, URI? I dunno.</p>
<p>Let’s try the absolute version:</p>
<pre tabindex=0><code>$ grep flake-registry ~/.config/nix/nix.conf
flake-registry = /Users/ian/dotfiles/flake-registry.json

$ nix path-info 'nixpkgs#git'
/nix/store/bcjf7pr923hinmzcci9qh47g4zd3ds4q-git-2.34.0
</code></pre><p>Okay, that worked fine.</p>
<p>So. I can now… query properties of my Nix store again, without making HTTP requests to GitHub.</p>
<p>Ha. Without making <em>these particular HTTP requests to GitHub</em>. I’ve already squashed <em>two different</em> cases where Nix was connecting to The Internet in order to run basic commands that previously worked offline. <em>Who knows</em> how many more of those there are.</p>
<p>Anyway, <code>nix path-info</code> works; it’s slightly worse, because I have to type the quotes and the <code>#</code> character and all that, but whatever. It’s not a command I use very often.</p>
<p>Now, you might reasonably be wondering at this point: is this real? Did GitHub just <em>happen</em> to be down at the one moment you started writing this blog post? Or did you <em>stage</em> all of this just for rhetorical effect?</p>
<p>That’s a good question. The answer is <em>this 100% happened; this is all real</em>, but that it’s not because GitHub is down.</p>
<p>I had GitHub blackholed in my <code>/etc/hosts</code> because it’s on a long list of tech-related websites that I disable when I am trying not to think about computer things for a moment, just one moment, just one brief second of quietude, and I forgot to re-enable it when I started writing this blog post.</p>
<p>And I’m glad I did, because I learned… well, that Nix is constantly making HTTP requests to GitHub!</p>
<p>I once again wish that I had <code>dtruss</code> available, so I could see what else Nix is doing. I can’t imagine what it must feel like to run Nix without a fast internet connection right now.</p>
<p>Anyway, we were supposed to look at the new flake-enabled profiles, right?</p>
<p>Let’s do that.</p>
<p>And then maybe I can figure out how to install my <code>sd</code> overlay.</p>
<h1 id=nix-profile---help><code>nix profile --help</code></h1>
<p>So we have all of the following subcommands:</p>
<pre tabindex=0><code>· nix profile diff-closures - show the closure difference between each version of
  profile
· nix profile history - show all versions of a profile
· nix profile install - install a package into a profile
· nix profile list - list installed packages
· nix profile remove - remove packages from a profile
· nix profile rollback - roll back to the previous version or a specified version
  of a profile
· nix profile upgrade - upgrade packages using their most recent flake
· nix profile wipe-history - delete non-current versions of a profile
</code></pre><p>I’m excited about <code>upgrade</code>, as that was a pretty big missing feature of <code>nix-env</code>.</p>
<p>I learn that it uses the same numbered-symlink approach that <code>nix-env</code> did, and that the default profile is still in <code>~/.nix-profile</code>, and it still supports <code>--profile</code> to change that.</p>
<p>I learn that the <code>manifest.nix</code> has been replaced by <code>manifest.json</code>, and that its contents is actually documented now. Nice! That’s great. No more pawing around in the dark trying to figure out just how to look at that file.</p>
<p>And that’s all that the top-level docs have to say. Let’s dive in!</p>
<pre tabindex=0><code>$ nix profile install 'nixpkgs#hello' --profile ~/scratch/test-profile

$ tree ~/scratch/test-profile
/Users/ian/scratch/test-profile
├── bin -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/bin
├── manifest.json
└── share -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/share
</code></pre><p>Neat. Okay. Same as before, basically, with a slightly nicer looking command. Except instead of <code>nixpkgs.hello</code> – a reasonable, intuitive syntax – it’s now <code>'nixpkgs#hello'</code>, because… because, really, I don’t even know, you know?</p>
<p>It’s not like it was pleasant to type <code>nix-env -iA nixpkgs.hello</code> before, and indeed I made an alias so I could just type <a href=https://github.com/ianthehenry/sd-nix><code>sd nix install hello</code></a> a long time ago. I expect I’ll do the same for all of the common flake commands I type, given time.</p>
<pre tabindex=0><code>$ nix profile remove 'nixpkgs#hello' --profile ~/scratch/test-profile

$ nix profile upgrade 'nixpkgs#hello' --profile ~/scratch/test-profile

$ echo $?
0
</code></pre><p>Oh. Huh. I expected that to fail, because I expected that <code>nix profile remove</code> would… remove the package. But it didn’t:</p>
<pre tabindex=0><code>$ tree ~/scratch/test-profile
/Users/ian/scratch/test-profile
├── bin -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/bin
├── manifest.json
└── share -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/share
</code></pre><p>Huh.</p>
<p>Did the remove secretly fail?</p>
<pre tabindex=0><code>$ nix profile remove 'nixpkgs#hello' --profile ~/scratch/test-profile

$ echo $?
0
</code></pre><p>Yep. Just a silent no-op. Cool.</p>
<p>Well, let’s see. <code>nix profile remove --help</code> lists all of the following possible invocations:</p>
<pre tabindex=0><code>· Remove a package by position:

    | # nix profile remove 3

· Remove a package by attribute path:

    | # nix profile remove packages.x86_64-linux.hello

· Remove all packages:

    | # nix profile remove '.*'

· Remove a package by store path:

    | # nix profile remove /nix/store/rr3y0c6zyk7kjjl8y19s4lsrhn4aiq1z-hello-2.10
</code></pre><p>Well… <em>none of those</em> are what I want. What are package “positions”? I don’t know. Presumably I could find out with <code>--list</code>:</p>
<pre tabindex=0><code>$ nix profile list --profile ~/scratch/test-profile
0 flake:nixpkgs#legacyPackages.x86_64-darwin.hello github:NixOS/nixpkgs/18e6b5184274305f2c9dc36141003473375a5df9#legacyPackages.x86_64-darwin.hello /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10
</code></pre><p>Yeah, okay, I assume that’s what the <code>0</code> means. But… <em>what?</em> This seems like some weird implementation detail leaking out. I’m not supposed to actually know… what?</p>
<p>So… let me get this straight. If I’m reading this correctly: in order to remove a package that I installed as <code>nixpkgs#hello</code>, I’m supposed to type:</p>
<pre><code>$ nix profile remove packages.x86_64-darwin.hello
</code></pre>
<p>Is that… <em>is that real?</em> Is that the <em>actual CLI?</em></p>
<p>I guess those numbers are there as like… <em>ergonomic aids?</em> Because the designer of this feature realized that it was unreasonable to expect someone to type <code>packages.x86_64-darwin.hello</code>, so instead of supporting the obvious invocation…?</p>
<p>Remember when I was excited that <code>nix profile</code> would liberate me from the terrible UI of <code>nix-env</code>? How young I was, then.</p>
<p>Anyway let’s try it out anyway:</p>
<pre tabindex=0><code>$ nix profile remove packages.x86_64-darwin.hello --profile ~/scratch/test-profile
</code></pre><p>Did it work this time? Or did it silently fail again?</p>
<pre tabindex=0><code>$ tree ~/scratch/test-profile
/Users/ian/scratch/test-profile
├── bin -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/bin
├── manifest.json
└── share -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/share
</code></pre><p>Fantastic.</p>
<p>Ah, because by spooning my way through the punctuation soup of the <code>nix profile list</code> output, I guess that I’m <em>actually</em> supposed to type:</p>
<pre tabindex=0><code>$ nix profile remove legacyPackages.x86_64-darwin.hello --profile ~/scratch/test-profile

$ tree ~/scratch/test-profile
/Users/ian/scratch/test-profile
└── manifest.json
</code></pre><p>Okay, well, that was horrible; let’s never do that again.</p>
<p>I basically never run <code>nix-env --uninstall</code>, because I use <code>nix-shell -p</code> pretty frequently, and only add something to my profile if I’m pretty confident that I’m going to keep it around. And even when I do uninstall something from my profile, I usually do that by typing <a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/><code>sd nix sync</code></a>.</p>
<p>So let’s try to come up with the equivalent flake-based declarative profile.</p>
<p>So just to refresh, I currently have a file that looks like this:</p>
<pre tabindex=0><code>$ cat ~/dotfiles/user.nix
with import &lt;nixpkgs&gt; {}; [
  git
  nix
  zsh
  ...
]
</code></pre><p>And I run <code>nix-env -irf ~/dotfiles/user.nix</code> to set my profile to only the derivations listed in that file. I use this to install things and to uninstall things, and also to upgrade things, because previously Nix didn’t have a way to upgrade things.</p>
<p>So: how do I do that with profiles?</p>
<p>Well, gosh. From reading the <code>--help</code> pages, it doesn’t seem like there’s a way to both add and remove packages from a profile in a single operation.</p>
<p>I could do something where I like… uninstall everything, and then install a list of things. But that would mean that <code>nix profile rollback</code> wouldn’t revert my “sync” operation; it would revert the install, and then it would revert the uninstall everything.</p>
<p>So…</p>
<p>How am I supposed to write down the packages that I want in my profile?</p>
<p>Another very important part of my workflow is <code>sd nix diff</code>, which shows me output like this:</p>
<pre tabindex=0><code>$ sd nix diff
- htop 3.1.0
+ racer 2.1.48
! nodejs 14.18.0 -&gt; 14.18.1
! git 2.33.0 -&gt; 2.33.1
! delta 0.8.3 -&gt; 0.10.2
</code></pre><p>So I can see what effect running <code>sd nix sync</code> will have on my profile.</p>
<p>But… well, I guess I can sort of maybe figure out the “current version” by running <code>nix profile list</code>, and parsing the output? There are no options to control what that actually prints out. There’s no equivalent of <code>nix-env -q --json</code>, which is what I use to generate that diff.</p>
<p>But… I guess the manifest file is basically that?</p>
<pre><code>$ jq . ~/scratch/test-profile/manifest.json
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"elements"</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>"active"</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>"attrPath"</span><span class=p>:</span> <span class=s2>"legacyPackages.x86_64-darwin.hello"</span><span class=p>,</span>
      <span class=nt>"originalUri"</span><span class=p>:</span> <span class=s2>"flake:nixpkgs"</span><span class=p>,</span>
      <span class=nt>"storePaths"</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>"/nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10"</span>
      <span class=p>],</span>
      <span class=nt>"uri"</span><span class=p>:</span> <span class=s2>"github:NixOS/nixpkgs/18e6b5184274305f2c9dc36141003473375a5df9"</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=nt>"version"</span><span class=p>:</span> <span class=mi>1</span>
<span class=p>}</span>
</code></pre></div><p>Okay no. I should have paid attention before. The <em>old</em> <code>manifest.nix</code> was a full working copy of the derivation. This is just… well, I can probably turn those into derivations?</p>
<pre tabindex=0><code>$ nix flake show 'nixpkgs#hello'
error: unexpected fragment 'hello' in flake reference 'nixpkgs#hello'
</code></pre><p>I don’t actually know what to do with a flakeref once I have it. I don’t know how to evaluate one, or to see anything about the derivation that it evaluates to. Huh.</p>
<p>I look through <code>nix --help</code> and on a whim I tried <code>nix eval</code>.</p>
<p>And it just… hard broke?</p>
<pre tabindex=0><code>$ nix eval
error (ignored): error: interrupted by the user
^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C
</code></pre><p>I actually had to <code>kill -9</code> it. Wow.</p>
<p>I thought that this was a bug because I didn’t type any arguments, so I tried it again with an argument:</p>
<pre tabindex=0><code>$ nix eval 'nixpkgs#hello'
error: interrupted by the user
^C
$
</code></pre><p>It still just hung – I waited about a minute – but at least I could interrupt it this time.</p>
<p>So no idea… what that’s about.</p>
<p><code>nix eval --help</code> gives this example:</p>
<pre tabindex=0><code>· Print the store path of the Hello package:

    | # nix eval --raw nixpkgs#hello
</code></pre><p>I copy it, foolishly:</p>
<pre tabindex=0><code>$ nix eval --raw nixpkgs#hello
zsh: no matches found: nixpkgs#hello
</code></pre><p>And I sigh deeply, and run:</p>
<pre tabindex=0><code>$ nix eval --raw 'nixpkgs#hello'
/nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10\
</code></pre><p>Okay. So that works? But I don’t really want the path. I want the <code>pname</code> and <code>version</code>.</p>
<pre tabindex=0><code>$ nix eval --raw 'nixpkgs#hello.pname'
hello\
$ nix eval --raw 'nixpkgs#hello.version'
2.10\
</code></pre><p>Okaaaay. Oh, I should maybe mention: those <code>\</code> characters are added by my shell, to tell me that the command actually had no newline after it, so <code>zsh</code> inserted it for me. On <code>bash</code>, this would instead look like:</p>
<pre tabindex=0><code>$ nix eval --raw 'nixpkgs#hello.pname'
hello$ nix eval --raw 'nixpkgs#hello.version'
2.10$
</code></pre><p>In my shell these special backslashes render with reversed colors, so it’s obvious they aren’t part of the output, but my blog is not smart enough to be able to reproduce that.</p>
<p><em>Anyway</em>. I can evaluate one of these things, but how do I evaluate both of these things? I do not know. I tried a few different invocations, but none of them worked. So I gave up.</p>
<p>I want to do this so that I can diff the “current” version to the “new” version before I run <code>upgrade</code>. And here I’m just trying to see the “current” version. But how do I see the new version?</p>
<p>Let’s see. I look in <code>nix profile upgrade --help</code>, expecting to see a <code>--dry-run</code> flag or something. But there isn’t one. So I don’t know how to see the new version either.</p>
<p>So: my conclusion from all of this is that <code>nix profile</code> is not a viable replacement for <code>nix-env</code>. There’s no way to print a human-readable list of the currently installed packages, there’s no way to see what is going to be upgraded, there’s no way to… use <code>nix profile</code>.</p>
<p>So I won’t!</p>
<p>Which is fine. It is an experimental feature, after all. I can keep using <code>nix-env</code>.</p>
<p>The reason to use <code>nix profile</code> is, of course, that <code>nix search</code> now operates in flake town, and I don’t want to <code>nix search</code> through a slightly different set of things than I will be able to install.</p>
<p>So let’s instead try to figure out how to fix <em>that</em>, and to make <code>nix search</code> match <code>nix-env</code> again. To make a “flake” that matches the contents of my <em>channel</em>.</p>
<p>Hmm. That shouldn’t be too hard.</p>
<pre tabindex=0><code>$ nix registry add nixpkgs ~/.nix-defexpr/channels/nixpkgs
</code></pre><p>And now my <code>nixpkgs</code> flake is tied to my channel, and I can update it with normal <code>nix-channel --update</code> commands. Right?</p>
<pre tabindex=0><code>$ nix search nixpkgs hello
error: access to path '/nix/store/dd99fd7ik49hfc7ywiy85n2wbylhamjr-nixpkgs-22.05pre335173.56cbe42f166/nixpkgs/flake.nix' is forbidden in restricted mode
</code></pre><p>Hmmm. Very interesting.</p>
<pre tabindex=0><code>$ nix --help | grep restricted
$ nix flake --help | grep restricted
$ nix registry --help | grep restricted
</code></pre><p>I have no idea what “restricted mode” is. I finally find a reference to it in <code>man 5 nix.conf</code>:</p>
<pre tabindex=0><code>• allowed-uris

  A list of URI prefixes to which access is allowed in restricted
  evaluation mode. For example, when set to https://github.com/NixOS,
  builtin functions such as fetchGit are allowed to access
  https://github.com/NixOS/patchelf.git.

  Default: empty
</code></pre><p>But no explanation of what this… means.</p>
<p>So… I guess I can’t weasel my way out of flakes that easily.</p>
<p>Well, no problem! Since I’ve declared all of the packages I want installed, I can just:</p>
<pre tabindex=0><code>$ sed -i '' s/nix/nix_2_3/ ~/dotfiles/user.nix

$ sd nix diff
! nix 2.4 -&gt; 2.3.16

$ sd nix sync
...

$ nix --version
nix (Nix) 2.3.16
</code></pre><p>I missed you, old friend. You wouldn’t believe the crazy week I’ve had.</p>
<hr>
<ul>
<li>So how’s Guix these days?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Fancy%20new%20profiles%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://twitter.com/ianthehenry/status/1468833655787118593>comment via twitter</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Next up ➜ Chipping away at flakes</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
