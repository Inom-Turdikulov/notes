<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/ 
 saved date: Mon Jul 17 2023 13:35:16 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 46: Chipping away at flakes</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"🌖"}#dmt:hover::before{content:"🌗"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"🌒"}:root:not(.light-theme) #dmt:hover::before{content:"🌓"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+ol,main *+hr{margin-top:1em}main pre+div.highlight{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .c1{color:var(--palette-dim)}.highlight .s{color:var(--palette-green)}.highlight .nb{color:var(--palette-text)}.highlight .nf{color:var(--palette-blue)}.highlight .nl{color:var(--palette-text)}.highlight .sc{color:var(--palette-text)}.highlight .s2{color:var(--palette-green)}.highlight .si{color:var(--palette-orange)}</style>
<meta property=og:title content="How to Learn Nix, Part 46: Chipping away at flakes">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>
<meta name=description content="When I was learning Nix for the first time, I never found myself frustrated with it.
My brain was in learning mode: everything was strange and new and exciting. I was more interested in what Nix was than in how to actually use it; I was more interested in how it worked than what I could do with it.
And more importantly: I expected it to be difficult to use. Nix has a reputation, after all, and it didn’t really bother me that it kept plunging me into a bash shell, or that it didn’t have a way to upgrade packages, or that I had to type crazy-looking commands all the time. I knew what I was signing up for.
But many months have passed since my first dance with Nix, and in that time our relationship has evolved. Nix is no longer an interesting curio; it is now a very important tool for me. My mind left learning mode, and entered the working mode.">
<meta property=og:description content="When I was learning Nix for the first time, I never found myself frustrated with it.
My brain was in learning mode: everything was strange and new and exciting. I was more interested in what Nix was than in how to actually use it; I was more interested in how it worked than what I could do with it.
And more importantly: I expected it to be difficult to use. Nix has a reputation, after all, and it didn’t really bother me that it kept plunging me into a bash shell, or that it didn’t have a way to upgrade packages, or that I had to type crazy-looking commands all the time. I knew what I was signing up for.
But many months have passed since my first dance with Nix, and in that time our relationship has evolved. Nix is no longer an interesting curio; it is now a very important tool for me. My mind left learning mode, and entered the working mode.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-12-18>December 18, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>How to Learn Nix, Part&nbsp;46:<br>Chipping away at flakes</a></h1>
</div>
<div class=post-content><p>When I was learning Nix for the first time, I never found myself frustrated with it.</p>
<p>My brain was in learning mode: everything was strange and new and exciting. I was more interested in <em>what Nix was</em> than in how to actually use it; I was more interested in how it worked than what I could do with it.</p>
<p>And more importantly: I <em>expected</em> it to be difficult to use. Nix has a reputation, after all, and it didn’t really bother me that it kept plunging me into a <code>bash</code> shell, or that it didn’t have a way to upgrade packages, or that I had to type crazy-looking commands all the time. I knew what I was signing up for.</p>
<p>But many months have passed since my first dance with Nix, and in that time our relationship has evolved. Nix is no longer an interesting curio; it is now a very important tool for me. My mind left learning mode, and entered the working mode.</p>
<p>And when Nix 2.4 came out, I <em>wasn’t</em> expecting it to be difficult to use. I was looking forward to the new UI; I was looking forward to recommending it to people without having to attach a hundred asterisks. I was very surprised when I saw that the profile UI was not an answer to <code>nix-env</code>, and that commands would sometimes – randomly! – add one full minute of latency before they started doing anything.</p>
<p>So I reverted to Nix 2.3. Not because I’m giving up on Nix, or done trying to learn about flakes. But because it will be much easier to study Nix 2.4 from arms-length. I need to treat Nix 2.4 as another strange artifact, and I need to learn how it works <em>without</em> it getting in the way of my <del><del>useless side projects</del></del> real work.</p>
<p>So let’s get started. Again.</p>
<p>I had the chance to speak with someone very knowledgeable about Nix recently, and I was able to ask a question that has been on my mind: can I do everything that I could do before, if I go all in on flakes? If I abandon backwards-compatibility, if I delete my channels, if I lean into the experimental features?</p>
<p>And the answer was a resounding no.</p>
<p>At least, as of today: it is not possible to do everything with flakes. In order to use Nix in all of the ways that I use it, you have to use <em>both</em> channel-based Nix <em>and</em> flake-based Nix at the same time. And there is no built-in way to unify the two – to make a channel that tracks a flake, or to make a flake that tracks a channel.</p>
<p>So if you install Nix 2.4 (or 2.5, which has emerged since my last post), you have to use flake-based Nix, because there is no way to make <code>nix search</code> work without flakes. And you also have to use channel-based Nix, because the new Nix has no equivalent of <code>nix-shell -i</code>, and only a limited version of <code>nix-shell -p</code>.</p>
<p>So that’s sort of upsetting, and it makes it pretty awkward to recommend Nix right now. “You should install Nix, but make sure you install the Nix from two versions ago, because, well, there’s a new way to do everything, but not <em>everything</em>, so if you install the latest version you’ll have to understand these two mutually incompatible models of how Nix expressions work, and Nix was hard enough to understand already.” It’s not… a great pitch. But hopefully this intermediate state won’t last too long.</p>
<p>That was my high-level takeaway. Let’s get a little more specific.</p>
<p>I currently use Nix in four different ways:</p>
<ol>
<li><code>shell.nix</code> files</li>
<li>installing tools I use interactively (like <code>git</code> or <code>rg</code>)</li>
<li><code>nix-shell -p</code> (to try stuff out)</li>
<li><code>nix-shell -i</code> (writing portable, self-contained scripts)</li>
</ol>
<p>Flakes can currently do… some of these things. Let’s go through the list:</p>
<p><code>shell.nix</code> files. In theory, this is the big one, and the use case that seems most improved by flakes. You can replace <code>shell.nix</code> files with <code>flake.nix</code> files that expose a <code>devShell</code> output, and get nice pinning behavior and faster evaluation and <a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>no more weird hacks to add GC roots</a>. I haven’t actually tried this yet, though.</p>
<p>User software? <em>Theoretically</em> this is the idea behind <code>nix profile</code>. In practice, it’s not really usable yet, <a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>as seen previously</a>.</p>
<p><code>nix-shell -p</code> has a replacement – the new <code>nix shell</code> command. But it’s more limited: it can install specific derivations, but it cannot evaluate arbitrary expressions, <em>apparently</em>. This means you can’t write something like:</p>
<pre tabindex=0><code>nix-shell -p 'python2.withPackages (pkgs: [ pkgs.psycopg2 ])'
</code></pre><p>Which is a real thing that I have done before. I’m not sure if there’s some unofficial workaround for this, but we might be able to figure something out.</p>
<p><code>nix-shell -i</code> has no equivalent; this is not something that you can do with flakes at all yet.</p>
<p>So we still need <code>nix-shell</code> and <code>nix-env</code> and all that. We can’t give up on channels altogether. Even if we decide to embrace flakes, we’ll need some sort of compatibility shim for the time being.</p>
<p>I tried to come up with one in the last post, and I failed.</p>
<p>But the Nix expert I spoke to showed me a partial approximation. Because it turns out that my attempt before – to add a flake that pointed to my channel – that <em>should have</em> worked. The fact that it didn’t is just <a href=https://github.com/NixOS/nix/issues/5700>a weird bug in Nix</a>.</p>
<p>It has to do with the fact that the path to my channel contained a symlink. Observe:</p>
<pre tabindex=0><code>$ nix search path:$HOME/.nix-defexpr/channels/nixpkgs git
error: access to path '/nix/store/dd99fd7ik49hfc7ywiy85n2wbylhamjr-nixpkgs-22.05pre335173.56cbe42f166/nixpkgs/flake.nix' is forbidden in restricted mode
</code></pre><p>But if I resolve the symlink for it, it works correctly:</p>
<pre tabindex=0><code>$ nix search path:$(realpath ~/.nix-defexpr/channels/nixpkgs) git
copying '/nix/store/dd99fd7ik49hfc7ywiy85n2wbylhamjr-nixpkgs-22.05pre335173.56c
...
</code></pre><p>The fact that those are different is surprising, but bugs are bugs. It happens.</p>
<p>So does that mean we’re done? We can write a flake that tracks our channel, and have seamless backwards compatibility?</p>
<p>Well… not quite. Because it’s incredibly slow:</p>
<pre tabindex=0><code>$ time nix search path:$(realpath ~/.nix-defexpr/channels/nixpkgs) git
copying '/nix/store/dd99fd7ik49hfc7ywiy85n2wbylhamjr-nixpkgs-22.05pre335173.56c
...
5.04s user 14.44s system 71% cpu 27.142 total
</code></pre><p>It hangs for about fifteen seconds (copying something that is already in the Nix store into the Nix store (?)). Then it spends… twelve seconds printing out output. Which is a bit too long.</p>
<p>Subsequent runs are faster, though.</p>
<pre tabindex=0><code>$ time nix search path:$(realpath ~/.nix-defexpr/channels/nixpkgs) git
copying '/nix/store/dd99fd7ik49hfc7ywiy85n2wbylhamjr-nixpkgs-22.05pre335173.56c
...
4.62s user 11.17s system 93% cpu 16.921 total
</code></pre><p>Presumably this is because of the evaluation cache: it still spends fifteen seconds copying everything, but then manages to print output in only two seconds – which is as fast as <code>nix search nixpkgs git</code>.</p>
<p>So this isn’t really a viable alternative. I don’t want to type all of that every time I search something, and if I add the <code>realpath</code> to my registry then I would have to remember to re-sync it whenever I updated my channel. I could make an alias for this, and resolve the symlink on demand, but a seventeen second search is not reasonable anyway. Especially when you consider that, by rolling back to Nix 2.3, I can search in only one second.</p>
<p>I don’t claim to understand what’s happening there, but in the opinion of the person I spoke to, the fact that it’s copying anything is a bug. So it is entirely possible that the obvious flake workaround will work in a future version of Nix. Neat.</p>
<p><em>Until then</em>, however, let’s try to come up with something else.</p>
<p>I wanted to add a flake that reflected my channel. But I feel like that’s spiritually <em>against the rules</em>. My channel is a mutable target.</p>
<p>I could add a flake that points to a local clone of Nixpkgs, and benefit from the git-based rev checking immutability stuff – but then my <code>nix-channel --update</code> would become <code>(cd ~/src/nixpkgs &amp;&amp; git fetch &amp;&amp; git merge --ff-only)</code>. Which is <em>fine</em>… I mean, I can make an alias to do that, I guess. But it’s not a very satisfying solution in general.</p>
<p>But perhaps instead of trying to make a flake that reflects the contents of my channel, I could make a channel that reflects the contents of my flake?</p>
<p>I happen to have come across another piece of forbidden knowledge since last week: someone emailed me to talk about flakes, and they pointed out a function that would have been very useful for me back when I first encountered them: <code>builtins.getFlake</code>.</p>
<p>Here’s what the manual has to say about it:</p>
<pre tabindex=0><code>$ rg 'getFlake' ~/src/nix/doc
/Users/ian/src/nix/doc/manual/src/release-notes/rl-2.4.md
189:  - `builtins.getFlake` fetches a flake and returns its output
</code></pre><p>Ah. Okay. It’s undocumented, except for a line in the release notes. Let’s expand that:</p>
<blockquote>
<p><strong>New built-in functions</strong>:</p>
<ul>
<li>
<p><code>builtins.fetchTree</code> allows fetching a source tree using any
backends supported by the fetcher infrastructure. It subsumes the
functionality of existing built-ins like <code>fetchGit</code>,
<code>fetchMercurial</code> and <code>fetchTarball</code>.</p>
</li>
<li>
<p><code>builtins.getFlake</code> fetches a flake and returns its output
attributes. This function should not be used inside flakes! Use
flake inputs instead.</p>
</li>
<li>
<p><code>builtins.floor</code> and <code>builtins.ceil</code> round a floating-point number
down and up, respectively.</p>
</li>
</ul>
</blockquote>
<p>This is pretty important, and something that I completely missed while I was scanning through the release notes. But it gives me the in into the flake world that I was missing – the ability to grab hold of one in motion.</p>
<p>Let’s try it out and see what happens.</p>
<pre tabindex=0><code>$ nix repl
Welcome to Nix 2.4. Type :? for help.

nix-repl&gt; nixpkgs = builtins.getFlake "nixpkgs"

nix-repl&gt; nixpkgs.git
[15.6/0.0 MiB DL] downloading 'https://api.github.com/repos/NixOS/nixpkgs/tarball/dd89ff
</code></pre><p>One full minute later…</p>
<pre tabindex=0><code>nix-repl&gt; nixpkgs.git
error: attribute 'git' missing

       at «string»:1:1:

            1| nixpkgs.git
             | ^
            2|
[26.8 MiB DL]
</code></pre><p>Okay! So yeah it really is downloading things from the internet as a result of evaluating Nix expressions.</p>
<p><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>The first time I encountered <code>fetchurl</code></a>, I guessed that it worked this way. Then I learned that I was actually looking at a <em>derivation</em>, and my mental model changed to say that derivations are like side-effect-thunks.</p>
<p>But I recently learned that my first guess <em>was actually correct</em>, and that there is a <code>builtins.fetchurl</code> that behaves <em>differently</em> than <code>nixpkgs.fetchurl</code> – which is what I was looking at at the time. Here’s Nix 2.3:</p>
<pre tabindex=0><code>$ nix repl
Welcome to Nix version 2.3.16. Type :? for help.

nix-repl&gt; something = builtins.fetchurl "https://ianthehenry.com"

nix-repl&gt; something
downloading 'https://ianthehenry.com'"/nix/store/a9c7r27a2jdp58bsl9d4fplrn7h30gps-ianthehenry.com"

[0.0 MiB DL]
</code></pre><p>The output is weird because it tried to do an animated progress bar thing and kind of botched it, but you can see that evaluating that expression did download a file from the internet and put it in my Nix store.</p>
<p>So anyway, this not-really-lazy evaluation model has actually been part of Nix for a while. But now I get to see it.</p>
<p>Let’s keep seeing it:</p>
<pre tabindex=0><code>nix-repl&gt; nixpkgs = builtins.getFlake "nixpkgs"

nix-repl&gt; nixpkgs
{ checks = { ... };
  htmlDocs = { ... };
  inputs = { ... };
  lastModified = 1639847300;
  lastModifiedDate = "20211218170820";
  legacyPackages = { ... };
  lib = { ... };
  narHash = "sha256-ZBa69DnJX0TubUgwf7ENMylX0h92smvUXsR2Jt1qCqQ=";
  nixosModules = { ... };
  outPath = "/nix/store/a9hp244h16li4c3ja454jkczc7gfmwn4-source";
  outputs = { ... };
  rev = "dd89ff03f3ce876086ec254610005949ca0818d0";
  shortRev = "dd89ff0";
  sourceInfo = { ... }; }
</code></pre><p>(No; <code>nix repl</code> hasn’t learned about pretty-printing; I added some newlines manually.)</p>
<p>Okay. So the “documentation” for <code>builtins.getFlake</code> said that it “fetches a flake and returns its output attributes.” But fortunately this is not true: it fetches a flake and returns <em>the flake itself</em>. Which is far more useful.</p>
<p>And now I can see that which <a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>I could not see before</a>: <em>what a flake is</em>. I’ve finally got a hold of one. Let’s check it out.</p>
<p>We can see all of <a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>the magic properties that were documented before</a> – excepting <code>revCount</code>, which is not available for GitHub flakes. And I can see that <code>outPath</code> is the thing that <code>builtins.trace</code> was showing me, and I can see why:</p>
<pre tabindex=0><code>nix-repl&gt; builtins.toString nixpkgs
"/nix/store/a9hp244h16li4c3ja454jkczc7gfmwn4-source"
</code></pre><p>I thought that flakes had their own custom <code>toString</code>, but it appears that’s not the case. I just forgot that the <code>outPath</code> key is special to Nix:</p>
<pre tabindex=0><code>nix-repl&gt; builtins.toString { outPath = "hello"; }
"hello"
</code></pre><p>What else is in here? I don’t want to recursively print everything, but:</p>
<pre tabindex=0><code>nix-repl&gt; :p nixpkgs.inputs
{ }
</code></pre><p>As I remember.</p>
<p>How about:</p>
<pre tabindex=0><code>nix-repl&gt; nixpkgs.outputs.legacyPackages.x86_64-darwin
{ AAAAAASomeThingsFailToEvaluate = «error: error: Please be informed that this pseudo-package is not the only part of
       Nixpkgs that fails to evaluate. You should not evaluate entire Nixpkgs
       without some special measures to handle failing packages, like those taken
       by Hydra.»; AMB-plugins = «derivation «error: error: Package ‘AMB-plugins-0.8.1’ in /nix/store/a9hp244h16li4c3ja454jkczc7gfmwn4-source/pkgs/applications/audio/AMB-plugins/default.nix:23 is not supported on ‘x86_64-darwin’, refusing to evaluate.

       a) To temporarily allow packages that are unsupported for this system, you can use an environment variable
          for a single invocation of the nix tools.

            $ export NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM=1

       b) For `nixos-rebuild` you can set
         { nixpkgs.config.allowUnsupportedSystem = true; }
       in configuration.nix to override this.

       c) For `nix-env`, `nix-build`, `nix-shell` or any other Nix command you can add
         { allowUnsupportedSystem = true; }
       to ~/.config/nixpkgs/config.nix.»; ArchiSteamFarm = «derivation «error: error: Package ‘lttng-ust-2.12.2’ in /nix/store/a9hp244h16li4c3ja454jkczc7gfmwn4-source/pkgs/development/tools/misc/lttng-ust/generic.nix:37 is not supported on ‘x86_64-darwin’, refusing to evaluate.

       a) To temporarily allow packages that are unsupported for this system, you can use an environment variable
          for a single invocation of the nix tools.

            $ export NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM=1

       b) For `nixos-rebuild` you can set
         { nixpkgs.config.allowUnsupportedSystem = true; }
       in configuration.nix to override this.

       c) For `nix-env`, `nix-build`, `nix-shell` or any other Nix command you can add
         { allowUnsupportedSystem = true; }
       to ~/.config/nixpkgs/config.nix.»; AusweisApp2 = «derivation «error: error: Package ‘AusweisApp2-1.22.2’ in /nix/store/a9hp244h16li4c3ja454jkczc7gfmwn4-source/pkgs/applications/misc/ausweisapp2/default.nix:20 is not supported on ‘x86_64-darwin’, refusing to evaluate.

    ... THOUSANDS OF LINES OF ERROR MESSAGES ...

    ^C^C^C^C^C^C^C

    ... THOUSANDS MORE ERROR MESSAGES ...
</code></pre><p>Oh gosh oh gosh oh no. It just started spewing errors, trying to evaluate every single package, and ignoring all attempts to interrupt it. I eventually had to <code>kill -9</code> it, because it wouldn’t even respond to <code>SIGTERM</code>. Not great. Let’s try that again:</p>
<pre tabindex=0><code>$ nix repl
Welcome to Nix 2.4. Type :? for help.

nix-repl&gt; nixpkgs = builtins.getFlake "nixpkgs"

nix-repl&gt; nixpkgs.outputs.legacyPackages.x86_64-darwin.git
«derivation /nix/store/1s02f3hsyvcx7kpyzj15ja3kklwj86b6-git-2.34.0.drv»
</code></pre><p>Okay. Everything is fine.</p>
<p>So this makes me curious: what is happening when I type <code>nixpkgs#git</code> at the command line? What is that actually referring to, and why?</p>
<p><code>nix flake --help</code> says:</p>
<blockquote>
<pre tabindex=0><code># nix build github:NixOS/nixpkgs#hello
</code></pre><p><code>github:NixOS/nixpkgs</code> is a flake reference (while <code>hello</code> is an output attribute).</p>
</blockquote>
<p>Okay. “Output attribute.”</p>
<p>I’m not really sure how to square that with the contents of the <code>outputs</code> attribute set. This flake does not have an attribute named <code>git</code>. <em>Presumably</em> it’s looking up <code>legacyPackages.x86_64-darwin.git</code> – although that same derivation might exist at some other path. But this behavior isn’t explained anywhere in <code>nix flake --help</code>.</p>
<p>But perhaps it wouldn’t be – perhaps this is explained in the documentation for <code>nix build</code> or <code>nix profile install</code> or the other places that actually take this. Let’s see.</p>
<p><code>nix build --help</code> says:</p>
<blockquote>
<pre tabindex=0><code>Synopsis

    nix build [option...] installables...
</code></pre></blockquote>
<p>So <code>nixpkgs#git</code> is an “installable.” This seems to be a new Nix term; it’s used throughout the help text. It doesn’t explain how installables work or what they are. It does say:</p>
<pre tabindex=0><code>Options that change the interpretation of installables:

  · --derivation
    Operate on the store derivation rather than its outputs.

  · --expr expr
    Interpret installables as attribute paths relative to the Nix expression expr.

  · --file / -f file
    Interpret installables as attribute paths relative to the Nix expression stored
    in file.
</code></pre><p>So that’s interesting, but I really want to know how installables are treated by default.</p>
<pre tabindex=0><code>$ rg installable ~/src/nix/doc
/Users/ian/src/nix/doc/manual/src/package-management/basic-package-mgmt.md
61:to show the “available” (i.e., installable) packages, as opposed to the

/Users/ian/src/nix/doc/manual/src/quick-start.md
18:1. See what installable packages are currently available in the
</code></pre><p>Hmm. Interesting. But that doesn’t include any <code>--help</code> text output… and maybe it is explained there, somewhere?</p>
<p>Where does the <code>--help</code> output live?</p>
<pre tabindex=0><code>$ rg 'Interpret installables'
src/libcmd/installables.cc
136:        .description = "Interpret installables as attribute paths relative to the Nix expression stored in *file*.",
145:        .description = "Interpret installables as attribute paths relative to the Nix expression *expr*.",
</code></pre><p>Ah. I see. Well, that’s probably going to be my best bet…</p>
<p>There’s nothing in <code>installables.hh</code> that explains what these are – I have had some success reading header files in the past, but not this time.</p>
<p>But reading the source reveals <code>parseInstallables</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>Strings</span> <span class=n>SourceExprCommand</span><span class=o>::</span><span class=n>getDefaultFlakeAttrPathPrefixes</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=p>{</span>
        <span class=c1>// As a convenience, look for the attribute in
</span><span class=c1></span>        <span class=c1>// 'outputs.packages'.
</span><span class=c1></span>        <span class=s>"packages."</span> <span class=o>+</span> <span class=n>settings</span><span class=p>.</span><span class=n>thisSystem</span><span class=p>.</span><span class=n>get</span><span class=p>()</span> <span class=o>+</span> <span class=s>"."</span><span class=p>,</span>
        <span class=c1>// As a temporary hack until Nixpkgs is properly converted
</span><span class=c1></span>        <span class=c1>// to provide a clean 'packages' set, look in 'legacyPackages'.
</span><span class=c1></span>        <span class=s>"legacyPackages."</span> <span class=o>+</span> <span class=n>settings</span><span class=p>.</span><span class=n>thisSystem</span><span class=p>.</span><span class=n>get</span><span class=p>()</span> <span class=o>+</span> <span class=s>"."</span>
    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>Aha. Okay. I’m not sure what the difference is between <code>packages</code> and <code>legacyPackages</code>. Ah, but grepping for <code>legacyPackages</code> shows me the documentation I was looking for before: this is all explained in <code>nix --help</code>.</p>
<blockquote>
<p><strong>Installables</strong></p>
<p>Many <code>nix</code> subcommands operate on one or more <em>installables</em>. These are
command line arguments that represent something that can be built in
the Nix store. Here are the recognised types of installables:</p>
<ul>
<li>
<p><strong>Flake output attributes</strong>: <code>nixpkgs#hello</code></p>
<p>These have the form <em>flakeref</em>[<code>#</code><em>attrpath</em>], where <em>flakeref</em> is a
flake reference and <em>attrpath</em> is an optional attribute path. For
more information on flakes, see [the <code>nix flake</code> manual
page](./nix3-flake.md). Flake references are most commonly a flake
identifier in the flake registry (e.g. <code>nixpkgs</code>) or a path
(e.g. <code>/path/to/my-flake</code> or <code>.</code>).</p>
<p>If <em>attrpath</em> is omitted, Nix tries some default values; for most
subcommands, the default is <code>defaultPackage.</code><em>system</em>
(e.g. <code>defaultPackage.x86_64-linux</code>), but some subcommands have
other defaults. If <em>attrpath</em> <em>is</em> specified, <em>attrpath</em> is
interpreted as relative to one or more prefixes; for most
subcommands, these are <code>packages.</code><em>system</em>,
<code>legacyPackages.*system*</code> and the empty prefix. Thus, on
<code>x86_64-linux</code> <code>nix build nixpkgs#hello</code> will try to build the
attributes <code>packages.x86_64-linux.hello</code>,
<code>legacyPackages.x86_64-linux.hello</code> and <code>hello</code>.</p>
</li>
</ul>
</blockquote>
<p>Wow, this is a really nice overview! I escaped some markdown for clarity – note that the <code>--help</code> text also reproduces that filename that it’s supposed to link to. Which is a little goofy but whatever. That <code>legacyPackages.*system*</code> bit makes more sense in the raw markdown:</p>
<pre><code>`packages.`*system*, `legacyPackages.*system*`
</code></pre>
<p>Anyway. Interesting that <code>nixpkgs#git</code> will try to find <code>packages.x86_64-darwin.git</code> <em>before</em> it tries to find <code>git</code>. That seems… wrong to me. I have no idea how you’d specify that you meant <code>git</code> in the case that you had both of these outputs.</p>
<p>Other installables:</p>
<ul>
<li><em>store paths</em></li>
<li><em>store derivations</em> (with a definition and explanation of this term!)</li>
<li><em>Nix attributes</em>, which is to say, “attributes in regular non-flake Nix files.”</li>
<li><em>Nix expressions</em>, which look like, well, expressions.</li>
</ul>
<p>Okay neat. Let’s play with these for a minute.</p>
<p>I wonder if the “attribute” expression will automatically call functions the way that the old UI used to do. That is, can I write:</p>
<pre tabindex=0><code>$ nix build git --file ~/.nix-defexpr/channels/nixpkgs/default.nix

$ readlink result
/nix/store/f12mf054h7r0i4vjvvcjh0ymjvcbwpa6-git-2.33.1
</code></pre><p>I can indeed! Okay. I wonder if it does the same automatic directories-become-attribute-sets translation that <code>nix-env --file</code> does:</p>
<pre tabindex=0><code>$ nix build nixpkgs.git --file ~/.nix-defexpr/channels
error: opening file '/nix/store/26vpc8czyr4gak7b1dvqpra159y1x9vd-user-environment/default.nix': No such file or directory
</code></pre><p>Nope. Okay, well that’s fine. This is already a step in the right direction: a way to use all of the new-style commands with expressions from my channel.</p>
<p><em>Except</em> for <code>nix search</code>, of course…</p>
<p>Let’s look at the literal expression style. There was an example and a caveat in the <code>--help</code> text:</p>
<blockquote>
<ul>
<li><strong>Nix expressions</strong>:</li>
</ul>
<pre tabindex=0><code>--expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
</code></pre><p>When the <code>--expr</code> option is given, all installables are interpreted as Nix expressions. You may need to specify <code>--impure</code> if the expression references impure inputs (such as <code>&lt;nixpkgs&gt;</code>).</p>
</blockquote>
<p>And indeed:</p>
<pre tabindex=0><code>$ nix build --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
error: cannot look up '&lt;nixpkgs&gt;' in pure evaluation mode (use '--impure' to override)

       at «string»:1:9:

            1| (import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })
             |         ^
</code></pre><p>I am really loving those new error messages.</p>
<p>Wow, there’s like… fancy animated build progress now?</p>
<pre tabindex=0><code>$ nix build --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })' --impure
[1/0/1 built, 1 copied (0.7/0.7 MiB), 0.7 MiB DL] building my-hello (configurePhase): checking whether strcasestr is d
</code></pre><p>It’s chopped off at one line and I had to expand my shell to see… part of what it’s doing. Interesting. How did it know what phase of the build it was in? Is this something that changed in <code>stdenv</code> to… prefix all output like that? Or is Nix like… parsing the output to figure that out?</p>
<p>Huh. Let’s compare what this looks like in Nix Classic.</p>
<pre tabindex=0><code>$ nix-build --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
/nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
</code></pre><p>Oh, right, duh.</p>
<pre tabindex=0><code>$ rm result

$ nix-collect-garbage
</code></pre><p>I had a <em>lot</em> of garbage to collect from when I accidentally evaluated <code>nixpkgs.outputs.legacyPackages.x84_64-darwin</code> – remember that evaluating derivations at the REPL (or anywhere?) has the side effect of putting <code>.drv</code> files in your store, which is <em>very surprising</em> to me. But something that <a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>I have been surprised by previously</a>, and thus am not surprised by anymore.</p>
<p>So I got to see a lot of fun stuff like this:</p>
<pre tabindex=0><code>deleting '/nix/store/yvh50wy12sf2l6g3w1sfww72h7wdxxmf-libutil-47.30.1.tar.gz.drv'
deleting '/nix/store/bnjllha45nkw7qg1l6jix128aqr4g2pp-embedfile.r54865.tar.xz.drv'
deleting '/nix/store/gd1c2l66lamhr89f673jzbsq1j8mrvzy-expand-brackets-2.1.4.tgz.drv'
deleting '/nix/store/1iv4czqa4yic4sbl2lf7z1yygrlwpp5a-diffutils-3.8'
deleting '/nix/store/s79j4k2d7n1dzpsil5wl6c09phydhsx9-azure-mgmt-rdbms-10.0.0.zip.drv'
deleting '/nix/store/whj853b0h33bwp9bfqvf5ifzzph6w4k3-ballerburg-1.2.0.tar.gz.drv'
deleting '/nix/store/a50jhaz3zkx9a1iv87kfa0bzj9dn5yhl-newspaper.r15878.tar.xz.drv'
deleting '/nix/store/9acf6z50qqingjpn8i6bw9r5d85nxzhg-fix-qemu-ga.patch'
deleting '/nix/store/7mrgg6wk9fbq809jrccpmdasb5hmvb8f-vancouver.r55423.tar.xz.drv'
</code></pre><p>Anyway, let’s try that again:</p>
<pre tabindex=0><code>$ nix-build --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
/nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
</code></pre><p>Huh! Still nothin'. That’s weird. Why is that alive?</p>
<pre tabindex=0><code>$ nix-store --query --referrers /nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
</code></pre><p>Right, but that’s not really the question I want to ask. Hmm. <code>man nix-store</code> teaches me <code>--roots</code>:</p>
<pre tabindex=0><code>$ nix-store --query --roots /nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
/Users/ian/src/nix/result -&gt; /nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
</code></pre><p>Aha! I can see that it’s because I’m an idiot: when I switched from Nix 2.4 to Nix 2.3, I was in a different directory. Ha. Maybe I shouldn’t set <code>PS1="$ "</code> while I’m writing these blog posts…</p>
<p>One more try:</p>
<pre tabindex=0><code>$ nix-build --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
these derivations will be built:
  /nix/store/w1w2gixcykpjyw08g5n8ql51iv1ldkhx-my-hello.drv
these paths will be fetched (128.35 MiB download, 638.54 MiB unpacked):
  /nix/store/0z8am7gyngj9104lsgcpigk165nqzdsj-patch-2.7.6
  /nix/store/3x7dwzq014bblazs7kq20p9hyzz0qh8g-hello-2.10.tar.gz
  /nix/store/5cd9pbkyvj941w15cm7bidf8nkpxygmd-findutils-4.8.0
  /nix/store/66crk4qirnyz08zw91nhlz4x8lrxprc0-clang-7.1.0-lib
  /nix/store/a2v97g7g9dq9vy8v3094lsdgjmwn35yd-adv_cmds-119-locale
  /nix/store/aiv11nnqmcyvbq33vx2aiaf4a2n6wkds-ed-1.17
  /nix/store/aqwnkakcgz0h8bn1g7pya9x0mknfpnfx-gnumake-4.3
  /nix/store/bx4prwlqjf856w4swv6vdz7v9avhwixy-cctools-binutils-darwin-949.0.1
  /nix/store/dhhbwn09yhr7jqvwkvi0v4m62xzsvdi9-stdenv-darwin
  /nix/store/gsfxxazc51sx6vjdrz6cq8s19x7h5mwh-clang-wrapper-7.1.0
  /nix/store/hxylb8a54skddgam8ip6lg6f8ahmdpw7-cctools-binutils-darwin-wrapper-949.0.1
  /nix/store/jjqvaxg6xsz31ln57ri4ssasxxm4rj9i-expand-response-params
  /nix/store/jxh690i6zwbx53s04493diwkcmz36fzv-libtapi-1100.0.11
  /nix/store/kd3qrxfgws2kwyhkamm52dsjfrdbrlw1-binutils-2.35.2
  /nix/store/lxd1nlzcdfih205yyjnizqgwdpydfc66-llvm-7.1.0
  /nix/store/r0i9j5m3xnqlwmri7g0kiqnxy21vpq5i-gawk-5.1.1
  /nix/store/s9r2s5qcrpzdx2maijhwl5vf33rfiqzw-cctools-port-949.0.1
  /nix/store/w4a9ljyrkai9y9bv3gwm21hr6s6n4g0l-llvm-7.1.0-lib
  /nix/store/z3p39y1nj2w6db8myfp1bcg8vq6yic78-diffutils-3.8
  /nix/store/zfh3npfhfjjgwi0dqpriklip5k15ppmj-clang-7.1.0
copying path '/nix/store/3x7dwzq014bblazs7kq20p9hyzz0qh8g-hello-2.10.tar.gz' from 'https://cache.nixos.org'...
copying path '/nix/store/a2v97g7g9dq9vy8v3094lsdgjmwn35yd-adv_cmds-119-locale' from 'https://cache.nixos.org'...
copying path '/nix/store/kd3qrxfgws2kwyhkamm52dsjfrdbrlw1-binutils-2.35.2' from 'https://cache.nixos.org'...
copying path '/nix/store/z3p39y1nj2w6db8myfp1bcg8vq6yic78-diffutils-3.8' from 'https://cache.nixos.org'...
copying path '/nix/store/aiv11nnqmcyvbq33vx2aiaf4a2n6wkds-ed-1.17' from 'https://cache.nixos.org'...
copying path '/nix/store/jjqvaxg6xsz31ln57ri4ssasxxm4rj9i-expand-response-params' from 'https://cache.nixos.org'...
copying path '/nix/store/5cd9pbkyvj941w15cm7bidf8nkpxygmd-findutils-4.8.0' from 'https://cache.nixos.org'...
copying path '/nix/store/r0i9j5m3xnqlwmri7g0kiqnxy21vpq5i-gawk-5.1.1' from 'https://cache.nixos.org'...
copying path '/nix/store/aqwnkakcgz0h8bn1g7pya9x0mknfpnfx-gnumake-4.3' from 'https://cache.nixos.org'...
copying path '/nix/store/jxh690i6zwbx53s04493diwkcmz36fzv-libtapi-1100.0.11' from 'https://cache.nixos.org'...
copying path '/nix/store/w4a9ljyrkai9y9bv3gwm21hr6s6n4g0l-llvm-7.1.0-lib' from 'https://cache.nixos.org'...
copying path '/nix/store/s9r2s5qcrpzdx2maijhwl5vf33rfiqzw-cctools-port-949.0.1' from 'https://cache.nixos.org'...
copying path '/nix/store/zfh3npfhfjjgwi0dqpriklip5k15ppmj-clang-7.1.0' from 'https://cache.nixos.org'...
copying path '/nix/store/66crk4qirnyz08zw91nhlz4x8lrxprc0-clang-7.1.0-lib' from 'https://cache.nixos.org'...
copying path '/nix/store/lxd1nlzcdfih205yyjnizqgwdpydfc66-llvm-7.1.0' from 'https://cache.nixos.org'...
copying path '/nix/store/0z8am7gyngj9104lsgcpigk165nqzdsj-patch-2.7.6' from 'https://cache.nixos.org'...
copying path '/nix/store/bx4prwlqjf856w4swv6vdz7v9avhwixy-cctools-binutils-darwin-949.0.1' from 'https://cache.nixos.org'...
copying path '/nix/store/hxylb8a54skddgam8ip6lg6f8ahmdpw7-cctools-binutils-darwin-wrapper-949.0.1' from 'https://cache.nixos.org'...
copying path '/nix/store/gsfxxazc51sx6vjdrz6cq8s19x7h5mwh-clang-wrapper-7.1.0' from 'https://cache.nixos.org'...
copying path '/nix/store/dhhbwn09yhr7jqvwkvi0v4m62xzsvdi9-stdenv-darwin' from 'https://cache.nixos.org'...
warning: unknown setting 'experimental-features'
warning: unknown setting 'flake-registry'
building '/nix/store/w1w2gixcykpjyw08g5n8ql51iv1ldkhx-my-hello.drv'...
unpacking sources
unpacking source archive /nix/store/3x7dwzq014bblazs7kq20p9hyzz0qh8g-hello-2.10.tar.gz
source root is hello-2.10
setting SOURCE_DATE_EPOCH to timestamp 1416139241 of file hello-2.10/ChangeLog
patching sources
configuring
configure flags: --disable-dependency-tracking --prefix=/nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
checking for a BSD-compatible install... /nix/store/jyv20ip5h954zsygg1xhg4n0jfcy82ck-coreutils-9.0/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /nix/store/jyv20ip5h954zsygg1xhg4n0jfcy82ck-coreutils-9.0/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking for gcc... clang
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables...
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether clang accepts -g... yes
checking for clang option to accept ISO C89... none needed
checking whether clang understands -c and -o together... yes
checking for style of include used by make... GNU
checking dependency style of clang... none
checking how to run the C preprocessor... clang -E
checking for grep that handles long lines and -e... /nix/store/wnq3vcvg8sfxc938f70q6s6n5j9ran1x-gnugrep-3.7/bin/grep
checking for egrep... /nix/store/wnq3vcvg8sfxc938f70q6s6n5j9ran1x-gnugrep-3.7/bin/grep -E
checking for Minix Amsterdam compiler... no
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
...
</code></pre><p>I much prefer the explicitness of this output, but there might be a way to configure it.</p>
<p>I guess it’s possible that <code>stdenv</code> is like… detecting that I’m in Nix 2.4, and doing something different?</p>
<p>Or Nix 2.4 is parsing this output… but that seems crazy.</p>
<p>Hmm.</p>
<p>I can’t find anything in the <code>--help</code> text about “progress” or “output” or anything. Let’s try <code>--verbose</code>:</p>
<pre tabindex=0><code>$ nix build --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })' --impure --verbose
copying path '/nix/store/3x7dwzq014bblazs7kq20p9hyzz0qh8g-hello-2.10.tar.gz' from 'https://cache.nixos.org'...
copying path '/nix/store/a2v97g7g9dq9vy8v3094lsdgjmwn35yd-adv_cmds-119-locale' from 'https://cache.nixos.org'...
copying path '/nix/store/kd3qrxfgws2kwyhkamm52dsjfrdbrlw1-binutils-2.35.2' from 'https://cache.nixos.org'...
copying path '/nix/store/z3p39y1nj2w6db8myfp1bcg8vq6yic78-diffutils-3.8' from 'https://cache.nixos.org'...
copying path '/nix/store/aiv11nnqmcyvbq33vx2aiaf4a2n6wkds-ed-1.17' from 'https://cache.nixos.org'...
copying path '/nix/store/jjqvaxg6xsz31ln57ri4ssasxxm4rj9i-expand-response-params' from 'https://cache.nixos.org'...
copying path '/nix/store/5cd9pbkyvj941w15cm7bidf8nkpxygmd-findutils-4.8.0' from 'https://cache.nixos.org'...
copying path '/nix/store/r0i9j5m3xnqlwmri7g0kiqnxy21vpq5i-gawk-5.1.1' from 'https://cache.nixos.org'...
copying path '/nix/store/aqwnkakcgz0h8bn1g7pya9x0mknfpnfx-gnumake-4.3' from 'https://cache.nixos.org'...
copying path '/nix/store/jxh690i6zwbx53s04493diwkcmz36fzv-libtapi-1100.0.11' from 'https://cache.nixos.org'...
copying path '/nix/store/w4a9ljyrkai9y9bv3gwm21hr6s6n4g0l-llvm-7.1.0-lib' from 'https://cache.nixos.org'...
copying path '/nix/store/s9r2s5qcrpzdx2maijhwl5vf33rfiqzw-cctools-port-949.0.1' from 'https://cache.nixos.org'...
copying path '/nix/store/zfh3npfhfjjgwi0dqpriklip5k15ppmj-clang-7.1.0' from 'https://cache.nixos.org'...
[0/2 built, 1/12/20 copied (330.8/638.5 MiB), 68.8/128.3 MiB DL] fetching clang-7.1.0 from https://cache.nixos.org
</code></pre><p>That’s <em>better</em>. But it’s still hiding the build output from me. Hmm.</p>
<p>I search through the Nix codebase, and find that the progress bar display is a type of “logger.” Okay.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>Logger</span> <span class=o>*</span> <span class=nf>makeDefaultLogger</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>defaultLogFormat</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=n>LogFormat</span><span class=o>::</span><span class=nl>raw</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>makeSimpleLogger</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>LogFormat</span><span class=o>::</span><span class=nl>rawWithLogs</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>makeSimpleLogger</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>LogFormat</span><span class=o>::</span><span class=nl>internalJSON</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>makeJSONLogger</span><span class=p>(</span><span class=o>*</span><span class=n>makeSimpleLogger</span><span class=p>(</span><span class=nb>true</span><span class=p>));</span>
    <span class=k>case</span> <span class=n>LogFormat</span><span class=o>::</span><span class=nl>bar</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>makeProgressBar</span><span class=p>();</span>
    <span class=k>case</span> <span class=n>LogFormat</span><span class=o>::</span><span class=nl>barWithLogs</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>makeProgressBar</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>
    <span class=k>default</span><span class=o>:</span>
        <span class=n>abort</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Okay! Now we’re talking. <code>nix --help</code> has this to say about “logging:”</p>
<pre tabindex=0><code>Logging-related options:

  · --debug
    Set the logging verbosity level to 'debug'.

  · --log-format format
    Set the format of log output; one of raw, internal-json, bar or bar-with-logs.

  · --print-build-logs / -L
    Print full build logs on standard error.

  · --quiet
    Decrease the logging verbosity level.

  · --verbose / -v
    Increase the logging verbosity level.
</code></pre><p>It would not have occurred to me that “logging” meant “the thing Nix prints to stderr when run interactively.” I assumed that this meant, you know, the log files that Nix creates in the temporary build directories that I’ve seen before, or the contents of <code>/nix/var/log</code>. But clearly the term is overloaded.</p>
<p>Also amusing: I <em>did</em> think to look here. But I searched for the string “progress,” when it is only called “bar.”</p>
<p>Let’s try some other formats.</p>
<pre tabindex=0><code>$ nix build --log-format raw --impure --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
</code></pre><p>Huuuuh. It didn’t print anything! It just swallowed all output. Okay. Unexpected. Is that because I didn’t also say <code>--print-build-logs</code>? I don’t… what?</p>
<pre tabindex=0><code>$ nix build --log-format raw --print-build-logs --impure --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
[0/2 built, 1/10/20 copied (124.6/638.5 MiB), 25.1/128.3 MiB DL] fetching llvm-7.1.0-lib from https://cache.nixos.org
</code></pre><p>Okay, this has brought the progress bar back. I guess that <code>--print-build-logs</code>… ignores the <code>--log-format</code>? Or… what?</p>
<p>It did eventually start printing stuff, though:</p>
<pre tabindex=0><code>$ nix build --log-format raw --print-build-logs --impure --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
[0/2 built, 1/13/20 copied (575.0/638.5 MiB), 119.0/128.3 MiB DL] fetching clang-7.1.0-lib from https://cache.nixos.or
my-hello&gt; unpacking sources
my-hello&gt; unpacking source archive /nix/store/3x7dwzq014bblazs7kq20p9hyzz0qh8g-hello-2.10.tar.gz
my-hello&gt; source root is hello-2.10
my-hello&gt; setting SOURCE_DATE_EPOCH to timestamp 1416139241 of file hello-2.10/ChangeLog
my-hello&gt; patching sources
my-hello&gt; configuring
my-hello&gt; configure flags: --disable-dependency-tracking --prefix=/nix/store/80vpk09z38yh30b5q4rgjr86c3gj7412-my-hello
my-hello&gt; checking for a BSD-compatible install... /nix/store/jyv20ip5h954zsygg1xhg4n0jfcy82ck-coreutils-9.0/bin/install -c
my-hello&gt; checking whether build environment is sane... yes
my-hello&gt; checking for a thread-safe mkdir -p... /nix/store/jyv20ip5h954zsygg1xhg4n0jfcy82ck-coreutils-9.0/bin/mkdir -p
my-hello&gt; checking for gawk... gawk
my-hello&gt; checking whether make sets $(MAKE)... yes
my-hello&gt; checking whether make supports nested variables... yes
my-hello&gt; checking for gcc... clang
my-hello&gt; checking whether the C compiler works... yes
my-hello&gt; checking for C compiler default output file name... a.out
my-hello&gt; checking for suffix of executables...
my-hello&gt; checking whether we are cross compiling... no
my-hello&gt; checking for suffix of object files... o
</code></pre><p>I actually <em>really like</em> this output. The <code>my-hello&gt;</code> bit renders with dim text to show me that it’s not really part of the output. I don’t know what’s <code>raw</code> about this output. It looks pretty well-done.</p>
<p>Let’s try some more.</p>
<pre tabindex=0><code>$ nix build --log-format internal-json --impure --expr '(import &lt;nixpkgs&gt; {}).hello.overrideDerivation (prev: { name = "my-hello"; })'
@nix {"action":"start","id":69711614181376,"level":0,"text":"","type":102}
@nix {"action":"start","id":69711614181377,"level":0,"text":"","type":104}
@nix {"action":"start","id":69711614181378,"level":0,"text":"","type":103}
@nix {"action":"result","fields":[0,1,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,0,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,0],"id":69711614181376,"type":106}
@nix {"action":"start","id":69711614181379,"level":6,"text":"querying info about missing paths","type":0}
@nix {"action":"stop","id":69711614181379}
@nix {"action":"result","fields":[0,2,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,0,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[0,3,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,0,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[0,4,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,0,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[0,3,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,0,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,0],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[0,3,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,2,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,726160],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,726064],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[0,3,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,2,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,738140],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,769040],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[0,3,0,0],"id":69711614181377,"type":105}
@nix {"action":"result","fields":[0,29,0,0],"id":69711614181378,"type":105}
@nix {"action":"result","fields":[101,775108],"id":69711614181376,"type":106}
@nix {"action":"result","fields":[100,1780264],"id":69711614181376,"type":106}
...
@nix {"action":"result","fields":[4587520,164382360,0,0],"id":69711614181411,"type":105}
^C@nix {"action":"result","fields":[4595712,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"result","fields":[4603904,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"result","fields":[4612096,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"result","fields":[4620288,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"result","fields":[4628480,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"result","fields":[4636672,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"result","fields":[4644864,164382360,0,0],"id":69711614181411,"type":105}
@nix {"action":"stop","id":69711614181411}
@nix {"action":"stop","id":69711614181410}
@nix {"action":"stop","id":69711614181378}
@nix {"action":"stop","id":69711614181377}
@nix {"action":"stop","id":69711614181376}
@nix {"action":"result","fields":[3685826,30041472,0,0],"id":69711614181412,"type":105}
@nix {"action":"stop","id":69711614181412}
@nix {"action":"msg","column":null,"file":null,"level":0,"line":null,"msg":"\u001b[31;1merror:\u001b[0m interrupted by the user","raw_msg":"interrupted by the user"}
</code></pre><p>Wow. Wild. I did, in fact, eventually interrupt it, because it was completely blowing away my scrollback. <code>internal-json</code> indeed.</p>
<p><code>--log-format bar</code> seems to be the default – the compact one line thing that you can’t read unless your terminal is at least 120 characters wide.</p>
<p>And <code>--log-format bar-with-logs</code> seems to be the same as <code>--log-format raw --print-build-logs</code>.</p>
<p>Okay, yeah, <code>--print-build-logs</code> seems to be an alias for <code>--log-format bar-with-logs</code>. <code>--log-format internal-json --print-build-logs</code> also gives me the same (nice) output. I get why they have a short flag for this output type, but it’s surprising to me that it isn’t documented that way.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=n>addFlag</span><span class=p>({</span>
    <span class=p>.</span><span class=n>longName</span> <span class=o>=</span> <span class=s>"print-build-logs"</span><span class=p>,</span>
    <span class=p>.</span><span class=n>shortName</span> <span class=o>=</span> <span class=sc>'L'</span><span class=p>,</span>
    <span class=p>.</span><span class=n>description</span> <span class=o>=</span> <span class=s>"Print full build logs on standard error."</span><span class=p>,</span>
    <span class=p>.</span><span class=n>category</span> <span class=o>=</span> <span class=n>loggingCategory</span><span class=p>,</span>
    <span class=p>.</span><span class=n>handler</span> <span class=o>=</span> <span class=p>{[</span><span class=o>&amp;</span><span class=p>]()</span> <span class=p>{</span><span class=n>setLogFormat</span><span class=p>(</span><span class=n>LogFormat</span><span class=o>::</span><span class=n>barWithLogs</span><span class=p>);</span> <span class=p>}},</span>
<span class=p>});</span>
</code></pre></div><p>How do I change that to be my default output format? <code>man 5 nix.conf</code> has no answers. I search through the code, and conclude that there is currently no way to do this. But I could be wrong, or that could change in the future, so I’m still adding that as an open question to come back to later.</p>
<p><em>Okay</em>.</p>
<p>Where were were? What are we doing here?</p>
<p>Oh, I was wondering how it knew that it was in the <code>configurePhase</code>.</p>
<p>Okay, so I looked through the source, and found that this <em>is</em> something the <code>stdenv</code> builder is doing:</p>
<pre tabindex=0><code>if [[ -n $NIX_LOG_FD ]]; then
    echo "@nix { \"action\": \"setPhase\", \"phase\": \"$curPhase\" }" &gt;&amp;$NIX_LOG_FD
fi
</code></pre><p>It’s that same “internal JSON” syntax, but here the builder is printing those log lines to a file descriptor. This is very interesting! My perception of the environment with which derivations are run is changing. I thought all of the environment variables were documented in the <code>.drv</code> file. But here is a magic, extra one?</p>
<p>Apparently this is nothing new; this has been the case since Nix 2.0 (according to the release notes). I’ve just never used the <code>nix build</code> command before.</p>
<p>So, alright. Cool. <em>Installables</em>.</p>
<p>That whole thing was sort of a tangent. Let’s get back on track: I was originally trying to use <code>builtins.getFlake</code> in order to make a “channel” that reflected a “flake.”</p>
<p>Let’s try this:</p>
<pre><code>$ cat ~/.nix-defexpr/flakgs/default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>getFlake</span> <span class=s2>"nixpkgs"</span><span class=p>)</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>legacyPackages</span><span class=o>.</span><span class=si>${</span><span class=nb>builtins</span><span class=o>.</span><span class=n>currentSystem</span><span class=si>}</span>
</code></pre></div><p>Will that work? It seems like it does, from a repl:</p>
<pre tabindex=0><code>nix-repl&gt; flakgs = import ./.

nix-repl&gt; flakgs.git
[26.8 MiB DL]«derivation /nix/store/1s02f3hsyvcx7kpyzj15ja3kklwj86b6-git-2.34.0.drv»
«derivation /nix/store/1s02f3hsyvcx7kpyzj15ja3kklwj86b6-git-2.34.0.drv»
</code></pre><p>Again, weird botched animated progress bar output.</p>
<p>So that (effectively) gives me a <code>flakgs</code> entry on my <code>NIX_PATH</code>. But what I really need this for is <code>nix-shell -p</code> – and <code>nix-shell -p</code> is hardcoded to look up <code>nixpkgs</code> on my <code>NIX_PATH</code>. But that <em>shouldn’t</em> be a problem…</p>
<pre tabindex=0><code>$ NIX_PATH="nixpkgs=$HOME/.nix-defexpr/flakgs" nix-shell -p git
error: attempt to call something which is not a function but a set

       at «string»:1:18:

            1| {...}@args: with import &lt;nixpkgs&gt; args; (pkgs.runCommandCC or pkgs.runCommand) "shell" { buildInputs = [ (git) ]; } ""
             |                  ^
</code></pre><p>Ah, I see. <code>nix-shell -p</code> doesn’t “auto-call” the Nixpkgs result function, it <em>always</em> calls it. So instead:</p>
<pre><code>$ cat ~/.nix-defexpr/flakgs/default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=o>...</span> <span class=p>}:</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>getFlake</span> <span class=s2>"nixpkgs"</span><span class=p>)</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>legacyPackages</span><span class=o>.</span><span class=si>${</span><span class=nb>builtins</span><span class=o>.</span><span class=n>currentSystem</span><span class=si>}</span>
</code></pre></div><p>Okay, great. I’m just ignoring all arguments, which I might regret I guess. I could at least take <code>system</code> instead of hardcoding it. But whatever; this’ll get me there for now.</p>
<p>Does it work?</p>
<pre tabindex=0><code>$ NIX_PATH="nixpkgs=$HOME/.nix-defexpr/flakgs" nix-shell -p git --command 'git --version'
git version 2.34.0

$ nix-shell -p git --command 'git --version'
git version 2.33.1
</code></pre><p>Alright! Great. It certainly seems like it’s doing something.</p>
<p>So I think that this will be <em>completely workable</em> for me. And my “channel” also works with commands that expect <code>~/.nix-defexpr</code>:</p>
<pre tabindex=0><code>$ nix-env -qaA nixpkgs.git
git-2.33.1

$ nix-env -qaA flakgs.git
git-2.34.0
</code></pre><p>So, armed with this workaround, I think I can try switching back to Nix 2.4, and officially replace my <code>nixpkgs</code> channel with this flake-based alternative. That <em>should</em> allow me to do everything I was doing before – apart from <code>nix-channel --update</code> – even with the newer version.</p>
<p>And then I can take the time to explore flakes at my leisure.</p>
<hr>
<ul>
<li>Does derivation evaluation <em>always</em> create a <code>.drv</code> file, or is this something that the REPL adds?</li>
<li>How can I specify that I really mean <code>outputs.foo</code> if a flake also has <code>outputs.x86_64-darwin.foo</code>?</li>
<li>What is <code>--log-format raw</code>?</li>
<li>How can I change the default “log format” to <code>bar-with-logs</code>?</li>
<li>Can I make builds <code>--verbose</code> by default?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Chipping%20away%20at%20flakes%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://twitter.com/ianthehenry/status/1472444012246159361>comment via twitter</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>Next up ➜ New and unimproved shells</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></strong>&nbsp;←&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
